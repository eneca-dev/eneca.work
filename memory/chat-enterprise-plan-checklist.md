### Чеклист перехода на enterprise-архитектуру чата

- [x] Блок 1. База данных и модель
  - [x] Создать таблицу `chat_conversations`
  - [x] Создать таблицу `chat_messages`
  - [x] Добавить индексы: `conversation_id`, `(conversation_id, created_at)`, `(conversation_id, step_index)`, `run_id`
  - [x] Настроить RLS: доступ только владельцу беседы
  - [x] Проверка: вставка тестовых строк и Realtime-подписка (debug UI)

- [ ] Блок 2. Мини-гейт для мыслей бота
  - [x] Эндпоинт POST `/api/chat/thinking` (Node runtime)
  - [x] Валидация секрета `X-N8N-Secret`, схема тела
  - [x] Запись в `chat_messages`, возврат `{ ok: true }`
  - [ ] Проверка: curl → запись → Realtime событие в UI

- [ ] Блок 3. Изменения в n8n (трансляция мыслей)
  - [ ] Добавить HTTP Request узлы для шагов агента
  - [ ] Поля: `conversationId`, `userId`, `runId`, `stepIndex`, `kind`, `content`, `isFinal?`, `meta?`
  - [ ] Идемпотентность по ключу `runId:stepIndex`
  - [ ] Проверка: виден поток мыслей в UI

- [ ] Блок 4. UI-подписка и рендер мыслей
  - [x] Debug: подписка на `chat_messages` по `conversation_id` + тестовые вставки
  - [ ] Прод: рендер `thinking|tool|observation` в реальном времени в чате
  - [ ] Оптимизация DOM-обновлений и лимит списка
  - [ ] Проверка: живой поток в UI

- [ ] Блок 5. Гейт `/api/chat` (без переключения фронта)
  - [ ] Эндпоинт POST `/api/chat` с валидацией JWT, rate limit, idempotency
  - [ ] Проксирование в n8n, запись `user/message` в БД
  - [ ] Фиче-флаг переключения
  - [ ] Проверка: совпадение ответов через гейт и напрямую

- [ ] Блок 6. Переключение фронта на `/api/chat`
  - [ ] Канареечное включение
  - [ ] Мониторинг p95/ошибок
  - [ ] Полное включение

- [ ] Блок 7. Наблюдаемость и аудит
  - [ ] Sentry спаны/ошибки, корреляция `run_id`/`conversation_id`
  - [ ] Техметрики доставки и ошибок
  - [ ] Проверка: сквозной трейс инцидента

- [ ] Блок 8. Хранение, TTL и аналитика
  - [ ] TTL для мыслей, длительное хранение финальных сообщений
  - [ ] Материализованные представления
  - [ ] Проверка удаления и корректной работы UI

- [ ] Блок 9. Безопасность и права
  - [ ] RLS-политики, сервисная запись от n8n
  - [ ] Rate limiting, валидация схем, лимиты размеров
  - [ ] Негативные тесты

- [ ] Блок 10. Абстракция провайдера (опционально)
  - [ ] Развязка от n8n, версионирование контрактов
  - [ ] Проверка переключения под нагрузкой


