| schema     | name                                           | sql_definition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ---------- | ---------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| extensions | pg_stat_statements                             |  SELECT pg_stat_statements.userid,
    pg_stat_statements.dbid,
    pg_stat_statements.toplevel,
    pg_stat_statements.queryid,
    pg_stat_statements.query,
    pg_stat_statements.plans,
    pg_stat_statements.total_plan_time,
    pg_stat_statements.min_plan_time,
    pg_stat_statements.max_plan_time,
    pg_stat_statements.mean_plan_time,
    pg_stat_statements.stddev_plan_time,
    pg_stat_statements.calls,
    pg_stat_statements.total_exec_time,
    pg_stat_statements.min_exec_time,
    pg_stat_statements.max_exec_time,
    pg_stat_statements.mean_exec_time,
    pg_stat_statements.stddev_exec_time,
    pg_stat_statements.rows,
    pg_stat_statements.shared_blks_hit,
    pg_stat_statements.shared_blks_read,
    pg_stat_statements.shared_blks_dirtied,
    pg_stat_statements.shared_blks_written,
    pg_stat_statements.local_blks_hit,
    pg_stat_statements.local_blks_read,
    pg_stat_statements.local_blks_dirtied,
    pg_stat_statements.local_blks_written,
    pg_stat_statements.temp_blks_read,
    pg_stat_statements.temp_blks_written,
    pg_stat_statements.blk_read_time,
    pg_stat_statements.blk_write_time,
    pg_stat_statements.temp_blk_read_time,
    pg_stat_statements.temp_blk_write_time,
    pg_stat_statements.wal_records,
    pg_stat_statements.wal_fpi,
    pg_stat_statements.wal_bytes,
    pg_stat_statements.jit_functions,
    pg_stat_statements.jit_generation_time,
    pg_stat_statements.jit_inlining_count,
    pg_stat_statements.jit_inlining_time,
    pg_stat_statements.jit_optimization_count,
    pg_stat_statements.jit_optimization_time,
    pg_stat_statements.jit_emission_count,
    pg_stat_statements.jit_emission_time
   FROM pg_stat_statements(true) pg_stat_statements(userid, dbid, toplevel, queryid, query, plans, total_plan_time, min_plan_time, max_plan_time, mean_plan_time, stddev_plan_time, calls, total_exec_time, min_exec_time, max_exec_time, mean_exec_time, stddev_exec_time, rows, shared_blks_hit, shared_blks_read, shared_blks_dirtied, shared_blks_written, local_blks_hit, local_blks_read, local_blks_dirtied, local_blks_written, temp_blks_read, temp_blks_written, blk_read_time, blk_write_time, temp_blk_read_time, temp_blk_write_time, wal_records, wal_fpi, wal_bytes, jit_functions, jit_generation_time, jit_inlining_count, jit_inlining_time, jit_optimization_count, jit_optimization_time, jit_emission_count, jit_emission_time);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| extensions | pg_stat_statements_info                        |  SELECT pg_stat_statements_info.dealloc,
    pg_stat_statements_info.stats_reset
   FROM pg_stat_statements_info() pg_stat_statements_info(dealloc, stats_reset);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | active_loadings                                |  SELECT loadings.loading_id,
    loadings.loading_responsible,
    loadings.loading_section,
    loadings.loading_start,
    loadings.loading_finish,
    loadings.loading_rate,
    loadings.loading_created,
    loadings.loading_updated,
    loadings.loading_task,
        CASE
            WHEN (loadings.loading_finish < CURRENT_DATE) THEN 'Завершена'::text
            WHEN (loadings.loading_start > CURRENT_DATE) THEN 'Будущая'::text
            ELSE 'Текущая'::text
        END AS time_status
   FROM loadings
  WHERE (loadings.loading_status = 'active'::loading_status_type);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| public     | archived_loadings                              |  SELECT loadings.loading_id,
    loadings.loading_responsible,
    loadings.loading_section,
    loadings.loading_stage,
    loadings.loading_start,
    loadings.loading_finish,
    loadings.loading_rate,
    loadings.loading_created,
    loadings.loading_updated,
    loadings.loading_task,
    'Архивная'::text AS time_status
   FROM loadings
  WHERE (loadings.loading_status = 'archived'::loading_status_type);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | view_calendar_vacations                        |  SELECT calendar_events.calendar_event_id,
    calendar_events.calendar_event_type,
    calendar_events.calendar_event_comment,
    calendar_events.calendar_event_is_global,
    calendar_events.calendar_event_is_weekday,
    calendar_events.calendar_event_created_by,
    calendar_events.calendar_event_date_start,
    calendar_events.calendar_event_date_end,
    calendar_events.calendar_event_created_at
   FROM calendar_events
  WHERE (calendar_events.calendar_event_type = ANY (ARRAY['Отпуск запрошен'::calendar_event_type_enum, 'Отпуск одобрен'::calendar_event_type_enum, 'Отпуск отклонен'::calendar_event_type_enum]));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| public     | view_decomposition_item_actuals                |  SELECT di.decomposition_item_id,
    di.decomposition_item_section_id AS section_id,
    COALESCE(sum(wl.work_log_hours), (0)::numeric) AS actual_hours,
    COALESCE(sum(wl.work_log_amount), (0)::numeric) AS actual_amount,
    count(wl.work_log_id) AS work_logs_count,
    max(wl.work_log_date) AS last_work_log_date
   FROM (decomposition_items di
     LEFT JOIN work_logs wl ON ((wl.decomposition_item_id = di.decomposition_item_id)))
  GROUP BY di.decomposition_item_id, di.decomposition_item_section_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | view_decomposition_item_totals                 |  SELECT di.decomposition_item_id,
    (COALESCE(sum(wl.work_log_hours), (0)::numeric))::numeric(10,2) AS actual_hours,
    (COALESCE(sum(wl.work_log_amount), (0)::numeric))::numeric(14,2) AS actual_amount
   FROM (decomposition_items di
     LEFT JOIN work_logs wl ON ((wl.decomposition_item_id = di.decomposition_item_id)))
  GROUP BY di.decomposition_item_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public     | view_decomposition_stage_agg                   |  SELECT s.decomposition_stage_section_id AS section_id,
    s.decomposition_stage_id AS stage_id,
    s.decomposition_stage_name AS stage_name,
    s.decomposition_stage_start AS start_date,
    s.decomposition_stage_finish AS finish_date,
    COALESCE(sum(di.decomposition_item_planned_hours), (0)::numeric) AS planned_hours,
    COALESCE(sum(wl.work_log_hours), (0)::numeric) AS actual_hours,
    count(DISTINCT di.decomposition_item_id) AS items_count,
    min(di.decomposition_item_planned_due_date) AS min_due_date,
    max(di.decomposition_item_planned_due_date) AS max_due_date
   FROM ((decomposition_stages s
     LEFT JOIN decomposition_items di ON ((di.decomposition_item_stage_id = s.decomposition_stage_id)))
     LEFT JOIN work_logs wl ON ((wl.decomposition_item_id = di.decomposition_item_id)))
  GROUP BY s.decomposition_stage_section_id, s.decomposition_stage_id, s.decomposition_stage_name, s.decomposition_stage_start, s.decomposition_stage_finish;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public     | view_department_heads                          |  SELECT d.department_id,
    d.department_name,
    d.department_head_id AS user_id,
    p.first_name,
    p.last_name,
    p.email,
    p.avatar_url
   FROM (departments d
     LEFT JOIN profiles p ON ((d.department_head_id = p.user_id)))
  WHERE ((d.department_name <> 'Без отдела'::text) AND (d.department_head_id IS NOT NULL));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | view_department_statistics                     |  SELECT COALESCE(p.department_id, '00000000-0000-0000-0000-000000000000'::uuid) AS final_department_id,
    COALESCE(d.department_name, 'Без отдела'::text) AS final_department_name,
    count(DISTINCT p.user_id) AS total_employees,
    count(DISTINCT
        CASE
            WHEN vew.has_loadings THEN p.user_id
            ELSE NULL::uuid
        END) AS employees_with_loadings,
    round((((count(DISTINCT
        CASE
            WHEN vew.has_loadings THEN p.user_id
            ELSE NULL::uuid
        END))::numeric / (NULLIF(count(DISTINCT p.user_id), 0))::numeric) * (100)::numeric), 2) AS loading_percentage,
    round(avg(p.employment_rate), 2) AS avg_employment_rate,
    count(DISTINCT t.team_id) AS teams_count,
    json_agg(DISTINCT jsonb_build_object('team_id', t.team_id, 'team_name', COALESCE(t.team_name, 'Без команды'::text), 'employees_count', ( SELECT count(*) AS count
           FROM profiles p2
          WHERE ((COALESCE(p2.team_id, '00000000-0000-0000-0000-000000000000'::uuid) = COALESCE(t.team_id, '00000000-0000-0000-0000-000000000000'::uuid)) AND (COALESCE(p2.department_id, '00000000-0000-0000-0000-000000000000'::uuid) = COALESCE(p.department_id, '00000000-0000-0000-0000-000000000000'::uuid)))))) AS teams_info
   FROM (((profiles p
     LEFT JOIN departments d ON ((p.department_id = d.department_id)))
     LEFT JOIN teams t ON ((p.team_id = t.team_id)))
     LEFT JOIN ( SELECT DISTINCT view_employee_workloads.user_id,
            view_employee_workloads.has_loadings
           FROM view_employee_workloads) vew ON ((p.user_id = vew.user_id)))
  GROUP BY COALESCE(p.department_id, '00000000-0000-0000-0000-000000000000'::uuid), COALESCE(d.department_name, 'Без отдела'::text)
  ORDER BY COALESCE(d.department_name, 'Без отдела'::text);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| public     | view_departments_with_heads                    |  SELECT d.department_id,
    d.department_name,
    d.subdivision_id,
    s.subdivision_name,
    d.department_head_id,
    p.first_name AS head_first_name,
    p.last_name AS head_last_name,
    concat(p.first_name, ' ', p.last_name) AS head_full_name,
    p.email AS head_email,
    p.avatar_url AS head_avatar_url
   FROM ((departments d
     LEFT JOIN subdivisions s ON ((d.subdivision_id = s.subdivision_id)))
     LEFT JOIN profiles p ON ((d.department_head_id = p.user_id)))
  WHERE (d.department_name <> 'Без отдела'::text)
  ORDER BY d.department_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | view_employee_vacations                        |  SELECT e.calendar_event_id AS vacation_id,
    e.calendar_event_created_by AS user_id,
    p.first_name,
    p.last_name,
    ((p.first_name || ' '::text) || p.last_name) AS full_name,
    p.department_id,
    p.team_id,
    (e.calendar_event_date_start)::date AS date_start,
    COALESCE((e.calendar_event_date_end)::date, (e.calendar_event_date_start)::date) AS date_end,
    e.calendar_event_comment AS comment,
    e.calendar_event_created_at AS created_at
   FROM (calendar_events e
     JOIN profiles p ON ((p.user_id = e.calendar_event_created_by)))
  WHERE ((e.calendar_event_is_global = false) AND (e.calendar_event_type = 'Отпуск одобрен'::calendar_event_type_enum));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_employee_vacations_daily                  |  SELECT v.vacation_id,
    v.user_id,
    v.department_id,
    v.team_id,
    (gs.gs)::date AS vacation_date,
    1.0 AS rate
   FROM (view_employee_vacations v
     CROSS JOIN LATERAL generate_series((v.date_start)::timestamp with time zone, (v.date_end)::timestamp with time zone, '1 day'::interval) gs(gs));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_employee_workloads                        |  SELECT p.user_id,
    p.first_name,
    p.last_name,
        CASE
            WHEN ((TRIM(BOTH FROM p.first_name) = ''::text) OR (p.first_name IS NULL) OR (TRIM(BOTH FROM p.last_name) = ''::text) OR (p.last_name IS NULL)) THEN split_part(p.email, '@'::text, 1)
            ELSE concat(p.first_name, ' ', p.last_name)
        END AS full_name,
    p.email,
    p.avatar_url,
    p.work_format,
    p.employment_rate,
    pos.position_id,
    COALESCE(pos.position_name, 'Без должности'::text) AS position_name,
    p.department_id AS original_department_id,
    COALESCE(d.department_name, 'Без отдела'::text) AS original_department_name,
    p.team_id AS original_team_id,
    COALESCE(t.team_name, 'Без команды'::text) AS original_team_name,
    COALESCE(p.department_id, '00000000-0000-0000-0000-000000000000'::uuid) AS final_department_id,
    COALESCE(d.department_name, 'Без отдела'::text) AS final_department_name,
    COALESCE(p.team_id, '00000000-0000-0000-0000-000000000000'::uuid) AS final_team_id,
    COALESCE(t.team_name, 'Без команды'::text) AS final_team_name,
    cat.category_id,
    COALESCE(cat.category_name, 'Без категории'::text) AS category_name,
    NULL::uuid AS role_id,
        CASE
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'admin'::text)))) THEN 'admin'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'department_head'::text)))) THEN 'department_head'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'team_lead'::text)))) THEN 'team_lead'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'user'::text)))) THEN 'user'::text
            ELSE NULL::text
        END AS role_name,
    l.loading_id,
        CASE
            WHEN (l.loading_stage IS NOT NULL) THEN ds.decomposition_stage_section_id
            ELSE l.loading_section
        END AS loading_section,
    l.loading_start,
    l.loading_finish,
    l.loading_rate,
    l.loading_status,
    s.section_id,
    s.section_name,
    pr.project_id,
    pr.project_name,
    pr.project_status,
        CASE
            WHEN (l.loading_id IS NOT NULL) THEN true
            ELSE false
        END AS has_loadings,
    count(l.loading_id) OVER (PARTITION BY p.user_id) AS loadings_count,
    ds.decomposition_stage_id AS stage_id,
    ds.decomposition_stage_name AS stage_name
   FROM ((((((((profiles p
     LEFT JOIN departments d ON ((p.department_id = d.department_id)))
     LEFT JOIN teams t ON ((p.team_id = t.team_id)))
     LEFT JOIN positions pos ON ((p.position_id = pos.position_id)))
     LEFT JOIN categories cat ON ((p.category_id = cat.category_id)))
     LEFT JOIN loadings l ON (((p.user_id = l.loading_responsible) AND (l.loading_status = 'active'::loading_status_type))))
     LEFT JOIN decomposition_stages ds ON ((ds.decomposition_stage_id = l.loading_stage)))
     LEFT JOIN sections s ON ((((l.loading_stage IS NOT NULL) AND (s.section_id = ds.decomposition_stage_section_id)) OR ((l.loading_stage IS NULL) AND (s.section_id = l.loading_section)))))
     LEFT JOIN projects pr ON ((pr.project_id = s.section_project_id)))
  ORDER BY d.department_name, t.team_name, p.last_name, p.first_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| public     | view_integrity_violations                      |  SELECT 'employee_wrong_department'::text AS violation_type,
    concat(p.first_name, ' ', p.last_name) AS details,
    p.user_id,
    ((('Сотрудник отдела '::text || d1.department_name) || ' в команде отдела '::text) || d2.department_name) AS description
   FROM (((profiles p
     JOIN departments d1 ON ((p.department_id = d1.department_id)))
     JOIN teams t ON ((p.team_id = t.team_id)))
     JOIN departments d2 ON ((t.department_id = d2.department_id)))
  WHERE (p.department_id <> t.department_id)
UNION ALL
 SELECT 'department_head_in_own_department'::text AS violation_type,
    concat(p.first_name, ' ', p.last_name) AS details,
    p.user_id,
    (('Руководитель отдела '::text || d.department_name) || ' является сотрудником того же отдела'::text) AS description
   FROM (departments d
     JOIN profiles p ON ((d.department_head_id = p.user_id)))
  WHERE (p.department_id = d.department_id)
UNION ALL
 SELECT 'team_lead_in_own_team'::text AS violation_type,
    concat(p.first_name, ' ', p.last_name) AS details,
    p.user_id,
    (('Тимлид команды '::text || t.team_name) || ' является сотрудником той же команды'::text) AS description
   FROM (teams t
     JOIN profiles p ON ((t.team_lead_id = p.user_id)))
  WHERE (p.team_id = t.team_id);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public     | view_manager_projects                          |  SELECT p.project_id,
    p.project_name,
    p.project_manager AS manager_id,
    prof.first_name AS manager_first_name,
    prof.last_name AS manager_last_name,
    concat(prof.first_name, ' ', prof.last_name) AS manager_name,
    COALESCE(( SELECT jsonb_agg(jsonb_build_object('tag_id', pt.tag_id, 'name', pt.name, 'color', pt.color) ORDER BY pt.name) AS jsonb_agg
           FROM (project_tag_links ptl
             JOIN project_tags pt ON ((ptl.tag_id = pt.tag_id)))
          WHERE (ptl.project_id = p.project_id)), '[]'::jsonb) AS project_tags
   FROM (projects p
     JOIN profiles prof ON ((p.project_manager = prof.user_id)))
  WHERE (p.project_manager IS NOT NULL)
  ORDER BY p.project_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| public     | view_my_work_analytics                         |  SELECT p.user_id,
    COALESCE(comments_data.comments_count, (0)::bigint) AS comments_count,
    COALESCE(mentions_data.mentions_count, (0)::bigint) AS mentions_count,
    COALESCE(active_loadings_data.active_loadings_count, (0)::bigint) AS active_loadings_count,
    COALESCE(archived_loadings_data.archived_loadings_count, (0)::bigint) AS archived_loadings_count,
    COALESCE(today_hours_data.today_hours, (0)::numeric) AS today_hours,
    COALESCE(week_hours_data.week_hours, (0)::numeric) AS week_hours,
    COALESCE(responsibilities_data.responsibilities, '[]'::jsonb) AS responsibilities
   FROM (((((((profiles p
     LEFT JOIN ( SELECT section_comments.author_id AS user_id,
            count(*) AS comments_count
           FROM section_comments
          GROUP BY section_comments.author_id) comments_data ON ((p.user_id = comments_data.user_id)))
     LEFT JOIN ( SELECT unnest(section_comments.mentions) AS user_id,
            count(*) AS mentions_count
           FROM section_comments
          WHERE ((section_comments.mentions IS NOT NULL) AND (array_length(section_comments.mentions, 1) > 0))
          GROUP BY (unnest(section_comments.mentions))) mentions_data ON ((p.user_id = mentions_data.user_id)))
     LEFT JOIN ( SELECT loadings.loading_responsible AS user_id,
            count(*) AS active_loadings_count
           FROM loadings
          WHERE (loadings.loading_status = 'active'::loading_status_type)
          GROUP BY loadings.loading_responsible) active_loadings_data ON ((p.user_id = active_loadings_data.user_id)))
     LEFT JOIN ( SELECT loadings.loading_responsible AS user_id,
            count(*) AS archived_loadings_count
           FROM loadings
          WHERE (loadings.loading_status = 'archived'::loading_status_type)
          GROUP BY loadings.loading_responsible) archived_loadings_data ON ((p.user_id = archived_loadings_data.user_id)))
     LEFT JOIN ( SELECT work_logs.work_log_created_by AS user_id,
            sum(work_logs.work_log_hours) AS today_hours
           FROM work_logs
          WHERE (work_logs.work_log_date = CURRENT_DATE)
          GROUP BY work_logs.work_log_created_by) today_hours_data ON ((p.user_id = today_hours_data.user_id)))
     LEFT JOIN ( SELECT work_logs.work_log_created_by AS user_id,
            sum(work_logs.work_log_hours) AS week_hours
           FROM work_logs
          WHERE (work_logs.work_log_date >= date_trunc('week'::text, (CURRENT_DATE)::timestamp with time zone))
          GROUP BY work_logs.work_log_created_by) week_hours_data ON ((p.user_id = week_hours_data.user_id)))
     LEFT JOIN ( WITH projects_manager AS (
                 SELECT projects.project_manager AS user_id,
                    jsonb_agg(jsonb_build_object('type', 'project_manager', 'entity_id', projects.project_id, 'entity_name', projects.project_name, 'entity_description', projects.project_description) ORDER BY projects.project_name) AS items
                   FROM projects
                  WHERE (projects.project_manager IS NOT NULL)
                  GROUP BY projects.project_manager
                ), projects_lead AS (
                 SELECT projects.project_lead_engineer AS user_id,
                    jsonb_agg(jsonb_build_object('type', 'lead_engineer', 'entity_id', projects.project_id, 'entity_name', projects.project_name, 'entity_description', projects.project_description) ORDER BY projects.project_name) AS items
                   FROM projects
                  WHERE (projects.project_lead_engineer IS NOT NULL)
                  GROUP BY projects.project_lead_engineer
                ), sections_resp AS (
                 SELECT sections.section_responsible AS user_id,
                    jsonb_agg(jsonb_build_object('type', 'section_responsible', 'entity_id', sections.section_id, 'entity_name', sections.section_name, 'entity_description', sections.section_description) ORDER BY sections.section_name) AS items
                   FROM sections
                  WHERE (sections.section_responsible IS NOT NULL)
                  GROUP BY sections.section_responsible
                )
         SELECT u.user_id,
            ((COALESCE(pm.items, '[]'::jsonb) || COALESCE(pl.items, '[]'::jsonb)) || COALESCE(sr.items, '[]'::jsonb)) AS responsibilities
           FROM (((profiles u
             LEFT JOIN projects_manager pm ON ((pm.user_id = u.user_id)))
             LEFT JOIN projects_lead pl ON ((pl.user_id = u.user_id)))
             LEFT JOIN sections_resp sr ON ((sr.user_id = u.user_id)))) responsibilities_data ON ((p.user_id = responsibilities_data.user_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public     | view_organizational_structure                  |  SELECT d.department_id,
    d.department_name,
    d.department_head_id,
    concat(dh.first_name, ' ', dh.last_name) AS department_head_name,
    dh.email AS department_head_email,
    dh.avatar_url AS department_head_avatar_url,
    concat(dh.first_name, ' ', dh.last_name) AS department_head_full_name,
    t.team_id,
    t.team_name,
    t.team_lead_id,
    concat(tl.first_name, ' ', tl.last_name) AS team_lead_name,
    tl.email AS team_lead_email,
    tl.avatar_url AS team_lead_avatar_url,
    concat(tl.first_name, ' ', tl.last_name) AS team_lead_full_name,
    p.user_id,
    concat(p.first_name, ' ', p.last_name) AS employee_name,
    p.first_name AS employee_first_name,
    p.last_name AS employee_last_name,
    p.work_format,
    p.employment_rate,
    ( SELECT count(DISTINCT p2.user_id) AS count
           FROM profiles p2
          WHERE (p2.department_id = d.department_id)) AS department_employee_count,
    ( SELECT count(DISTINCT p2.user_id) AS count
           FROM profiles p2
          WHERE (p2.team_id = t.team_id)) AS team_employee_count
   FROM ((((departments d
     LEFT JOIN profiles dh ON ((d.department_head_id = dh.user_id)))
     LEFT JOIN teams t ON ((d.department_id = t.department_id)))
     LEFT JOIN profiles tl ON ((t.team_lead_id = tl.user_id)))
     LEFT JOIN profiles p ON ((t.team_id = p.team_id)))
  WHERE (d.department_name <> 'Без отдела'::text)
  ORDER BY d.department_name, t.team_name, p.last_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | view_organizational_structure_ui               |  SELECT d.department_id,
    d.department_name,
    d.department_head_id,
    concat(dh.first_name, ' ', dh.last_name) AS department_head_name,
    dh.email AS department_head_email,
    dh.avatar_url AS department_head_avatar_url,
    t.team_id,
    t.team_name,
    t.team_lead_id,
    concat(tl.first_name, ' ', tl.last_name) AS team_lead_name,
    tl.email AS team_lead_email,
    tl.avatar_url AS team_lead_avatar_url,
    p.user_id,
    concat(p.first_name, ' ', p.last_name) AS employee_name,
    p.first_name AS employee_first_name,
    p.last_name AS employee_last_name,
    p.email AS employee_email,
    p.avatar_url AS employee_avatar_url,
    p.work_format,
    p.employment_rate
   FROM ((((departments d
     LEFT JOIN profiles dh ON ((d.department_head_id = dh.user_id)))
     LEFT JOIN teams t ON ((d.department_id = t.department_id)))
     LEFT JOIN profiles tl ON ((t.team_lead_id = tl.user_id)))
     LEFT JOIN profiles p ON ((t.team_id = p.team_id)))
  WHERE (d.department_name <> 'Без отдела'::text)
  ORDER BY d.department_name, t.team_name, p.last_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | view_planning_analytics_departments_2          |  WITH today_date AS (
         SELECT CURRENT_DATE AS "current_date"
        ), absence_users AS (
         SELECT DISTINCT p_1.user_id,
            p_1.department_id
           FROM ((calendar_events ce
             JOIN profiles p_1 ON ((ce.calendar_event_created_by = p_1.user_id)))
             CROSS JOIN today_date td_1)
          WHERE ((ce.calendar_event_type = ANY (ARRAY['Отпуск одобрен'::calendar_event_type_enum, 'Больничный'::calendar_event_type_enum, 'Отгул'::calendar_event_type_enum])) AND (ce.calendar_event_is_global = false) AND (ce.calendar_event_date_start <= td_1."current_date") AND (ce.calendar_event_date_end >= td_1."current_date") AND (p_1.department_id IS NOT NULL))
        )
 SELECT ( SELECT CURRENT_DATE AS "current_date"
           FROM today_date) AS analytics_date,
    d.department_id,
    d.department_name,
    d.subdivision_id,
    sub.subdivision_name,
    count(DISTINCT p.user_id) AS total_users,
    count(DISTINCT
        CASE
            WHEN ((l.loading_responsible IS NOT NULL) OR (au.user_id IS NOT NULL)) THEN p.user_id
            ELSE NULL::uuid
        END) AS users_with_loading,
        CASE
            WHEN (count(DISTINCT p.user_id) > 0) THEN round((((count(DISTINCT
            CASE
                WHEN ((l.loading_responsible IS NOT NULL) OR (au.user_id IS NOT NULL)) THEN p.user_id
                ELSE NULL::uuid
            END))::numeric / (count(DISTINCT p.user_id))::numeric) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS percentage_users_with_loading,
    count(DISTINCT l.loading_section) AS sections_in_work_today,
    count(DISTINCT s.section_project_id) AS projects_in_work_today,
    array_agg(DISTINCT l.loading_section) FILTER (WHERE (l.loading_section IS NOT NULL)) AS section_ids_array,
    array_agg(DISTINCT s.section_project_id) FILTER (WHERE (s.section_project_id IS NOT NULL)) AS project_ids_array,
    COALESCE(sum(l.loading_rate), (0)::numeric) AS total_loading_rate,
        CASE
            WHEN (count(DISTINCT p.user_id) > 0) THEN round((COALESCE(sum(l.loading_rate), (0)::numeric) / (count(DISTINCT p.user_id))::numeric), 2)
            ELSE (0)::numeric
        END AS avg_department_loading,
    ( SELECT jsonb_agg(jsonb_build_object('first_name', p2.first_name, 'last_name', p2.last_name, 'category_name', c.category_name) ORDER BY p2.last_name, p2.first_name) AS jsonb_agg
           FROM (profiles p2
             LEFT JOIN categories c ON ((p2.category_id = c.category_id)))
          WHERE ((p2.department_id = d.department_id) AND (NOT (EXISTS ( SELECT 1
                   FROM (loadings l2
                     CROSS JOIN today_date td_1)
                  WHERE ((l2.loading_responsible = p2.user_id) AND (l2.loading_status = 'active'::loading_status_type) AND (l2.loading_start <= td_1."current_date") AND (l2.loading_finish >= td_1."current_date") AND (l2.is_shortage = false))))) AND (NOT (EXISTS ( SELECT 1
                   FROM absence_users au_1
                  WHERE (au_1.user_id = p2.user_id)))))) AS users_without_loading,
    count(l.loading_id) AS total_loadings_count,
    count(DISTINCT
        CASE
            WHEN ((au.user_id IS NOT NULL) AND (l.loading_responsible IS NULL)) THEN au.user_id
            ELSE NULL::uuid
        END) AS absence_count
   FROM ((((((departments d
     LEFT JOIN subdivisions sub ON ((d.subdivision_id = sub.subdivision_id)))
     CROSS JOIN today_date td)
     LEFT JOIN profiles p ON ((p.department_id = d.department_id)))
     LEFT JOIN absence_users au ON ((au.user_id = p.user_id)))
     LEFT JOIN loadings l ON (((l.loading_responsible = p.user_id) AND (l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false))))
     LEFT JOIN sections s ON ((l.loading_section = s.section_id)))
  GROUP BY d.department_id, d.department_name, d.subdivision_id, sub.subdivision_name
  ORDER BY
        CASE
            WHEN (count(DISTINCT p.user_id) > 0) THEN round((COALESCE(sum(l.loading_rate), (0)::numeric) / (count(DISTINCT p.user_id))::numeric), 2)
            ELSE (0)::numeric
        END DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | view_planning_analytics_departments_projects_2 |  WITH today_date AS (
         SELECT CURRENT_DATE AS "current_date"
        ), absence_users AS (
         SELECT DISTINCT p.user_id,
            p.department_id
           FROM ((calendar_events ce
             JOIN profiles p ON ((ce.calendar_event_created_by = p.user_id)))
             CROSS JOIN today_date td)
          WHERE ((ce.calendar_event_type = ANY (ARRAY['Отпуск одобрен'::calendar_event_type_enum, 'Больничный'::calendar_event_type_enum, 'Отгул'::calendar_event_type_enum])) AND (ce.calendar_event_is_global = false) AND (ce.calendar_event_date_start <= td."current_date") AND (ce.calendar_event_date_end >= td."current_date") AND (p.department_id IS NOT NULL))
        ), department_projects AS (
         SELECT d.department_id,
            d.department_name,
            d.subdivision_id,
            sub.subdivision_name,
            (p.project_id)::text AS project_id,
            p.project_name,
            count(l.loading_id) AS users_count,
            COALESCE(sum(l.loading_rate), (0)::numeric) AS total_loading_rate
           FROM ((((((departments d
             LEFT JOIN subdivisions sub ON ((d.subdivision_id = sub.subdivision_id)))
             CROSS JOIN today_date td)
             LEFT JOIN profiles prof ON ((prof.department_id = d.department_id)))
             LEFT JOIN loadings l ON (((l.loading_responsible = prof.user_id) AND (l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false))))
             LEFT JOIN sections s ON ((l.loading_section = s.section_id)))
             LEFT JOIN projects p ON ((s.section_project_id = p.project_id)))
          WHERE ((p.project_id IS NOT NULL) AND (l.loading_id IS NOT NULL))
          GROUP BY d.department_id, d.department_name, d.subdivision_id, sub.subdivision_name, p.project_id, p.project_name
         HAVING (COALESCE(sum(l.loading_rate), (0)::numeric) > (0)::numeric)
        ), absence_projects AS (
         SELECT d.department_id,
            d.department_name,
            d.subdivision_id,
            sub.subdivision_name,
            'absence'::text AS project_id,
            'Отпуск/Больничный/Отгул'::text AS project_name,
            count(DISTINCT au.user_id) AS users_count,
            (count(DISTINCT au.user_id))::numeric AS total_loading_rate
           FROM ((departments d
             LEFT JOIN subdivisions sub ON ((d.subdivision_id = sub.subdivision_id)))
             JOIN absence_users au ON ((au.department_id = d.department_id)))
          GROUP BY d.department_id, d.department_name, d.subdivision_id, sub.subdivision_name
         HAVING (count(DISTINCT au.user_id) > 0)
        )
 SELECT ( SELECT CURRENT_DATE AS "current_date"
           FROM today_date) AS analytics_date,
    combined.department_id,
    combined.department_name,
    combined.subdivision_id,
    combined.subdivision_name,
    combined.project_id,
    combined.project_name,
    combined.users_count,
    combined.total_loading_rate,
    row_number() OVER (PARTITION BY combined.department_id ORDER BY combined.total_loading_rate DESC) AS rank
   FROM ( SELECT department_projects.department_id,
            department_projects.department_name,
            department_projects.subdivision_id,
            department_projects.subdivision_name,
            department_projects.project_id,
            department_projects.project_name,
            department_projects.users_count,
            department_projects.total_loading_rate
           FROM department_projects
        UNION ALL
         SELECT absence_projects.department_id,
            absence_projects.department_name,
            absence_projects.subdivision_id,
            absence_projects.subdivision_name,
            absence_projects.project_id,
            absence_projects.project_name,
            absence_projects.users_count,
            absence_projects.total_loading_rate
           FROM absence_projects) combined
  ORDER BY combined.department_id, (row_number() OVER (PARTITION BY combined.department_id ORDER BY combined.total_loading_rate DESC));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public     | view_planning_analytics_summary                |  WITH today_date AS (
         SELECT CURRENT_DATE AS "current_date"
        ), users_with_loading AS (
         SELECT count(DISTINCT
                CASE
                    WHEN (l.loading_id IS NOT NULL) THEN p.user_id
                    ELSE NULL::uuid
                END) AS users_with_loading_count,
            count(DISTINCT p.user_id) AS total_users_count,
                CASE
                    WHEN (count(DISTINCT p.user_id) > 0) THEN round((((count(DISTINCT
                    CASE
                        WHEN (l.loading_id IS NOT NULL) THEN p.user_id
                        ELSE NULL::uuid
                    END))::numeric / (count(DISTINCT p.user_id))::numeric) * (100)::numeric), 2)
                    ELSE (0)::numeric
                END AS percentage_users_with_loading
           FROM ((profiles p
             CROSS JOIN today_date td)
             LEFT JOIN loadings l ON (((l.loading_responsible = p.user_id) AND (l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false))))
        ), sections_in_work AS (
         SELECT count(DISTINCT l.loading_section) AS sections_count
           FROM (loadings l
             CROSS JOIN today_date td)
          WHERE ((l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false) AND (l.loading_section IS NOT NULL))
        ), projects_in_work AS (
         SELECT count(DISTINCT s.section_project_id) AS projects_count
           FROM ((loadings l
             CROSS JOIN today_date td)
             JOIN sections s ON ((l.loading_section = s.section_id)))
          WHERE ((l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false) AND (s.section_project_id IS NOT NULL))
        ), department_loading_per_dept AS (
         SELECT d.department_id,
            count(DISTINCT p.user_id) AS total_users,
            COALESCE(sum(l.loading_rate), (0)::numeric) AS total_loading_rate,
                CASE
                    WHEN (count(DISTINCT p.user_id) > 0) THEN (COALESCE(sum(l.loading_rate), (0)::numeric) / (count(DISTINCT p.user_id))::numeric)
                    ELSE (0)::numeric
                END AS avg_loading_per_user
           FROM (((departments d
             CROSS JOIN today_date td)
             LEFT JOIN profiles p ON ((p.department_id = d.department_id)))
             LEFT JOIN loadings l ON (((l.loading_responsible = p.user_id) AND (l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false))))
          GROUP BY d.department_id
        ), department_avg_loading AS (
         SELECT round(avg(department_loading_per_dept.avg_loading_per_user), 2) AS avg_loading
           FROM department_loading_per_dept
        ), top_projects AS (
         SELECT json_agg(json_build_object('project_id', pr.project_id, 'project_name', pr.project_name, 'total_loadings_count', pr.total_loadings_count, 'total_loading_rate', pr.total_loading_rate, 'rank', pr.rank) ORDER BY pr.rank) AS projects_data
           FROM ( SELECT p.project_id,
                    p.project_name,
                    count(l.loading_id) AS total_loadings_count,
                    COALESCE(sum(l.loading_rate), (0)::numeric) AS total_loading_rate,
                    row_number() OVER (ORDER BY COALESCE(sum(l.loading_rate), (0)::numeric) DESC) AS rank
                   FROM ((((projects p
                     CROSS JOIN today_date td)
                     LEFT JOIN sections s ON ((s.section_project_id = p.project_id)))
                     LEFT JOIN loadings l ON (((l.loading_section = s.section_id) AND (l.loading_status = 'active'::loading_status_type) AND (l.loading_start <= td."current_date") AND (l.loading_finish >= td."current_date") AND (l.is_shortage = false))))
                     JOIN profiles prof ON (((l.loading_responsible = prof.user_id) AND (prof.department_id IS NOT NULL))))
                  GROUP BY p.project_id, p.project_name
                 HAVING (COALESCE(sum(l.loading_rate), (0)::numeric) > (0)::numeric)) pr
          WHERE (pr.rank <= 10)
        )
 SELECT ( SELECT CURRENT_DATE AS "current_date"
           FROM today_date) AS analytics_date,
    uwl.users_with_loading_count,
    uwl.total_users_count,
    uwl.percentage_users_with_loading,
    siw.sections_count AS sections_in_work_today,
    piw.projects_count AS projects_in_work_today,
    COALESCE(dal.avg_loading, (0)::numeric) AS avg_department_loading,
    COALESCE(tp.projects_data, '[]'::json) AS top_projects_by_loading
   FROM ((((users_with_loading uwl
     CROSS JOIN sections_in_work siw)
     CROSS JOIN projects_in_work piw)
     CROSS JOIN department_avg_loading dal)
     CROSS JOIN top_projects tp);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | view_planning_team_freshness                   |  SELECT t.team_id,
    t.team_name,
    d.department_id,
    d.department_name,
    ( SELECT ta.confirmed_at
           FROM teams_activity ta
          WHERE (ta.team_id = t.team_id)
          ORDER BY ta.confirmed_at DESC
         LIMIT 1) AS last_confirmed_at,
    ( SELECT GREATEST(COALESCE(max(l.loading_updated), '1970-01-01 00:00:00+00'::timestamp with time zone), COALESCE(max(l.loading_created), '1970-01-01 00:00:00+00'::timestamp with time zone)) AS "greatest"
           FROM (loadings l
             JOIN profiles p ON ((l.loading_responsible = p.user_id)))
          WHERE (p.team_id = t.team_id)) AS last_loading_update,
    ( SELECT (count(*))::integer AS count
           FROM (loadings l
             JOIN profiles p ON ((l.loading_responsible = p.user_id)))
          WHERE ((p.team_id = t.team_id) AND (l.loading_status = 'active'::loading_status_type))) AS active_loadings_count,
    GREATEST(COALESCE(( SELECT ta.confirmed_at
           FROM teams_activity ta
          WHERE (ta.team_id = t.team_id)
          ORDER BY ta.confirmed_at DESC
         LIMIT 1), '1970-01-01 00:00:00+00'::timestamp with time zone), COALESCE(( SELECT GREATEST(max(l.loading_updated), max(l.loading_created)) AS "greatest"
           FROM (loadings l
             JOIN profiles p ON ((l.loading_responsible = p.user_id)))
          WHERE (p.team_id = t.team_id)), '1970-01-01 00:00:00+00'::timestamp with time zone)) AS last_update,
    (EXTRACT(day FROM (CURRENT_TIMESTAMP - GREATEST(COALESCE(( SELECT ta.confirmed_at
           FROM teams_activity ta
          WHERE (ta.team_id = t.team_id)
          ORDER BY ta.confirmed_at DESC
         LIMIT 1), '1970-01-01 00:00:00+00'::timestamp with time zone), COALESCE(( SELECT GREATEST(max(l.loading_updated), max(l.loading_created)) AS "greatest"
           FROM (loadings l
             JOIN profiles p ON ((l.loading_responsible = p.user_id)))
          WHERE (p.team_id = t.team_id)), '1970-01-01 00:00:00+00'::timestamp with time zone)))))::integer AS days_since_update
   FROM (teams t
     JOIN departments d ON ((t.department_id = d.department_id)))
  WHERE (d.department_name <> 'Без отдела'::text)
  ORDER BY d.department_name, t.team_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_project_dashboard                         |  SELECT p.project_id,
    COALESCE(di_agg.hours_planned_total, (0)::numeric) AS hours_planned_total,
    COALESCE(wl_agg.hours_actual_total, (0)::numeric) AS hours_actual_total,
    COALESCE(di_agg.decomposition_count, (0)::bigint) AS decomposition_count
   FROM ((projects p
     LEFT JOIN ( SELECT s.section_project_id AS project_id,
            sum(di.decomposition_item_planned_hours) AS hours_planned_total,
            count(di.decomposition_item_id) AS decomposition_count
           FROM (sections s
             JOIN decomposition_items di ON ((di.decomposition_item_section_id = s.section_id)))
          GROUP BY s.section_project_id) di_agg ON ((di_agg.project_id = p.project_id)))
     LEFT JOIN ( SELECT s.section_project_id AS project_id,
            sum(wl.work_log_hours) AS hours_actual_total
           FROM ((sections s
             JOIN decomposition_items di ON ((di.decomposition_item_section_id = s.section_id)))
             JOIN work_logs wl ON ((wl.decomposition_item_id = di.decomposition_item_id)))
          GROUP BY s.section_project_id) wl_agg ON ((wl_agg.project_id = p.project_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | view_project_summary                           |  WITH project_bounds AS (
         SELECT s.section_project_id AS project_id,
            (min(s.section_start_date))::date AS project_start_date,
            (max(s.section_end_date))::date AS project_end_date,
            count(*) AS sections_count
           FROM sections s
          GROUP BY s.section_project_id
        ), loadings_resolved AS (
         SELECT COALESCE(ds.decomposition_stage_section_id, l.loading_section) AS section_id,
            l.loading_id,
            l.loading_responsible,
            l.loading_start,
            l.loading_finish,
            l.loading_rate,
            l.loading_status,
            l.is_shortage
           FROM (loadings l
             LEFT JOIN decomposition_stages ds ON ((ds.decomposition_stage_id = l.loading_stage)))
        ), project_loadings AS (
         SELECT s.section_project_id AS project_id,
            lr.loading_id,
            lr.loading_responsible,
            lr.loading_start,
            lr.loading_finish,
            lr.loading_rate,
            lr.loading_status,
            lr.is_shortage
           FROM (loadings_resolved lr
             JOIN sections s ON ((s.section_id = lr.section_id)))
        ), today AS (
         SELECT CURRENT_DATE AS d
        ), project_loadings_today_agg AS (
         SELECT pl.project_id,
            count(DISTINCT pl.loading_responsible) AS employees_with_loadings_today,
            count(pl.loading_id) AS loadings_count_today,
            COALESCE(sum(pl.loading_rate), (0)::numeric) AS total_loading_rate_today
           FROM (project_loadings pl
             CROSS JOIN today t)
          WHERE ((pl.loading_status = 'active'::loading_status_type) AND (pl.is_shortage = false) AND (pl.loading_start <= t.d) AND (pl.loading_finish >= t.d))
          GROUP BY pl.project_id
        ), project_loadings_active_agg AS (
         SELECT pl.project_id,
            count(DISTINCT pl.loading_responsible) AS employees_with_loadings_active,
            count(pl.loading_id) AS loadings_count_active,
            COALESCE(sum(pl.loading_rate), (0)::numeric) AS total_loading_rate_active
           FROM project_loadings pl
          WHERE ((pl.loading_status = 'active'::loading_status_type) AND (pl.is_shortage = false))
          GROUP BY pl.project_id
        ), engaged_employees AS (
         SELECT ps.section_project_id AS project_id,
            ps.section_responsible AS user_id
           FROM sections ps
          WHERE (ps.section_responsible IS NOT NULL)
        UNION
         SELECT s.section_project_id,
            t.task_responsible
           FROM (tasks t
             JOIN sections s ON ((s.section_id = t.task_parent_section)))
          WHERE (t.task_responsible IS NOT NULL)
        UNION
         SELECT s.section_project_id,
            di.decomposition_item_responsible
           FROM (decomposition_items di
             JOIN sections s ON ((s.section_id = di.decomposition_item_section_id)))
          WHERE (di.decomposition_item_responsible IS NOT NULL)
        UNION
         SELECT pla.project_id,
            pla.loading_responsible
           FROM project_loadings pla
          WHERE ((pla.loading_responsible IS NOT NULL) AND (pla.loading_status = 'active'::loading_status_type) AND (pla.is_shortage = false))
        ), engaged_employees_agg AS (
         SELECT engaged_employees.project_id,
            count(DISTINCT engaged_employees.user_id) AS engaged_employees_total
           FROM engaged_employees
          GROUP BY engaged_employees.project_id
        ), engaged_employees_with_profiles AS (
         SELECT ee.project_id,
            ee.user_id,
            p_1.first_name,
            p_1.last_name,
            p_1.email,
            p_1.department_id,
            p_1.team_id
           FROM (engaged_employees ee
             LEFT JOIN profiles p_1 ON ((p_1.user_id = ee.user_id)))
        ), project_departments AS (
         SELECT eep.project_id,
            COALESCE(jsonb_agg(DISTINCT jsonb_build_object('department_id', d.department_id, 'department_name', d.department_name)) FILTER (WHERE (d.department_id IS NOT NULL)), '[]'::jsonb) AS departments_involved,
            COALESCE(array_agg(DISTINCT d.department_id) FILTER (WHERE (d.department_id IS NOT NULL)), ARRAY[]::uuid[]) AS department_ids
           FROM (engaged_employees_with_profiles eep
             LEFT JOIN departments d ON ((d.department_id = eep.department_id)))
          GROUP BY eep.project_id
        ), project_teams AS (
         SELECT eep.project_id,
            COALESCE(jsonb_agg(DISTINCT jsonb_build_object('team_id', t.team_id, 'team_name', t.team_name)) FILTER (WHERE (t.team_id IS NOT NULL)), '[]'::jsonb) AS teams_involved,
            COALESCE(array_agg(DISTINCT t.team_id) FILTER (WHERE (t.team_id IS NOT NULL)), ARRAY[]::uuid[]) AS team_ids
           FROM (engaged_employees_with_profiles eep
             LEFT JOIN teams t ON ((t.team_id = eep.team_id)))
          GROUP BY eep.project_id
        ), project_employees AS (
         SELECT eep.project_id,
            COALESCE(jsonb_agg(DISTINCT jsonb_build_object('user_id', eep.user_id, 'first_name', eep.first_name, 'last_name', eep.last_name, 'email', eep.email, 'department_id', eep.department_id, 'team_id', eep.team_id)) FILTER (WHERE (eep.user_id IS NOT NULL)), '[]'::jsonb) AS employees_involved,
            COALESCE(array_agg(DISTINCT eep.user_id) FILTER (WHERE (eep.user_id IS NOT NULL)), ARRAY[]::uuid[]) AS employee_ids
           FROM engaged_employees_with_profiles eep
          GROUP BY eep.project_id
        ), project_stages AS (
         SELECT s.stage_project_id AS project_id,
            COALESCE(jsonb_agg(jsonb_build_object('stage_id', s.stage_id, 'stage_name', s.stage_name, 'stage_description', s.stage_description) ORDER BY s.stage_created), '[]'::jsonb) AS stages_list
           FROM stages s
          GROUP BY s.stage_project_id
        ), project_objects AS (
         SELECT o.object_project_id AS project_id,
            COALESCE(jsonb_agg(jsonb_build_object('object_id', o.object_id, 'object_name', o.object_name, 'object_description', o.object_description) ORDER BY o.object_created), '[]'::jsonb) AS objects_list
           FROM objects o
          GROUP BY o.object_project_id
        )
 SELECT p.project_id,
    p.project_name,
    p.project_status,
    p.project_created,
    p.client_id,
    c.client_name,
    p.project_manager AS manager_id,
    ((pm.first_name || ' '::text) || pm.last_name) AS manager_name,
    pb.project_start_date,
    pb.project_end_date,
    pb.sections_count,
    COALESCE(plt_agg.employees_with_loadings_today, (0)::bigint) AS employees_with_loadings_today,
    COALESCE(plt_agg.loadings_count_today, (0)::bigint) AS loadings_count_today,
    COALESCE(plt_agg.total_loading_rate_today, (0)::numeric) AS total_loading_rate_today,
    COALESCE(pla_agg.employees_with_loadings_active, (0)::bigint) AS employees_with_loadings_active,
    COALESCE(pla_agg.loadings_count_active, (0)::bigint) AS loadings_count_active,
    COALESCE(pla_agg.total_loading_rate_active, (0)::numeric) AS total_loading_rate_active,
    COALESCE(ee_agg.engaged_employees_total, (0)::bigint) AS engaged_employees_total,
    COALESCE(pd.departments_involved, '[]'::jsonb) AS departments_involved,
    COALESCE(ptm.teams_involved, '[]'::jsonb) AS teams_involved,
    COALESCE(pe.employees_involved, '[]'::jsonb) AS employees_involved,
    COALESCE(psg.stages_list, '[]'::jsonb) AS stages_list,
    COALESCE(pobj.objects_list, '[]'::jsonb) AS objects_list,
    COALESCE(pd.department_ids, ARRAY[]::uuid[]) AS department_ids,
    COALESCE(ptm.team_ids, ARRAY[]::uuid[]) AS team_ids,
    COALESCE(pe.employee_ids, ARRAY[]::uuid[]) AS employee_ids,
    COALESCE(( SELECT jsonb_agg(jsonb_build_object('tag_id', pt.tag_id, 'name', pt.name, 'color', pt.color) ORDER BY pt.name) AS jsonb_agg
           FROM (project_tag_links ptl
             JOIN project_tags pt ON ((ptl.tag_id = pt.tag_id)))
          WHERE (ptl.project_id = p.project_id)), '[]'::jsonb) AS project_tags
   FROM (((((((((((projects p
     LEFT JOIN clients c ON ((c.client_id = p.client_id)))
     LEFT JOIN profiles pm ON ((pm.user_id = p.project_manager)))
     LEFT JOIN project_bounds pb ON ((pb.project_id = p.project_id)))
     LEFT JOIN project_loadings_today_agg plt_agg ON ((plt_agg.project_id = p.project_id)))
     LEFT JOIN project_loadings_active_agg pla_agg ON ((pla_agg.project_id = p.project_id)))
     LEFT JOIN engaged_employees_agg ee_agg ON ((ee_agg.project_id = p.project_id)))
     LEFT JOIN project_departments pd ON ((pd.project_id = p.project_id)))
     LEFT JOIN project_teams ptm ON ((ptm.project_id = p.project_id)))
     LEFT JOIN project_employees pe ON ((pe.project_id = p.project_id)))
     LEFT JOIN project_stages psg ON ((psg.project_id = p.project_id)))
     LEFT JOIN project_objects pobj ON ((pobj.project_id = p.project_id)))
  ORDER BY p.project_name; |
| public     | view_project_tree                              |  WITH projects_with_managers AS (
         SELECT p.project_id,
            p.project_name,
            p.project_description,
            p.project_status,
            p.project_created,
            p.project_updated,
            p.project_manager AS manager_id,
            p.client_id,
            c.client_name,
                CASE
                    WHEN (p.project_manager IS NOT NULL) THEN COALESCE(NULLIF(TRIM(BOTH FROM ((pm.first_name || ' '::text) || pm.last_name)), ''::text), split_part(pm.email, '@'::text, 1))
                    ELSE NULL::text
                END AS manager_name,
            pm.avatar_url AS manager_avatar,
            COALESCE(( SELECT jsonb_agg(jsonb_build_object('tag_id', pt.tag_id, 'name', pt.name, 'color', pt.color) ORDER BY pt.name) AS jsonb_agg
                   FROM (project_tag_links ptl
                     JOIN project_tags pt ON ((ptl.tag_id = pt.tag_id)))
                  WHERE (ptl.project_id = p.project_id)), '[]'::jsonb) AS project_tags
           FROM ((projects p
             LEFT JOIN profiles pm ON ((p.project_manager = pm.user_id)))
             LEFT JOIN clients c ON ((p.client_id = c.client_id)))
        ), all_stages AS (
         SELECT s.stage_id,
            s.stage_name,
            s.stage_description,
            s.stage_project_id,
            s.stage_created,
            s.stage_updated,
            s.external_id AS stage_external_id,
            s.external_source AS stage_external_source
           FROM stages s
        ), all_objects AS (
         SELECT o.object_id,
            o.object_name,
            o.object_description,
            o.object_stage_id,
            o.object_start_date,
            o.object_end_date,
            o.object_created,
            o.object_updated
           FROM objects o
        ), all_sections AS (
         SELECT s.section_id,
            s.section_name,
            s.section_description,
            s.section_object_id,
            s.section_type,
            s.section_start_date,
            s.section_end_date,
            s.section_created,
            s.section_updated,
            s.section_responsible,
            s.section_status_id,
                CASE
                    WHEN (s.section_responsible IS NOT NULL) THEN COALESCE(NULLIF(TRIM(BOTH FROM ((sr.first_name || ' '::text) || sr.last_name)), ''::text), split_part(sr.email, '@'::text, 1))
                    ELSE NULL::text
                END AS section_responsible_name,
            sr.email AS section_responsible_email,
            sr.avatar_url AS section_responsible_avatar,
            sr.department_id AS responsible_department_id,
            d.department_name AS responsible_department_name,
            sr.team_id AS responsible_team_id,
            t.team_name AS responsible_team_name
           FROM (((sections s
             LEFT JOIN profiles sr ON ((s.section_responsible = sr.user_id)))
             LEFT JOIN departments d ON ((sr.department_id = d.department_id)))
             LEFT JOIN teams t ON ((sr.team_id = t.team_id)))
        )
 SELECT pwm.project_id,
    ast.stage_id,
    ao.object_id,
    asec.section_id,
    pwm.project_name,
    ast.stage_name,
    ao.object_name,
    asec.section_name,
    pwm.project_description,
    ast.stage_description,
    ao.object_description,
    asec.section_description,
    pwm.manager_id,
    pwm.manager_name,
    pwm.manager_avatar,
    pwm.client_id,
    pwm.client_name,
    asec.section_responsible AS section_responsible_id,
    asec.section_responsible_name,
    asec.section_responsible_email,
    asec.section_responsible_avatar,
    asec.responsible_department_id,
    asec.responsible_department_name,
    asec.responsible_team_id,
    asec.responsible_team_name,
    pwm.project_status,
    asec.section_type,
    pwm.project_created,
    pwm.project_updated,
    ast.stage_created,
    ast.stage_updated,
    ao.object_start_date,
    ao.object_end_date,
    ao.object_created,
    ao.object_updated,
    asec.section_start_date,
    asec.section_end_date,
    asec.section_created,
    asec.section_updated,
    asec.section_status_id,
    ss.name AS section_status_name,
    ss.color AS section_status_color,
    ast.stage_external_id,
    ast.stage_external_source,
        CASE
            WHEN (asec.section_id IS NOT NULL) THEN 'section'::text
            WHEN (ao.object_id IS NOT NULL) THEN 'object'::text
            WHEN (ast.stage_id IS NOT NULL) THEN 'stage'::text
            ELSE 'project'::text
        END AS node_type,
        CASE
            WHEN (asec.section_id IS NOT NULL) THEN 4
            WHEN (ao.object_id IS NOT NULL) THEN 3
            WHEN (ast.stage_id IS NOT NULL) THEN 2
            ELSE 1
        END AS hierarchy_level,
    (ufp.user_id IS NOT NULL) AS is_favorite,
    pwm.project_tags
   FROM (((((projects_with_managers pwm
     LEFT JOIN all_stages ast ON ((pwm.project_id = ast.stage_project_id)))
     LEFT JOIN all_objects ao ON ((ast.stage_id = ao.object_stage_id)))
     LEFT JOIN all_sections asec ON ((ao.object_id = asec.section_object_id)))
     LEFT JOIN section_statuses ss ON ((asec.section_status_id = ss.id)))
     LEFT JOIN user_favorite_projects ufp ON (((ufp.project_id = pwm.project_id) AND (ufp.user_id = auth.uid()))))
  ORDER BY COALESCE(pwm.manager_name, 'Менеджер не назначен'::text), pwm.project_name, ast.stage_name, ao.object_name, asec.section_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| public     | view_project_tree_backup                       |  WITH projects_with_managers AS (
         SELECT p.project_id,
            p.project_name,
            p.project_description,
            p.project_status,
            p.project_created,
            p.project_updated,
            p.project_manager AS manager_id,
                CASE
                    WHEN (p.project_manager IS NOT NULL) THEN COALESCE(NULLIF(TRIM(BOTH FROM ((pm.first_name || ' '::text) || pm.last_name)), ''::text), split_part(pm.email, '@'::text, 1))
                    ELSE NULL::text
                END AS manager_name,
            pm.avatar_url AS manager_avatar
           FROM (projects p
             LEFT JOIN profiles pm ON ((p.project_manager = pm.user_id)))
        ), all_stages AS (
         SELECT s.stage_id,
            s.stage_name,
            s.stage_description,
            s.stage_project_id,
            s.stage_created,
            s.stage_updated,
            s.external_id AS stage_external_id,
            s.external_source AS stage_external_source
           FROM stages s
        ), all_objects AS (
         SELECT o.object_id,
            o.object_name,
            o.object_description,
            o.object_stage_id,
            o.object_start_date,
            o.object_end_date,
            o.object_created,
            o.object_updated
           FROM objects o
        ), all_sections AS (
         SELECT s.section_id,
            s.section_name,
            s.section_description,
            s.section_object_id,
            s.section_type,
            s.section_start_date,
            s.section_end_date,
            s.section_created,
            s.section_updated,
            s.section_responsible,
                CASE
                    WHEN (s.section_responsible IS NOT NULL) THEN COALESCE(NULLIF(TRIM(BOTH FROM ((sr.first_name || ' '::text) || sr.last_name)), ''::text), split_part(sr.email, '@'::text, 1))
                    ELSE NULL::text
                END AS section_responsible_name,
            sr.email AS section_responsible_email,
            sr.avatar_url AS section_responsible_avatar,
            sr.department_id AS responsible_department_id,
            d.department_name AS responsible_department_name,
            sr.team_id AS responsible_team_id,
            t.team_name AS responsible_team_name
           FROM (((sections s
             LEFT JOIN profiles sr ON ((s.section_responsible = sr.user_id)))
             LEFT JOIN departments d ON ((sr.department_id = d.department_id)))
             LEFT JOIN teams t ON ((sr.team_id = t.team_id)))
        )
 SELECT pwm.project_id,
    ast.stage_id,
    ao.object_id,
    asec.section_id,
    pwm.project_name,
    ast.stage_name,
    ao.object_name,
    asec.section_name,
    pwm.project_description,
    ast.stage_description,
    ao.object_description,
    asec.section_description,
    pwm.manager_id,
    pwm.manager_name,
    pwm.manager_avatar,
    asec.section_responsible AS section_responsible_id,
    asec.section_responsible_name,
    asec.section_responsible_email,
    asec.section_responsible_avatar,
    asec.responsible_department_id,
    asec.responsible_department_name,
    asec.responsible_team_id,
    asec.responsible_team_name,
    pwm.project_status,
    asec.section_type,
    pwm.project_created,
    pwm.project_updated,
    ast.stage_created,
    ast.stage_updated,
    ao.object_start_date,
    ao.object_end_date,
    ao.object_created,
    ao.object_updated,
    asec.section_start_date,
    asec.section_end_date,
    asec.section_created,
    asec.section_updated,
    ast.stage_external_id,
    ast.stage_external_source,
        CASE
            WHEN (asec.section_id IS NOT NULL) THEN 'section'::text
            WHEN (ao.object_id IS NOT NULL) THEN 'object'::text
            WHEN (ast.stage_id IS NOT NULL) THEN 'stage'::text
            ELSE 'project'::text
        END AS node_type,
        CASE
            WHEN (asec.section_id IS NOT NULL) THEN 4
            WHEN (ao.object_id IS NOT NULL) THEN 3
            WHEN (ast.stage_id IS NOT NULL) THEN 2
            ELSE 1
        END AS hierarchy_level
   FROM (((projects_with_managers pwm
     LEFT JOIN all_stages ast ON ((pwm.project_id = ast.stage_project_id)))
     LEFT JOIN all_objects ao ON ((ast.stage_id = ao.object_stage_id)))
     LEFT JOIN all_sections asec ON ((ao.object_id = asec.section_object_id)))
  ORDER BY COALESCE(pwm.manager_name, 'Менеджер не назначен'::text), pwm.project_name, ast.stage_name, ao.object_name, asec.section_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | view_project_tree_timeline                     |  SELECT v.project_id,
    v.project_name,
    v.stage_id,
    v.stage_name,
    v.object_id,
    v.object_name,
    prj.sections_count AS project_sections_count,
    prj.start_date AS project_start_date,
    prj.end_date AS project_end_date,
    prj.active_loadings AS project_active_loadings,
    st.sections_count AS stage_sections_count,
    st.start_date AS stage_start_date,
    st.end_date AS stage_end_date,
    st.active_loadings AS stage_active_loadings,
    obj.sections_count AS object_sections_count,
    obj.active_loadings AS object_active_loadings
   FROM (((view_project_tree v
     LEFT JOIN LATERAL ( SELECT count(*) AS sections_count,
            min(s.section_start_date) AS start_date,
            max(s.section_end_date) AS end_date,
            COALESCE(( SELECT count(*) AS count
                   FROM (loadings l
                     JOIN sections s2 ON ((s2.section_id = l.loading_section)))
                  WHERE ((s2.section_project_id = v.project_id) AND (l.loading_status = 'active'::loading_status_type) AND (NOT ((l.loading_finish < COALESCE((s2.section_start_date)::date, '0001-01-01'::date)) OR (l.loading_start > COALESCE((s2.section_end_date)::date, '9999-12-31'::date)))))), (0)::bigint) AS active_loadings
           FROM sections s
          WHERE (s.section_project_id = v.project_id)) prj ON (true))
     LEFT JOIN LATERAL ( SELECT count(*) AS sections_count,
            min(s.section_start_date) AS start_date,
            max(s.section_end_date) AS end_date,
            COALESCE(( SELECT count(*) AS count
                   FROM ((loadings l
                     JOIN sections s2 ON ((s2.section_id = l.loading_section)))
                     JOIN objects o2 ON ((o2.object_id = s2.section_object_id)))
                  WHERE ((o2.object_stage_id = v.stage_id) AND (l.loading_status = 'active'::loading_status_type) AND (NOT ((l.loading_finish < COALESCE((s2.section_start_date)::date, '0001-01-01'::date)) OR (l.loading_start > COALESCE((s2.section_end_date)::date, '9999-12-31'::date)))))), (0)::bigint) AS active_loadings
           FROM (objects o
             JOIN sections s ON ((s.section_object_id = o.object_id)))
          WHERE ((v.stage_id IS NOT NULL) AND (o.object_stage_id = v.stage_id))) st ON (true))
     LEFT JOIN LATERAL ( SELECT count(*) AS sections_count,
            COALESCE(( SELECT count(*) AS count
                   FROM (loadings l
                     JOIN sections s2 ON ((s2.section_id = l.loading_section)))
                  WHERE ((s2.section_object_id = v.object_id) AND (l.loading_status = 'active'::loading_status_type) AND (NOT ((l.loading_finish < COALESCE((s2.section_start_date)::date, '0001-01-01'::date)) OR (l.loading_start > COALESCE((s2.section_end_date)::date, '9999-12-31'::date)))))), (0)::bigint) AS active_loadings
           FROM sections s
          WHERE ((v.object_id IS NOT NULL) AND (s.section_object_id = v.object_id))) obj ON (true));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| public     | view_project_tree_with_loadings                |  SELECT sh.project_id,
    sh.project_name,
    sh.project_description,
    sh.project_status,
    sh.project_created,
    sh.project_updated,
    sh.stage_id,
    sh.stage_name,
    sh.stage_description,
    sh.object_id,
    sh.object_name,
    sh.object_description,
    sh.object_start_date,
    sh.object_end_date,
    sh.object_created,
    sh.object_updated,
    sh.section_id,
    sh.section_name,
    sh.section_description,
    sh.section_type,
    sh.section_start_date,
    sh.section_end_date,
    sh.section_created,
    sh.section_updated,
    sh.section_responsible_id,
    sh.section_responsible_name,
    sh.section_responsible_email,
    sh.responsible_department_id,
    sh.responsible_department_name,
    sh.responsible_team_id,
    sh.responsible_team_name,
    sh.total_loading_rate AS section_total_loading_rate,
    sh.tasks_count AS section_tasks_count,
    sh.latest_plan_loading_status,
    sh.section_responsible_avatar,
    ds.decomposition_stage_id,
    ds.decomposition_stage_name,
    ds.decomposition_stage_description,
    ds.decomposition_stage_start,
    ds.decomposition_stage_finish,
    ds.decomposition_stage_order,
    ds.decomposition_stage_status_id,
    ds.created_at AS decomposition_stage_created_at,
    ds.updated_at AS decomposition_stage_updated_at,
    st_status.name AS decomposition_stage_status_name,
    st_status.color AS decomposition_stage_status_color,
    l.loading_id,
    l.loading_start,
    l.loading_finish,
    l.loading_rate,
    l.loading_status,
    l.is_shortage,
    l.loading_task,
    l.loading_comment,
    l.loading_created,
    l.loading_updated,
    l.loading_responsible AS loading_responsible_id,
    lp.first_name AS loading_responsible_first_name,
    lp.last_name AS loading_responsible_last_name,
        CASE
            WHEN ((lp.first_name IS NOT NULL) OR (lp.last_name IS NOT NULL)) THEN btrim(((COALESCE(lp.first_name, ''::text) || ' '::text) || COALESCE(lp.last_name, ''::text)))
            ELSE NULL::text
        END AS loading_responsible_full_name,
    lp.email AS loading_responsible_email,
    lp.avatar_url AS loading_responsible_avatar,
    lp.department_id AS loading_responsible_department_id,
    ld.department_name AS loading_responsible_department_name,
    lp.team_id AS loading_responsible_team_id,
    lt.team_name AS loading_responsible_team_name,
    l.shortage_department_id,
    sd.department_name AS shortage_department_name,
    l.shortage_team_id,
    st.team_name AS shortage_team_name
   FROM ((((((((view_section_hierarchy sh
     LEFT JOIN decomposition_stages ds ON ((ds.decomposition_stage_section_id = sh.section_id)))
     LEFT JOIN section_statuses st_status ON ((st_status.id = ds.decomposition_stage_status_id)))
     LEFT JOIN loadings l ON (((l.loading_stage = ds.decomposition_stage_id) OR ((ds.decomposition_stage_id IS NULL) AND (l.loading_stage IS NULL) AND (l.loading_section = sh.section_id)))))
     LEFT JOIN profiles lp ON ((lp.user_id = l.loading_responsible)))
     LEFT JOIN departments ld ON ((ld.department_id = lp.department_id)))
     LEFT JOIN teams lt ON ((lt.team_id = lp.team_id)))
     LEFT JOIN departments sd ON ((sd.department_id = l.shortage_department_id)))
     LEFT JOIN teams st ON ((st.team_id = l.shortage_team_id)))
  ORDER BY sh.project_name, sh.stage_name, sh.object_name, sh.section_name, ds.decomposition_stage_order, l.loading_start;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_projects_with_department_info             |  SELECT p.project_id,
    p.project_name,
    p.project_description,
    p.project_status,
    p.project_created,
    p.project_updated,
    array_agg(DISTINCT sh.responsible_department_id) FILTER (WHERE (sh.responsible_department_id IS NOT NULL)) AS department_ids,
    count(DISTINCT sh.section_id) AS sections_count
   FROM (projects p
     LEFT JOIN view_section_hierarchy sh ON ((sh.project_id = p.project_id)))
  WHERE (p.project_status = 'active'::project_status_enum)
  GROUP BY p.project_id, p.project_name, p.project_description, p.project_status, p.project_created, p.project_updated
  ORDER BY p.project_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | view_section_analytics                         |  WITH l_by_section AS (
         SELECT COALESCE(l1.loading_section, t.task_parent_section) AS section_id,
            sum(COALESCE(l1.loading_rate, (0)::numeric)) AS current_total_rate,
            count(DISTINCT l1.loading_responsible) AS people_on_loadings
           FROM (loadings l1
             LEFT JOIN tasks t ON ((t.task_id = l1.loading_task)))
          WHERE ((l1.loading_status = 'active'::loading_status_type) AND (CURRENT_DATE >= l1.loading_start) AND (CURRENT_DATE <= l1.loading_finish))
          GROUP BY COALESCE(l1.loading_section, t.task_parent_section)
        ), days AS (
         SELECT (generate_series(((CURRENT_DATE - 9))::timestamp with time zone, (CURRENT_DATE)::timestamp with time zone, '1 day'::interval))::date AS d
        ), last10_reports AS (
         SELECT s1.section_id,
            jsonb_agg(jsonb_build_object('date', to_char((days.d)::timestamp with time zone, 'YYYY-MM-DD'::text), 'entries', COALESCE(( SELECT jsonb_agg(jsonb_build_object('name', t.name, 'hours', t.hours) ORDER BY t.hours DESC) AS jsonb_agg
                   FROM ( SELECT COALESCE(di.decomposition_item_description, '(без названия)'::text) AS name,
                            COALESCE(sum(wl.work_log_hours), (0)::numeric) AS hours
                           FROM (decomposition_items di
                             LEFT JOIN work_logs wl ON (((wl.decomposition_item_id = di.decomposition_item_id) AND (wl.work_log_date = days.d))))
                          WHERE (di.decomposition_item_section_id = s1.section_id)
                          GROUP BY COALESCE(di.decomposition_item_description, '(без названия)'::text)) t), '[]'::jsonb)) ORDER BY days.d) AS reports_last10
           FROM (sections s1
             CROSS JOIN days)
          GROUP BY s1.section_id
        ), last10_reports_totals AS (
         SELECT s1.section_id,
            jsonb_agg(jsonb_build_object('date', to_char((days.d)::timestamp with time zone, 'YYYY-MM-DD'::text), 'total_hours', COALESCE(( SELECT COALESCE(sum(wl.work_log_hours), (0)::numeric) AS "coalesce"
                   FROM (decomposition_items di
                     LEFT JOIN work_logs wl ON (((wl.decomposition_item_id = di.decomposition_item_id) AND (wl.work_log_date = days.d))))
                  WHERE (di.decomposition_item_section_id = s1.section_id)), (0)::numeric)) ORDER BY days.d) AS reports_last10_totals
           FROM (sections s1
             CROSS JOIN days)
          GROUP BY s1.section_id
        ), last10_assign_plan_events AS (
         SELECT s1.section_id,
            jsonb_agg(jsonb_build_object('date', to_char((days.d)::timestamp with time zone, 'YYYY-MM-DD'::text), 'events', COALESCE(( SELECT jsonb_agg(t.ev ORDER BY (t.ev ->> 'title'::text)) AS jsonb_agg
                   FROM ( SELECT jsonb_build_object('assignment_id', a.assignment_id, 'title', a.title, 'kind', 'planned_transfer', 'from_section_name', ( SELECT sections.section_name
                                   FROM sections
                                  WHERE (sections.section_id = a.from_section_id)), 'to_section_name', ( SELECT sections.section_name
                                   FROM sections
                                  WHERE (sections.section_id = a.to_section_id))) AS ev
                           FROM assignments a
                          WHERE (((a.to_section_id = s1.section_id) OR (a.from_section_id = s1.section_id)) AND (a.planned_transmitted_date = days.d))
                        UNION ALL
                         SELECT jsonb_build_object('assignment_id', a.assignment_id, 'title', a.title, 'kind', 'planned_completion', 'from_section_name', ( SELECT sections.section_name
                                   FROM sections
                                  WHERE (sections.section_id = a.from_section_id)), 'to_section_name', ( SELECT sections.section_name
                                   FROM sections
                                  WHERE (sections.section_id = a.to_section_id))) AS ev
                           FROM assignments a
                          WHERE (((a.to_section_id = s1.section_id) OR (a.from_section_id = s1.section_id)) AND ((
                                CASE
                                    WHEN (a.actual_transmitted_date IS NOT NULL) THEN a.actual_transmitted_date
                                    ELSE (a.created_at)::date
                                END + COALESCE(a.planned_duration, 7)) = days.d))) t), '[]'::jsonb)) ORDER BY days.d) AS assignment_plan_events_last10
           FROM (sections s1
             CROSS JOIN days)
          GROUP BY s1.section_id
        ), in_out AS (
         SELECT s1.section_id,
            count(a.assignment_id) FILTER (WHERE (a.to_section_id = s1.section_id)) AS incoming_assignments,
            count(a.assignment_id) FILTER (WHERE (a.from_section_id = s1.section_id)) AS outgoing_assignments
           FROM (sections s1
             LEFT JOIN assignments a ON (((a.to_section_id = s1.section_id) OR (a.from_section_id = s1.section_id))))
          GROUP BY s1.section_id
        )
 SELECT s.section_id,
        CASE
            WHEN (s.section_end_date IS NULL) THEN NULL::integer
            ELSE ((s.section_end_date)::date - CURRENT_DATE)
        END AS days_to_deadline,
    COALESCE(l.people_on_loadings, (0)::bigint) AS people_on_loadings,
    COALESCE(l.current_total_rate, (0)::numeric) AS current_total_rate,
    COALESCE(in_out.incoming_assignments, (0)::bigint) AS incoming_assignments,
    COALESCE(in_out.outgoing_assignments, (0)::bigint) AS outgoing_assignments,
    COALESCE(last10_reports.reports_last10, '[]'::jsonb) AS reports_last10,
    COALESCE(last10_assign_plan_events.assignment_plan_events_last10, '[]'::jsonb) AS assignment_plan_events_last10,
    COALESCE(last10_reports_totals.reports_last10_totals, '[]'::jsonb) AS reports_last10_totals
   FROM (((((sections s
     LEFT JOIN l_by_section l ON ((l.section_id = s.section_id)))
     LEFT JOIN in_out ON ((in_out.section_id = s.section_id)))
     LEFT JOIN last10_reports ON ((last10_reports.section_id = s.section_id)))
     LEFT JOIN last10_assign_plan_events ON ((last10_assign_plan_events.section_id = s.section_id)))
     LEFT JOIN last10_reports_totals ON ((last10_reports_totals.section_id = s.section_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| public     | view_section_comments_enriched                 |  SELECT sc.comment_id,
    sc.section_id,
    sc.author_id,
    sc.content,
    sc.mentions,
    sc.created_at,
    p.first_name,
    p.last_name,
    p.avatar_url,
    ((COALESCE(p.first_name, ''::text) || ' '::text) || COALESCE(p.last_name, ''::text)) AS author_name
   FROM (section_comments sc
     LEFT JOIN profiles p ON ((p.user_id = sc.author_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | view_section_decomposition_totals              |  SELECT s.section_id,
    (COALESCE(sum(di.decomposition_item_planned_hours), (0)::numeric))::numeric(10,2) AS planned_hours,
    (COALESCE(sum(wl.work_log_hours), (0)::numeric))::numeric(10,2) AS actual_hours,
    (COALESCE(sum(wl.work_log_amount), (0)::numeric))::numeric(14,2) AS actual_amount
   FROM ((sections s
     LEFT JOIN decomposition_items di ON ((di.decomposition_item_section_id = s.section_id)))
     LEFT JOIN work_logs wl ON ((wl.decomposition_item_id = di.decomposition_item_id)))
  GROUP BY s.section_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | view_section_hierarchy                         |  SELECT s.section_id,
    s.section_name,
    s.section_description,
    s.section_type,
    s.section_start_date,
    s.section_end_date,
    s.section_created,
    s.section_updated,
    o.object_id,
    o.object_name,
    o.object_description,
    o.object_start_date,
    o.object_end_date,
    o.object_created,
    o.object_updated,
    st.stage_id,
    st.stage_name,
    st.stage_description,
    p.project_id,
    p.project_name,
    p.project_description,
    p.project_status,
    p.project_created,
    p.project_updated,
    c.client_id,
    c.client_name,
    c.client_description,
    c.client_contact_person,
    c.client_phone,
    c.client_email,
    ple.user_id AS project_lead_engineer_id,
    ((ple.first_name || ' '::text) || ple.last_name) AS project_lead_engineer_name,
    pm.user_id AS project_manager_id,
    ((pm.first_name || ' '::text) || pm.last_name) AS project_manager_name,
    resp.user_id AS section_responsible_id,
    ((resp.first_name || ' '::text) || resp.last_name) AS section_responsible_name,
    resp.email AS section_responsible_email,
    d.department_id AS responsible_department_id,
    d.department_name AS responsible_department_name,
    t.team_id AS responsible_team_id,
    t.team_name AS responsible_team_name,
    COALESCE(( SELECT sum(l.loading_rate) AS sum
           FROM (loadings l
             LEFT JOIN decomposition_stages ds ON ((ds.decomposition_stage_id = l.loading_stage)))
          WHERE (((l.loading_stage IS NOT NULL) AND (ds.decomposition_stage_section_id = s.section_id)) OR ((l.loading_stage IS NULL) AND (l.loading_section = s.section_id)))), (0)::numeric) AS total_loading_rate,
    COALESCE(( SELECT count(*) AS count
           FROM tasks t_1
          WHERE (t_1.task_parent_section = s.section_id)), (0)::bigint) AS tasks_count,
    COALESCE(( SELECT x.plan_loading_status
           FROM ( SELECT pl.plan_loading_status,
                    pl.plan_loading_created
                   FROM (plan_loadings pl
                     JOIN decomposition_stages ds ON ((ds.decomposition_stage_id = pl.plan_loading_stage)))
                  WHERE (ds.decomposition_stage_section_id = s.section_id)
                UNION ALL
                 SELECT pl.plan_loading_status,
                    pl.plan_loading_created
                   FROM plan_loadings pl
                  WHERE ((pl.plan_loading_stage IS NULL) AND (pl.plan_loading_section = s.section_id))) x
          ORDER BY x.plan_loading_created DESC NULLS LAST
         LIMIT 1), 'нет'::character varying) AS latest_plan_loading_status,
    ple.avatar_url AS project_lead_engineer_avatar,
    pm.avatar_url AS project_manager_avatar,
    resp.avatar_url AS section_responsible_avatar
   FROM (((((((((sections s
     LEFT JOIN objects o ON ((s.section_object_id = o.object_id)))
     LEFT JOIN stages st ON ((o.object_stage_id = st.stage_id)))
     LEFT JOIN projects p ON ((s.section_project_id = p.project_id)))
     LEFT JOIN clients c ON ((p.client_id = c.client_id)))
     LEFT JOIN profiles resp ON ((s.section_responsible = resp.user_id)))
     LEFT JOIN profiles ple ON ((p.project_lead_engineer = ple.user_id)))
     LEFT JOIN profiles pm ON ((p.project_manager = pm.user_id)))
     LEFT JOIN departments d ON ((resp.department_id = d.department_id)))
     LEFT JOIN teams t ON ((resp.team_id = t.team_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_sections_with_loadings                    |  SELECT s.section_id,
    s.section_name,
    s.object_id,
    s.object_name,
    s.stage_id,
    s.stage_name,
    s.project_id,
    s.project_name,
    s.client_id,
    s.client_name,
    s.project_lead_engineer_name,
    s.project_manager_name,
    s.section_responsible_id,
    s.section_responsible_name,
    s.responsible_department_id,
    s.responsible_department_name,
    s.responsible_team_id,
    s.responsible_team_name,
    s.total_loading_rate,
    s.tasks_count,
    s.latest_plan_loading_status,
    s.section_start_date,
    s.section_end_date,
    l.loading_id,
    l.loading_responsible,
    l.loading_stage,
    l.loading_start,
    l.loading_finish,
    l.loading_rate,
    l.loading_status,
    l.loading_created,
    l.loading_updated,
    p.first_name AS responsible_first_name,
    p.last_name AS responsible_last_name,
        CASE
            WHEN (l.loading_id IS NOT NULL) THEN true
            ELSE false
        END AS has_loadings,
    count(l.loading_id) OVER (PARTITION BY s.section_id) AS loadings_count,
    s.project_lead_engineer_avatar,
    s.project_manager_avatar,
    s.section_responsible_avatar,
    p.avatar_url AS responsible_avatar,
    l.loading_comment
   FROM ((view_section_hierarchy s
     LEFT JOIN loadings l ON ((((l.loading_stage IS NOT NULL) AND (l.loading_stage IN ( SELECT dsx.decomposition_stage_id
           FROM decomposition_stages dsx
          WHERE (dsx.decomposition_stage_section_id = s.section_id)))) OR ((l.loading_stage IS NULL) AND (l.loading_section = s.section_id)))))
     LEFT JOIN profiles p ON ((l.loading_responsible = p.user_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| public     | view_stage_difficulty_pivot                    |  WITH base AS (
         SELECT view_stage_difficulty_stats.stage_id,
            view_stage_difficulty_stats.difficulty_id,
            view_stage_difficulty_stats.difficulty_abbr,
            view_stage_difficulty_stats.difficulty_definition,
            view_stage_difficulty_stats.difficulty_weight,
            view_stage_difficulty_stats.items_count,
            view_stage_difficulty_stats.planned_hours,
            view_stage_difficulty_stats.weighted_hours
           FROM view_stage_difficulty_stats
        )
 SELECT base.stage_id,
    jsonb_object_agg(base.difficulty_abbr, base.items_count ORDER BY base.difficulty_weight, base.difficulty_abbr) AS counts_by_difficulty,
    jsonb_object_agg(base.difficulty_abbr, base.planned_hours ORDER BY base.difficulty_weight, base.difficulty_abbr) AS hours_by_difficulty,
    jsonb_object_agg(base.difficulty_abbr, base.weighted_hours ORDER BY base.difficulty_weight, base.difficulty_abbr) AS weighted_hours_by_difficulty,
    sum(base.items_count) AS items_total,
    sum(base.planned_hours) AS planned_hours_total,
    sum(base.weighted_hours) AS weighted_hours_total
   FROM base
  GROUP BY base.stage_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public     | view_stage_difficulty_stats                    |  WITH levels AS (
         SELECT ddl.difficulty_id,
            ddl.difficulty_abbr,
            ddl.difficulty_definition,
            ddl.difficulty_weight
           FROM decomposition_difficulty_levels ddl
        UNION ALL
         SELECT NULL::uuid AS difficulty_id,
            'UNK'::text AS difficulty_abbr,
            'Без уровня сложности'::text AS difficulty_definition,
            (0)::smallint AS difficulty_weight
        )
 SELECT s.decomposition_stage_id AS stage_id,
    l.difficulty_id,
    l.difficulty_abbr,
    l.difficulty_definition,
    l.difficulty_weight,
    count(di.decomposition_item_id) AS items_count,
    (COALESCE(sum(di.decomposition_item_planned_hours), (0)::numeric))::numeric(12,2) AS planned_hours,
    (COALESCE(sum((di.decomposition_item_planned_hours * (l.difficulty_weight)::numeric)), (0)::numeric))::numeric(12,2) AS weighted_hours
   FROM ((decomposition_stages s
     CROSS JOIN levels l)
     LEFT JOIN decomposition_items di ON (((di.decomposition_item_stage_id = s.decomposition_stage_id) AND ((di.decomposition_item_difficulty_id = l.difficulty_id) OR ((di.decomposition_item_difficulty_id IS NULL) AND (l.difficulty_id IS NULL))))))
  GROUP BY s.decomposition_stage_id, l.difficulty_id, l.difficulty_abbr, l.difficulty_definition, l.difficulty_weight;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | view_stage_employee_loadings                   |  SELECT s.section_id,
    s.section_name,
    s.project_id,
    s.project_name,
    s.object_id,
    s.object_name,
    s.stage_id,
    s.stage_name,
    s.client_id,
    s.client_name,
    s.project_lead_engineer_name,
    s.project_manager_name,
    s.section_responsible_id,
    s.section_responsible_name,
    s.responsible_department_id,
    s.responsible_department_name,
    s.responsible_team_id,
    s.responsible_team_name,
    s.total_loading_rate,
    s.tasks_count,
    s.latest_plan_loading_status,
    s.section_start_date,
    s.section_end_date,
    l.loading_id,
    l.loading_responsible,
    l.loading_start,
    l.loading_finish,
    l.loading_rate,
    l.loading_status,
    l.loading_created,
    l.loading_updated,
    p.first_name AS responsible_first_name,
    p.last_name AS responsible_last_name,
    s.project_lead_engineer_avatar,
    s.project_manager_avatar,
    s.section_responsible_avatar,
    p.avatar_url AS responsible_avatar,
    l.loading_comment
   FROM ((view_section_hierarchy s
     LEFT JOIN loadings l ON ((((l.loading_stage IS NOT NULL) AND (l.loading_stage IN ( SELECT dsx.decomposition_stage_id
           FROM decomposition_stages dsx
          WHERE (dsx.decomposition_stage_section_id = s.section_id)))) OR ((l.loading_stage IS NULL) AND (l.loading_section = s.section_id)))))
     LEFT JOIN profiles p ON ((l.loading_responsible = p.user_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| public     | view_subdivisions_with_heads                   |  SELECT s.subdivision_id,
    s.subdivision_name,
    s.subdivision_head_id,
    s.created_at,
    s.updated_at,
    concat(p.first_name, ' ', p.last_name) AS head_name,
    p.email AS head_email,
    p.avatar_url AS head_avatar_url,
    ( SELECT count(*) AS count
           FROM departments d
          WHERE (d.subdivision_id = s.subdivision_id)) AS departments_count,
    ( SELECT count(*) AS count
           FROM profiles pr
          WHERE (pr.subdivision_id = s.subdivision_id)) AS employees_count
   FROM (subdivisions s
     LEFT JOIN profiles p ON ((s.subdivision_head_id = p.user_id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_team_leads                                |  SELECT t.team_id,
    t.team_name,
    d.department_name,
    t.team_lead_id AS user_id,
    p.first_name,
    p.last_name,
    p.email,
    p.avatar_url
   FROM ((teams t
     JOIN departments d ON ((t.department_id = d.department_id)))
     LEFT JOIN profiles p ON ((t.team_lead_id = p.user_id)))
  WHERE ((t.team_name <> 'Без команды'::text) AND (t.team_lead_id IS NOT NULL));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | view_teams_with_leads                          |  SELECT t.team_id,
    t.team_name,
    t.department_id,
    COALESCE(d.department_name, 'Не назначен'::text) AS department_name,
    t.team_lead_id,
    p.first_name AS team_lead_first_name,
    p.last_name AS team_lead_last_name,
    concat(p.first_name, ' ', p.last_name) AS team_lead_full_name,
    p.email AS team_lead_email,
    p.avatar_url AS team_lead_avatar_url
   FROM ((teams t
     LEFT JOIN departments d ON ((t.department_id = d.department_id)))
     LEFT JOIN profiles p ON ((t.team_lead_id = p.user_id)))
  ORDER BY t.team_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| public     | view_user_effective_permissions                |  WITH user_permissions AS (
         SELECT ur.user_id,
            p.name AS permission_name
           FROM ((user_roles ur
             JOIN role_permissions rp ON ((ur.role_id = rp.role_id)))
             JOIN permissions p ON ((rp.permission_id = p.id)))
        ), admin_users AS (
         SELECT DISTINCT ur.user_id
           FROM (user_roles ur
             JOIN roles r ON ((ur.role_id = r.id)))
          WHERE (r.name = 'admin'::text)
        )
 SELECT u.user_id,
        CASE
            WHEN (au.user_id IS NOT NULL) THEN ( SELECT array_agg(permissions.name ORDER BY permissions.name) AS array_agg
               FROM permissions)
            ELSE COALESCE(array_agg(DISTINCT up.permission_name ORDER BY up.permission_name), ARRAY[]::text[])
        END AS effective_permissions
   FROM ((( SELECT DISTINCT user_roles.user_id
           FROM user_roles) u
     LEFT JOIN admin_users au ON ((u.user_id = au.user_id)))
     LEFT JOIN user_permissions up ON ((u.user_id = up.user_id)))
  GROUP BY u.user_id, au.user_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| public     | view_user_has_permission                       |  SELECT ur.user_id,
    p.name AS permission_name,
    true AS has_permission
   FROM ((user_roles ur
     JOIN role_permissions rp ON ((ur.role_id = rp.role_id)))
     JOIN permissions p ON ((rp.permission_id = p.id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| public     | view_user_permissions                          |  SELECT DISTINCT ur.user_id,
    p.name AS permission_name
   FROM ((user_roles ur
     JOIN role_permissions rp ON ((ur.role_id = rp.role_id)))
     JOIN permissions p ON ((rp.permission_id = p.id)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| public     | view_user_permissions_fast                     |  SELECT ur.user_id,
    array_agg(DISTINCT p.name ORDER BY p.name) AS permissions
   FROM ((user_roles ur
     JOIN role_permissions rp ON ((ur.role_id = rp.role_id)))
     JOIN permissions p ON ((rp.permission_id = p.id)))
  GROUP BY ur.user_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_user_reports_with_authors                 |  SELECT ur.user_report_id,
    ur.user_report_short_description,
    ur.user_report_detailed_description,
    ur.user_report_created_by,
    ur.user_report_created_at,
    p.first_name AS author_first_name,
    p.last_name AS author_last_name,
        CASE
            WHEN ((p.first_name IS NOT NULL) AND (p.first_name <> ''::text) AND (p.last_name IS NOT NULL) AND (p.last_name <> ''::text)) THEN concat(p.first_name, ' ', p.last_name)
            WHEN ((p.first_name IS NOT NULL) AND (p.first_name <> ''::text)) THEN p.first_name
            WHEN ((p.last_name IS NOT NULL) AND (p.last_name <> ''::text)) THEN p.last_name
            ELSE split_part(p.email, '@'::text, 1)
        END AS author_full_name,
    p.email AS author_email,
    p.avatar_url AS author_avatar_url,
    pos.position_name AS author_position_name,
    dept.department_name AS author_department_name,
    team.team_name AS author_team_name
   FROM ((((user_reports ur
     LEFT JOIN profiles p ON ((ur.user_report_created_by = p.user_id)))
     LEFT JOIN positions pos ON ((p.position_id = pos.position_id)))
     LEFT JOIN departments dept ON ((p.department_id = dept.department_id)))
     LEFT JOIN teams team ON ((p.team_id = team.team_id)))
  ORDER BY ur.user_report_created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| public     | view_user_roles                                |  SELECT ur.user_id,
    ur.role_id,
    r.name AS role_name,
    r.description AS role_description,
    ur.assigned_at,
    ur.assigned_by,
    concat(p_assigned.first_name, ' ', p_assigned.last_name) AS assigned_by_name
   FROM ((user_roles ur
     JOIN roles r ON ((ur.role_id = r.id)))
     LEFT JOIN profiles p_assigned ON ((ur.assigned_by = p_assigned.user_id)))
  ORDER BY ur.user_id, ur.assigned_at;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| public     | view_users                                     |  SELECT p.user_id,
    p.first_name,
    p.last_name,
    p.email,
    p.created_at,
    p.work_format,
    p.employment_rate,
    p.salary,
    p.is_hourly,
    p.avatar_url,
    p.department_id,
    d.department_name,
    p.team_id,
    t.team_name,
    p.position_id,
    pos.position_name,
    p.category_id,
    c.category_name,
    sub.subdivision_id,
    sub.subdivision_name,
    NULL::uuid AS role_id,
        CASE
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'admin'::text)))) THEN 'admin'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'department_head'::text)))) THEN 'department_head'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'team_lead'::text)))) THEN 'team_lead'::text
            WHEN (EXISTS ( SELECT 1
               FROM (user_roles ur2
                 JOIN roles r2 ON ((r2.id = ur2.role_id)))
              WHERE ((ur2.user_id = p.user_id) AND (r2.name = 'user'::text)))) THEN 'user'::text
            ELSE NULL::text
        END AS role_name,
    NULL::text AS role_description,
    p.city_id,
    ci.name AS city_name,
    co.id AS country_id,
    co.name AS country_name,
    concat(p.first_name, ' ', p.last_name) AS full_name,
        CASE
            WHEN (p.user_id IS NOT NULL) THEN true
            ELSE false
        END AS is_active,
    string_agg(DISTINCT ur_role.name, ', '::text ORDER BY ur_role.name) AS roles_display_string,
    count(DISTINCT ur.role_id) AS roles_count,
    (count(DISTINCT ur.role_id) > 1) AS has_multiple_roles
   FROM (((((((((profiles p
     LEFT JOIN departments d ON ((p.department_id = d.department_id)))
     LEFT JOIN subdivisions sub ON ((d.subdivision_id = sub.subdivision_id)))
     LEFT JOIN teams t ON ((p.team_id = t.team_id)))
     LEFT JOIN positions pos ON ((p.position_id = pos.position_id)))
     LEFT JOIN categories c ON ((p.category_id = c.category_id)))
     LEFT JOIN cities ci ON ((p.city_id = ci.id)))
     LEFT JOIN countries co ON ((ci.country_id = co.id)))
     LEFT JOIN user_roles ur ON ((p.user_id = ur.user_id)))
     LEFT JOIN roles ur_role ON ((ur.role_id = ur_role.id)))
  GROUP BY p.user_id, p.first_name, p.last_name, p.email, p.created_at, p.work_format, p.employment_rate, p.salary, p.is_hourly, p.avatar_url, p.department_id, d.department_name, p.team_id, t.team_name, p.position_id, pos.position_name, p.category_id, c.category_name, sub.subdivision_id, sub.subdivision_name, p.city_id, ci.name, co.id, co.name
  ORDER BY p.last_name, p.first_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| public     | view_users_with_details                        |  SELECT p.user_id,
    p.first_name,
    p.last_name,
    p.email,
    p.avatar_url,
    p.department_id,
    p.team_id,
    d.department_name,
    t.team_name,
    pos.position_name,
    c.category_name
   FROM ((((profiles p
     LEFT JOIN departments d ON ((p.department_id = d.department_id)))
     LEFT JOIN teams t ON ((p.team_id = t.team_id)))
     LEFT JOIN positions pos ON ((p.position_id = pos.position_id)))
     LEFT JOIN categories c ON ((p.category_id = c.category_id)))
  ORDER BY p.last_name, p.first_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| public     | view_work_logs_enriched                        |  SELECT wl.work_log_id,
    wl.work_log_created_at,
    wl.work_log_date,
    wl.work_log_hours,
    wl.work_log_hourly_rate,
    wl.work_log_amount,
    wl.work_log_description,
    wl.decomposition_item_id,
    di.decomposition_item_description,
    di.decomposition_item_section_id AS section_id,
    s.section_name,
    s.section_object_id AS object_id,
    o.object_name,
    o.object_stage_id AS stage_id,
    st.stage_name,
    s.section_project_id AS project_id,
    pr.project_name,
    di.decomposition_item_work_category_id AS work_category_id,
    wc.work_category_name,
    wl.work_log_created_by AS author_id,
    p.first_name,
    p.last_name,
    p.avatar_url,
    ((COALESCE(p.first_name, ''::text) || ' '::text) || COALESCE(p.last_name, ''::text)) AS author_name,
    di.decomposition_item_stage_id AS decomposition_stage_id,
    ds.decomposition_stage_name
   FROM ((((((((work_logs wl
     LEFT JOIN decomposition_items di ON ((di.decomposition_item_id = wl.decomposition_item_id)))
     LEFT JOIN decomposition_stages ds ON ((ds.decomposition_stage_id = di.decomposition_item_stage_id)))
     LEFT JOIN sections s ON ((s.section_id = di.decomposition_item_section_id)))
     LEFT JOIN objects o ON ((o.object_id = s.section_object_id)))
     LEFT JOIN stages st ON ((st.stage_id = o.object_stage_id)))
     LEFT JOIN projects pr ON ((pr.project_id = s.section_project_id)))
     LEFT JOIN work_categories wc ON ((wc.work_category_id = di.decomposition_item_work_category_id)))
     LEFT JOIN profiles p ON ((p.user_id = wl.work_log_created_by)));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| vault      | decrypted_secrets                              |  SELECT s.id,
    s.name,
    s.description,
    s.secret,
    convert_from(vault._crypto_aead_det_decrypt(message => decode(s.secret, 'base64'::text), additional => convert_to((s.id)::text, 'utf8'::name), key_id => (0)::bigint, context => '\x7067736f6469756d'::bytea, nonce => s.nonce), 'utf8'::name) AS decrypted_secret,
    s.key_id,
    s.nonce,
    s.created_at,
    s.updated_at
   FROM vault.secrets s;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |