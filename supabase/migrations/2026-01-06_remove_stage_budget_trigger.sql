-- ============================================================================
-- Миграция: Удаление триггера бюджета со стадий (stages)
-- Дата: 2026-01-06
-- ============================================================================
--
-- ПРОБЛЕМА:
-- Триггер trg_create_default_budget_stage на таблице stages вызывает функцию
-- create_default_budget_trigger(), которая не умеет обрабатывать таблицу stages.
-- Это приводит к ошибке "Unknown table: stages" при создании стадий.
--
-- ПРИЧИНА:
-- - В enum budget_entity_type нет значения 'stage'
-- - В функции create_default_budget_trigger нет CASE для 'stages'
-- - Триггер был добавлен по ошибке или остался после рефакторинга
--
-- РЕШЕНИЕ:
-- Удалить триггер. Стадии (stages) не должны иметь бюджетов.
-- Стадия проекта теперь хранится как параметр stage_type в таблице projects.
--
-- БЕЗОПАСНОСТЬ:
-- - В таблице budgets нет записей с entity_type = 'stage' (проверено)
-- - Нет RLS политик ссылающихся на stage (проверено)
-- - Удаление триггера не затронет существующие данные
--
-- ============================================================================

-- Удаляем триггер создания бюджета при добавлении стадии
DROP TRIGGER IF EXISTS trg_create_default_budget_stage ON stages;

-- Добавляем комментарий для документации
COMMENT ON TABLE stages IS 'Стадии проекта (ПД, РД, ИИ). Бюджеты для стадий не предусмотрены - используйте stage_type в таблице projects.';
