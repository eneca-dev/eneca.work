# Optimistic Updates для чекпоинтов

## Что было сделано

Улучшена архитектура модалок чекпоинтов для использования optimistic updates из cache-модуля.

## Изменения

### CheckpointEditModal

**Удалено:**
- Локальный `optimisticCompleted` state (дублировал функциональность хука)
- Сложная логика синхронизации статуса выполнения

**Упрощено:**
- `handleSave` - модалка закрывается СРАЗУ, обновление происходит в фоне с optimistic update
- `handleToggleComplete` - использует `completeCheckpoint.mutate()` без локального state
- `handleConfirmDelete` - модалка закрывается СРАЗУ при удалении, чекпоинт исчезает мгновенно
- `canSave` валидация - убрана проверка `completedChanged`
- Рендеринг кнопки выполнения - напрямую использует `checkpoint.completed_at` вместо `optimisticCompleted`

### CheckpointCreateModal

**Улучшено:**
- Модалка закрывается СРАЗУ при нажатии "Создать"
- Чекпоинт появляется на графике мгновенно с временным ID
- Создание происходит в фоне, temporary item заменяется реальным после ответа сервера

## Как работают Optimistic Updates

### Архитектура

```
Модалка (UI)
    ↓ mutate()
Хук (useUpdateCheckpoint)
    ↓ merge функция (optimistic)
TanStack Query кеш (мгновенное обновление UI)
    ↓ mutationFn
Server Action (реальный запрос к БД)
    ↓ onSuccess
TanStack Query (замена optimistic данными на реальные)
```

### Хуки с Optimistic Updates

Все хуки уже настроены в `modules/checkpoints/hooks/use-checkpoints.ts`:

1. **useUpdateCheckpoint** - обновление данных чекпоинта
   - Мгновенно обновляет `title`, `description`, `checkpoint_date`, `icon`, `color` в кеше
   - Использует `merge` функцию для применения изменений

2. **useCompleteCheckpoint** - отметка выполнения
   - Мгновенно обновляет `completed_at`, `completed_by`, `status` в кеше
   - Вычисляет статус на основе даты дедлайна

3. **useDeleteCheckpoint** - удаление чекпоинта
   - Мгновенно удаляет чекпоинт из списка в кеше
   - При ошибке откатывает изменения

### Автоматическая инвалидация кеша

После успешной мутации автоматически инвалидируются:
- `queryKeys.checkpoints.all` - списки чекпоинтов
- `queryKeys.sections.all` - разделы (счетчики чекпоинтов)
- `queryKeys.resourceGraph.all` - графики ресурсов (timeline)

## Преимущества

1. **Мгновенный отклик UI** - пользователь видит изменения сразу
2. **Меньше кода в модалках** - логика вынесена в хуки
3. **Консистентность** - один источник правды для optimistic updates
4. **Автоматический откат** - при ошибке TanStack Query откатывает изменения
5. **Меньше багов** - нет дублирования state между модалкой и хуками

## Тестирование

### Сценарии для проверки

1. **Создание чекпоинта:**
   - Открыть модалку создания
   - Заполнить поля, нажать "Создать"
   - ✅ Модалка закрылась МГНОВЕННО
   - ✅ Чекпоинт появился на графике СРАЗУ
   - Подождать 1-2 сек
   - ✅ Чекпоинт остался на месте (ID сменился с temp на реальный)

2. **Редактирование чекпоинта:**
   - Открыть модалку редактирования
   - Изменить название/дату/описание
   - Нажать "Сохранить"
   - ✅ Модалка закрылась МГНОВЕННО
   - ✅ Изменения применились на графике СРАЗУ
   - Подождать 1-2 сек
   - ✅ Изменения остались (данные синхронизированы с сервером)

3. **Отметка выполнения:**
   - В модалке редактирования нажать кнопку выполнения
   - ✅ Иконка меняется мгновенно (модалка НЕ закрывается - это правильно)
   - ✅ Статус обновляется
   - На графике чекпоинт тоже обновился

4. **Удаление чекпоинта:**
   - В модалке редактирования нажать "Удалить"
   - Подтвердить удаление
   - ✅ Модалка закрылась МГНОВЕННО
   - ✅ Чекпоинт исчез с графика СРАЗУ
   - Подождать 1-2 сек
   - ✅ Чекпоинт не вернулся (удаление успешно)

5. **Откат при ошибке:**
   - Симулировать ошибку сети (отключить интернет)
   - Создать/изменить/удалить чекпоинт
   - ✅ Модалка закрылась, UI обновился
   - Включить интернет
   - ✅ Через 1-2 сек изменения откатились
   - ⚠️ Пока нет toast-уведомления (TODO)

## Связанные файлы

- `modules/checkpoints/hooks/use-checkpoints.ts` - хуки с optimistic updates
- `modules/checkpoints/actions/checkpoints.ts` - server actions
- `modules/modals/components/checkpoint/CheckpointEditModal.tsx` - модалка редактирования
- `modules/modals/components/checkpoint/CheckpointCreateModal.tsx` - модалка создания
- `modules/cache/README.md` - документация cache-модуля

## Дальнейшие улучшения (опционально)

1. **Optimistic Create** - можно добавить optimistic update при создании чекпоинта
2. **Loading States** - добавить skeleton loaders на время мутаций
3. **Error Toasts** - показывать toast-уведомления при ошибках
4. **Retry Logic** - автоматический retry для failed mutations
