# Система фильтров в модуле планирования

## Обзор

Система фильтров в модуле планирования представляет собой унифицированное решение для фильтрации данных по различным критериям. Она построена на архитектуре Zustand store и обеспечивает реактивную работу с фильтрами в различных компонентах системы.

## Архитектура

### Основные компоненты

1. **FilterStore** - централизованное состояние фильтров
2. **FilterSelect** - базовый компонент для выбора фильтра
3. **TimelineFilters** - компонент фильтров для таймлайна
4. **Конфигурации** - настройки фильтров для разных модулей

### Типы данных

```typescript
interface FilterOption {
  id: string
  name: string
  departmentId?: string // для команд
  managerId?: string    // для проектов
}

interface FilterState {
  selectedProjectId: string | null
  selectedDepartmentId: string | null
  selectedTeamId: string | null
  selectedManagerId: string | null
  selectedEmployeeId: string | null
  selectedStageId: string | null
  selectedObjectId: string | null
}
```

## FilterStore

### Основные возможности

1. **Управление состоянием** - хранение выбранных фильтров
2. **Загрузка данных** - асинхронная загрузка из Supabase
3. **Зависимости** - автоматическое управление связанными фильтрами
4. **Персистентность** - сохранение состояния в localStorage
5. **Права доступа** - блокировка фильтров по ролям

### Иерархия зависимостей

```
Менеджер → Проект → Стадия → Объект
Отдел → Команда → Сотрудник
```

### Методы

#### initialize(config: FilterConfigs)
Инициализирует стор с конфигурацией и загружает базовые данные.

#### setFilter(type: string, value: string | null)
Устанавливает значение фильтра и обновляет зависимые фильтры:
- При выборе менеджера загружаются его проекты
- При выборе проекта загружаются его стадии
- При выборе стадии загружаются её объекты
- При выборе отдела загружаются его команды

#### resetFilters()
Сбрасывает все фильтры, учитывая заблокированные по ролям.

#### isFilterLocked(type: string)
Проверяет, заблокирован ли фильтр для текущего пользователя:
- **Проект-менеджер**: заблокирован фильтр "Менеджер"
- **Руководитель отдела**: заблокирован фильтр "Отдел"
- **Тимлид**: заблокированы фильтры "Отдел" и "Команда"

### Методы загрузки данных

#### loadManagers()
Загружает список менеджеров из `view_manager_projects`.

#### loadProjects(managerId?: string)
Загружает проекты, опционально отфильтрованные по менеджеру.

#### loadStages(projectId: string)
Загружает стадии для конкретного проекта.

#### loadObjects(stageId: string)
Загружает объекты для конкретной стадии.

#### loadDepartments()
Загружает отделы и команды из `view_organizational_structure`.

#### loadEmployees()
Загружает сотрудников из `view_employee_workloads`.

## Конфигурации

### planningConfig
Полная конфигурация для модуля планирования:
- Менеджер → Проект → Стадия → Объект
- Отдел → Команда → Сотрудник

### timelineConfig
Конфигурация для таймлайна:
- Менеджер → Проект → Стадия
- Отдел → Команда

### workloadConfig
Конфигурация для рабочей нагрузки:
- Отдел → Команда → Сотрудник
- Проект (независимо)

### userConfig
Конфигурация для управления пользователями:
- Отдел → Команда

## Компоненты

### FilterSelect

Базовый компонент для выбора значения фильтра.

**Пропсы:**
```typescript
interface FilterSelectProps {
  id: string           // уникальный идентификатор
  label: string        // подпись фильтра
  value: string | null // выбранное значение
  onChange: (value: string | null) => void // обработчик изменения
  disabled?: boolean   // отключен ли фильтр
  locked?: boolean     // заблокирован ли по роли
  options: FilterOption[] // варианты для выбора
  placeholder: string  // текст-заглушка
  theme?: 'light' | 'dark' // тема оформления
  loading?: boolean    // состояние загрузки
}
```

**Особенности:**
- Поддержка светлой и темной тем
- Индикатор блокировки (замок)
- Индикатор загрузки (спиннер)
- Состояния: обычное, отключенное, заблокированное, загружающееся

### TimelineFilters

Компонент фильтров для модуля таймлайна.

**Возможности:**
- Двухуровневая сетка фильтров
- Кнопка сброса фильтров
- Управление видимостью отделов
- Автоматическая синхронизация с родительским компонентом

## Система прав доступа

### Роли и ограничения

1. **Топ-менеджер** - доступны все фильтры
2. **Проект-менеджер** - заблокирован выбор менеджера (видит только свои проекты)
3. **Руководитель отдела** - заблокирован выбор отдела (видит только свой отдел)
4. **Тимлид** - заблокированы отдел и команда (видит только свою команду)

## Интеграция с базой данных

### Используемые представления

1. **view_manager_projects** - менеджеры и их проекты
2. **view_organizational_structure** - организационная структура
3. **view_employee_workloads** - сотрудники и их нагрузка

### Таблицы

1. **projects** - проекты
2. **stages** - стадии проектов
3. **objects** - объекты стадий

## Примеры использования

### Инициализация в компоненте

```typescript
import { useFilterStore } from '@/modules/planning/filters'
import { timelineConfig } from '@/modules/planning/filters/configs'

function TimelineComponent() {
  const { initialize, selectedProjectId } = useFilterStore()
  
  useEffect(() => {
    initialize(timelineConfig)
  }, [])
  
  // Компонент автоматически получает обновления при изменении фильтров
}
```

### Создание кастомного фильтра

```typescript
import { FilterSelect } from '@/modules/planning/filters'

function CustomFilter() {
  const { managers, selectedManagerId, setFilter } = useFilterStore()
  
  return (
    <FilterSelect
      id="manager"
      label="Менеджер проекта"
      value={selectedManagerId}
      onChange={(value) => setFilter('manager', value)}
      options={managers}
      placeholder="Выберите менеджера"
    />
  )
}
```

## Производительность

### Оптимизации

1. **Мемоизация** - фильтрованные данные кэшируются
2. **Ленивая загрузка** - данные загружаются только при необходимости
3. **Персистентность** - состояние сохраняется между сессиями
4. **Дебаунсинг** - предотвращение множественных запросов

### Рекомендации

1. Используйте конфигурации вместо прямого обращения к стору
2. Инициализируйте фильтры в useEffect
3. Избегайте частых сбросов фильтров
4. Учитывайте состояния загрузки в UI

## Расширение системы

### Добавление нового фильтра

1. Добавьте тип в `FilterState`
2. Создайте метод загрузки данных
3. Обновите конфигурацию
4. Добавьте логику зависимостей в `setFilter`

### Создание новой конфигурации

```typescript
export const customConfig: FilterConfigs = {
  newFilter: {
    id: 'newFilter',
    label: 'Новый фильтр',
    dependencies: ['otherFilter'],
    fetchFunction: 'loadNewFilterData'
  }
}
```

## Troubleshooting

### Частые проблемы

1. **Фильтры не загружаются** - проверьте инициализацию стора
2. **Зависимости не работают** - убедитесь в правильности конфигурации
3. **Состояние не сохраняется** - проверьте настройки persist
4. **Права доступа не применяются** - проверьте настройки ролей пользователя

### Отладка

```typescript
// Включить логирование в devtools
const store = useFilterStore()
console.log('Filter state:', store.getState())
```
