# План реализации: Этап 2 — Увеличение минимальной высоты полоски загрузки

## Цель
Увеличить минимальную высоту полоски загрузки, чтобы гарантировать читаемость текста даже при минимальной ставке (rate = 0.1).

## Проблема
**Текущее состояние:**
- `BASE_BAR_HEIGHT = 56` пикселей (высота для ставки 1.0)
- Высота для ставки 0.1: `56 * 0.1 = 5.6px` — **недостаточно для текста 10px**
- Текст в полосках: `text-[10px]` и `text-[9px]` (10-9 пикселей)
- Полоска не может отобразить текст при малых ставках
- **Дублирование кода:** константы определены в двух местах (department-row.tsx и section-loading-bars.tsx)

**Требуемое состояние:**
- Минимальная высота полоски для rate = 0.1 должна быть **не менее 14px** (для комфортного отображения текста 10px с padding)
- **Новое значение:** `BASE_BAR_HEIGHT = 140` пикселей
  - rate = 0.1 → `140 * 0.1 = 14px` ✅
  - rate = 0.25 → `140 * 0.25 = 35px` ✅
  - rate = 0.5 → `140 * 0.5 = 70px` ✅
  - rate = 1.0 → `140 * 1.0 = 140px` ✅
- **Устранить дублирование:** вынести константы в loading-bars-utils.ts

## Затрагиваемые файлы

### Файлы для изменения:
1. [modules/planning/components/timeline/loading-bars-utils.ts](modules/planning/components/timeline/loading-bars-utils.ts) — добавить экспорт констант
2. [modules/planning/components/timeline/department-row.tsx:683-684](modules/planning/components/timeline/department-row.tsx#L683-L684) — заменить на импорт
3. [modules/planning/components/timeline/section-loading-bars.tsx:26-27](modules/planning/components/timeline/section-loading-bars.tsx#L26-L27) — заменить на импорт

## Детальный план реализации

### Шаг 1: Вынести константы в loading-bars-utils.ts (рефакторинг)

**Файл:** [modules/planning/components/timeline/loading-bars-utils.ts](modules/planning/components/timeline/loading-bars-utils.ts)

**Изменение:** Добавить экспорт констант в начало файла (после импортов, перед интерфейсами):

```typescript
// После строки 4 (после импортов) добавить:

/**
 * Константы для расчёта высоты и позиционирования полосок загрузки
 */
export const BASE_BAR_HEIGHT = 140 // Базовая высота полоски для ставки 1.0
export const BAR_GAP = 3 // Минимальное расстояние между полосками при стакинге
```

**Обоснование:**
- Это центральный файл с утилитами для работы с полосками загрузок
- Уже содержит функции `calculateBarTop`, которые используют эти константы как параметры
- Устраняет дублирование кода между `department-row.tsx` и `section-loading-bars.tsx`

---

### Шаг 2: Обновить department-row.tsx (импорт вместо определения)

**Файл:** [modules/planning/components/timeline/department-row.tsx:683-684](modules/planning/components/timeline/department-row.tsx#L683-L684)

**Изменение 1:** Добавить импорт в блок импортов (строка 16-25):

```typescript
import {
  loadingsToPeriods,
  calculateBarRenders,
  calculateBarTop,
  splitPeriodByNonWorkingDays,
  formatBarLabel,
  formatBarTooltip,
  getBarLabelParts,
  BASE_BAR_HEIGHT,  // ← ДОБАВИТЬ
  BAR_GAP,          // ← ДОБАВИТЬ
  type BarPeriod,
} from "./loading-bars-utils"
```

**Изменение 2:** Удалить локальные определения констант (строки 683-684):

```typescript
// УДАЛИТЬ эти строки:
const BASE_BAR_HEIGHT = 56 // Высота для полной ставки (rate = 1)
const BAR_GAP = 3 // Минимальное расстояние между полосками
```

**Затронутые использования (автоматически подхватят новое значение):**
- Строка 694: `barHeight = BASE_BAR_HEIGHT * (bar.period.rate || 1)`
- Строка 697: `calculateBarTop(bar, barRenders, BASE_BAR_HEIGHT, BAR_GAP, 8)`
- Строка 849: `const barHeight = BASE_BAR_HEIGHT * (bar.period.rate || 1)`
- Строка 852: `calculateBarTop(bar, barRenders, BASE_BAR_HEIGHT, BAR_GAP, 8)`

---

### Шаг 3: Обновить section-loading-bars.tsx (импорт вместо определения)

**Файл:** [modules/planning/components/timeline/section-loading-bars.tsx:26-27](modules/planning/components/timeline/section-loading-bars.tsx#L26-L27)

**Изменение 1:** Добавить импорт в блок импортов (строка 7-15):

```typescript
import {
  sectionLoadingsToPeriods,
  calculateSectionBarRenders,
  getSectionLoadingLabelParts,
  formatSectionLoadingTooltip,
  calculateBarTop,
  BASE_BAR_HEIGHT,  // ← ДОБАВИТЬ
  BAR_GAP,          // ← ДОБАВИТЬ
  type SectionLoadingPeriod,
  type BarRender,
} from "./loading-bars-utils"
```

**Изменение 2:** Удалить локальные определения констант (строки 26-27):

```typescript
// УДАЛИТЬ эти строки:
const BASE_BAR_HEIGHT = 56 // Базовая высота бара для ставки 1
const BAR_GAP = 3 // Отступ между барами
```

**Затронутые использования (автоматически подхватят новое значение):**
- Строка 66: `const barHeight = BASE_BAR_HEIGHT * (bar.period.rate || 1)`
- Строка 69: `const top = calculateBarTop(bar, barRenders, BASE_BAR_HEIGHT, BAR_GAP, 4)`
- Строка 233: `const barHeight = BASE_BAR_HEIGHT * (bar.period.rate || 1)`
- Строка 234: `const top = calculateBarTop(bar, barRenders, BASE_BAR_HEIGHT, BAR_GAP, 4)`

---

### Шаг 4: Проверить логику maxLines (адаптивное количество строк текста)

**Файл:** [modules/planning/components/timeline/department-row.tsx:894-899](modules/planning/components/timeline/department-row.tsx#L894-L899)

**Текущая логика:**
```typescript
let maxLines = 3 // По умолчанию 3 строки

if (rate < 0.5) {
  maxLines = 1 // rate < 0.5 → высота < 28px (старое) / < 70px (новое) → 1 строка
} else if (rate < 1) {
  maxLines = 2 // rate < 1 → высота < 56px (старое) / < 140px (новое) → 2 строки
}
```

**Проверка после изменения BASE_BAR_HEIGHT = 140:**
- rate < 0.5 → высота < 70px → `maxLines = 1` ✅ (достаточно для 1 строки текста)
- rate < 1 → высота < 140px → `maxLines = 2` ✅ (достаточно для 2 строк текста)
- rate = 1 → высота = 140px → `maxLines = 3` ✅ (достаточно для 3 строк текста)

**Вывод:** Логика `maxLines` **остаётся корректной**, изменений не требуется. Пороги 0.5 и 1.0 — относительные (в процентах от полной ставки), поэтому они не зависят от абсолютного значения `BASE_BAR_HEIGHT`.

---

### Шаг 5: Проверить padding и размеры текста

**Файл:** [modules/planning/components/timeline/department-row.tsx:872-876](modules/planning/components/timeline/department-row.tsx#L872-L876)

**Текущие параметры:**
```typescript
paddingLeft: "6px",
paddingRight: "6px",
paddingTop: "4px",
paddingBottom: "4px",
```

**Размеры текста:**
- `text-[10px]` — основной текст (10 пикселей)
- `text-[9px]` — вторичная информация (9 пикселей)

**Проверка для минимальной ставки (rate = 0.1, высота = 14px):**
- Общая высота бара: 14px
- Доступное пространство для текста: `14 - 4 (top) - 4 (bottom) = 6px`
- Размер текста: 10px
- **Проблема:** 6px недостаточно для 10px текста — текст будет обрезан

**Решение:** Уменьшить вертикальный padding для малых полосок.

**Рекомендация:**
- При rate < 0.2 (высота < 28px) использовать минимальный padding: `paddingTop: "2px"`, `paddingBottom: "2px"`
- Доступное пространство: `14 - 2 - 2 = 10px` — **достаточно для текста 10px** ✅

**Изменение (опционально, если потребуется после визуального тестирования):**

В компоненте `EmployeeRow`, в месте рендера бара (строки 872-876), заменить фиксированные значения padding на динамические:

```typescript
// Было:
paddingLeft: "6px",
paddingRight: "6px",
paddingTop: "4px",
paddingBottom: "4px",

// Станет:
const rate = bar.period.rate || 1
const verticalPadding = rate < 0.2 ? 2 : 4

paddingLeft: "6px",
paddingRight: "6px",
paddingTop: `${verticalPadding}px`,
paddingBottom: `${verticalPadding}px`,
```

**Примечание:** Это изменение **опционально**. Сначала проверим визуально после изменения `BASE_BAR_HEIGHT`. Если текст читается нормально, можно оставить без изменений.

---

### Шаг 6: Проверить визуальные пропорции в UI

**После изменения BASE_BAR_HEIGHT = 140:**
1. Полоски станут **выше в 2.5 раза** (140/56 = 2.5)
2. Строки сотрудников также станут выше (через `actualRowHeight`)
3. Визуальный эффект:
   - Больше пространства для текста (улучшенная читаемость)
   - Более заметные полоски (легче различать загрузки)
   - Возможно потребуется увеличить размер зазоров (`BAR_GAP`) для лучшей визуальной читаемости

**Тестирование визуала (после реализации):**
- Открыть страницу планирования в браузере
- Проверить отображение полосок с разными ставками:
  - rate = 0.1 → высота 14px (минимальная)
  - rate = 0.25 → высота 35px
  - rate = 0.5 → высота 70px
  - rate = 1.0 → высота 140px (полная ставка)
- Убедиться, что:
  - Текст читается во всех случаях ✅
  - Полоски не перекрывают друг друга некорректно ✅
  - Высота строк адаптируется правильно ✅
  - Общий вид таймлайна сбалансирован ✅

**Возможные корректировки (если потребуется):**
- Увеличить `BAR_GAP` с 3px до 4-5px (для лучшего визуального разделения)
- Скорректировать padding для очень маленьких полосок (см. Шаг 5)
- Подкорректировать размеры текста (если нужно)

---

### Шаг 7: Запустить проверку типов и сборку

**Команды:**
```bash
npm run build
```

**Ожидаемый результат:**
- ✅ TypeScript компиляция проходит без ошибок
- ✅ Сборка проекта успешна
- ✅ Все импорты и экспорты корректны

---

## Критерии готовности

### Обязательные изменения:
- [ ] Константы `BASE_BAR_HEIGHT = 140` и `BAR_GAP = 3` добавлены в `loading-bars-utils.ts` (экспорт)
- [ ] В `department-row.tsx` удалены локальные константы и добавлен импорт из `loading-bars-utils.ts`
- [ ] В `section-loading-bars.tsx` удалены локальные константы и добавлен импорт из `loading-bars-utils.ts`
- [ ] Логика `maxLines` проверена — корректна для новых высот (изменений не требуется)
- [ ] `npm run build` проходит успешно без ошибок

### Тестирование:
- [ ] Визуальное отображение проверено для всех ставок:
  - [ ] rate = 0.1 → высота 14px (текст читается)
  - [ ] rate = 0.25 → высота 35px (текст читается)
  - [ ] rate = 0.5 → высота 70px (текст читается)
  - [ ] rate = 1.0 → высота 140px (текст читается)
- [ ] Высота строк сотрудников корректно адаптируется под новые высоты баров
- [ ] Полоски корректно стакируются (не перекрывают друг друга)
- [ ] Общий вид таймлайна сбалансирован

### Опциональные корректировки (при необходимости):
- [ ] Padding для малых полосок настроен (если текст обрезается при rate < 0.2)
- [ ] `BAR_GAP` увеличен до 4-5px (если полоски визуально слишком плотно прилегают)

---

## Преимущества рефакторинга

1. **Единая точка изменения:** Константы определены в одном месте (`loading-bars-utils.ts`)
2. **DRY-принцип:** Устранено дублирование кода между двумя компонентами
3. **Лёгкость изменений:** Любое будущее изменение `BASE_BAR_HEIGHT` или `BAR_GAP` требует правки только одного файла
4. **Консистентность:** Гарантируется, что все компоненты используют одинаковые значения

---

## Риски и ограничения

1. **Визуальные пропорции:** Полоски станут выше в 2.5 раза (140/56), что изменит общий вид таймлайна — требуется визуальное тестирование
2. **Padding минимальных полосок:** При rate < 0.2 текущий padding (4px) может быть избыточным — может потребоваться адаптивный padding
3. **Зазор между полосками:** При новых высотах может потребоваться увеличить `BAR_GAP` для лучшей визуальной читаемости

---

## Порядок выполнения

1. **Рефакторинг:** Вынести константы в `loading-bars-utils.ts` (Шаг 1)
2. **Обновление импортов:** Заменить локальные определения на импорт в `department-row.tsx` (Шаг 2)
3. **Обновление импортов:** Заменить локальные определения на импорт в `section-loading-bars.tsx` (Шаг 3)
4. **Проверка логики:** Убедиться, что `maxLines` работает корректно (Шаг 4) — изменений не требуется
5. **Сборка:** Запустить `npm run build` (Шаг 7)
6. **Визуальное тестирование:** Проверить отображение в браузере (Шаг 6)
7. **Опциональные корректировки:** Если требуется, настроить padding или зазоры (Шаг 5)
