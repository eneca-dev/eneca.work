# Загрузка и создание аватара пользователя

## Общее описание функционала

Функционал загрузки и создания аватара позволяет пользователям загружать фотографии для создания персонализированного аватара. Загруженное изображение обрабатывается, обрезается до квадратного формата, а затем отправляется на сервер для дальнейшей обработки нейросетью.

Процесс взаимодействия пользователя с функционалом включает следующие этапы:
1. Наведение мыши на текущий аватар (или пустой аватар)
2. Появление иконки загрузки
3. Открытие диалогового окна для загрузки фотографии
4. Выбор изображения с устройства
5. Предпросмотр обрезанного изображения
6. Согласие на обработку фотографии нейросетью
7. Отправка изображения на сервер
8. Уведомление о результате операции

## Файловая структура

### Компоненты пользовательского интерфейса
- `modules/users/components/avatar-uploader.tsx` - Компонент, заменяющий стандартный аватар и обеспечивающий интерактивность (затемнение при наведении, отображение иконки загрузки)
- `modules/users/components/avatar-upload-dialog.tsx` - Диалоговое окно с формой загрузки фотографии, информацией о требованиях, предпросмотром и элементами управления

### Интеграция с UI
- `modules/users/components/current-user-card.tsx` - Карточка текущего пользователя, в которую интегрирован компонент AvatarUploader

### Управление состоянием
- `stores/useUserStore.ts` - Хранилище данных пользователя с методом updateAvatar для обновления URL аватара в профиле

### Типы данных
- `types/db.ts` - Содержит определение типа User и таблицы profiles с полем avatar для хранения URL изображения

## Процесс создания аватара

### Подготовка изображения
1. Пользователь загружает фотографию в поддерживаемом формате (JPEG или PNG)
2. Изображение автоматически обрезается до квадратного формата 1024×1024 пикселей с сохранением центральной части
3. Пользователь видит предпросмотр обрезанного изображения и может удалить его для выбора другого

### Требования к изображению
- Четкое и крупное изображение лица
- На фотографии должен быть только один человек
- Поддерживаемые форматы: JPEG и PNG
- Правильная ориентация изображения

### Обработка на сервере
1. После загрузки изображение отправляется на специальный эндпоинт
2. Нейросеть обрабатывает фотографию для создания аватара
3. Результат сохраняется в хранилище Supabase и ссылка на аватар записывается в профиль пользователя

### Ограничения
- Повторная загрузка аватара доступна не ранее чем через 15 минут после предыдущей
- Пользователь должен дать согласие на обработку фотографии нейросетью

## Технические детали

### Обработка изображения
- Для обрезки изображения используется Canvas API, который позволяет программно манипулировать изображением
- Центральная часть изображения сохраняется, чтобы фокус оставался на лице пользователя
- Готовое изображение конвертируется в Blob для отправки на сервер

### Хранение данных
- URL аватара хранится в профиле пользователя в поле avatar
- Изображения аватаров хранятся в Supabase Storage по пути, включающему ID пользователя

### Обновление интерфейса
- После успешной загрузки и обработки аватар автоматически обновляется в интерфейсе
- Пользователь получает уведомление об успешной обработке через toast-сообщение

## Будущие улучшения
- Добавление возможности кадрирования изображения перед загрузкой
- Предоставление нескольких вариантов аватара, созданных нейросетью
- Расширение поддерживаемых форматов изображений
- Интеграция с внешними сервисами для создания аватаров

## План интеграции загрузки аватара с Edge Function Supabase

### Цель
Реализовать отправку изображения пользователя из клиентских компонентов (`current-user-card.tsx`, `avatar-uploader.tsx`, `avatar-upload-dialog.tsx`) напрямую в Edge Function Supabase (`generate-avatar-from-photo`). Получить обработанный нейросетью аватар и обновить профиль пользователя.

### Шаги доработки

1. **Изменить логику отправки аватара**
   - В компоненте `avatar-upload-dialog.tsx` реализовать отправку изображения (Blob) через HTTP POST на endpoint Edge Function `/functions/v1/generate-avatar-from-photo`.
   - Использовать `fetch` с передачей изображения в формате `multipart/form-data` (ключ — `avatar`).
   - Передавать access_token пользователя в заголовке Authorization для идентификации.

2. **Обработка ответа от Edge Function**
   - В Edge Function уже реализована обработка изображения, генерация аватара и сохранение в Supabase Storage.
   - В ответе функция возвращает публичный URL аватара и user_id.
   - В компоненте после успешного ответа вызывать onAvatarUploaded с новым URL.

3. **Обновление профиля пользователя**
   - После получения URL аватара обновлять поле avatar в профиле пользователя через Supabase (таблица profiles).
   - Использовать существующий метод updateAvatar из useUserStore для синхронизации состояния.

4. **Ограничения и UX**
   - Сохранять логику ограничения повторной загрузки (15 минут).
   - Отображать пользователю статус загрузки и возможные ошибки (например, если Edge Function вернула ошибку).

5. **Безопасность**
   - Передавать access_token только по HTTPS.
   - Проверять, что пользователь может загружать аватар только для своего профиля.

### Пример запроса к Edge Function
```ts
const formData = new FormData();
formData.append("avatar", blob, "avatar.png");
const resp = await fetch("/functions/v1/generate-avatar-from-photo", {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${access_token}`
  },
  body: formData
});
const data = await resp.json();
if (data.success && data.url) {
  // обновить профиль пользователя с новым avatar url
}
```

### Итог
После внедрения данной интеграции процесс загрузки аватара будет полностью автоматизирован: пользователь загружает фото, оно отправляется в Edge Function, обрабатывается нейросетью, результат сохраняется в Supabase Storage, а профиль пользователя обновляется с новым URL аватара.
