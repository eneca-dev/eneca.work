# Географическая фильтрация уведомлений

## Обзор

Система уведомлений поддерживает фильтрацию по географическим критериям:
- Фильтрация по городам
- Фильтрация по странам
- Комбинированная фильтрация

## Структура БД

### Связи между таблицами
```
profiles.city_id -> cities.id
cities.country_id -> countries.id
```

### Таблицы
- `countries` - страны
- `cities` - города
- `profiles` - профили пользователей

## API функции

### Фильтрация по городам

#### `sendNotificationToCity()`
Отправляет уведомление всем пользователям из указанного города.

**Параметры:**
- `entityType` - тип сущности
- `payload` - данные уведомления
- `cityId` - ID города

**Пример:**
```typescript
await sendNotificationToCity(
  'city_maintenance',
  {
    title: 'Плановое обслуживание',
    message: 'Завтра в Киеве будет проводиться плановое обслуживание серверов',
    type: 'warning'
  },
  '550e8400-e29b-41d4-a716-446655440000'
);
```

#### `notifyAnnouncementToCity()`
Удобная функция для отправки объявлений пользователям из города.

**Параметры:**
- `title` - заголовок объявления
- `content` - текст объявления
- `cityId` - ID города

**Пример:**
```typescript
await notifyAnnouncementToCity(
  'Офисное мероприятие',
  'Приглашаем всех киевских сотрудников на корпоратив',
  '550e8400-e29b-41d4-a716-446655440000'
);
```

### Фильтрация по странам

#### `sendNotificationToCountry()`
Отправляет уведомление всем пользователям из указанной страны.

**Параметры:**
- `entityType` - тип сущности
- `payload` - данные уведомления
- `countryId` - ID страны

**Пример:**
```typescript
await sendNotificationToCountry(
  'country_announcement',
  {
    title: 'Новое законодательство',
    message: 'Изменения в трудовом законодательстве с 1 января',
    type: 'info'
  },
  '223e8400-e29b-41d4-a716-446655440000'
);
```

#### `notifyAnnouncementToCountry()`
Удобная функция для отправки объявлений пользователям из страны.

**Параметры:**
- `title` - заголовок объявления
- `content` - текст объявления
- `countryId` - ID страны

**Пример:**
```typescript
await notifyAnnouncementToCountry(
  'Национальный праздник',
  'Поздравляем с национальным праздником!',
  '223e8400-e29b-41d4-a716-446655440000'
);
```

## Комбинированная фильтрация

### Город + отдел
```typescript
await sendNotificationByFilters(
  'department_city_announcement',
  {
    title: 'Встреча IT-отдела в Киеве',
    message: 'Завтра в 15:00 встреча всех разработчиков в киевском офисе'
  },
  {
    departmentId: 'dev-dept-123',
    cityId: '550e8400-e29b-41d4-a716-446655440000'
  }
);
```

### Страна + формат работы
```typescript
await sendNotificationByFilters(
  'remote_workers_country',
  {
    title: 'Налоговые изменения',
    message: 'Изменения в налогообложении для удаленных работников'
  },
  {
    countryId: '223e8400-e29b-41d4-a716-446655440000',
    workFormat: 'remote'
  }
);
```

## Использование через Edge Function

### Отправка уведомления по городу

```http
POST /functions/v1/notifications
Content-Type: application/json

{
  "entityType": "city_event",
  "payload": {
    "title": "Городское мероприятие",
    "message": "Завтра в Киеве пройдет конференция по IT",
    "type": "info"
  },
  "filters": {
    "cityId": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

### Отправка уведомления по стране

```http
POST /functions/v1/notifications
Content-Type: application/json

{
  "entityType": "country_policy",
  "payload": {
    "title": "Новая политика компании",
    "message": "Изменения в политике для сотрудников Украины",
    "type": "info"
  },
  "filters": {
    "countryId": "223e8400-e29b-41d4-a716-446655440000"
  }
}
```

## Практические примеры

### Уведомления для региональных менеджеров
```typescript
// Отправить уведомление всем менеджерам в Киеве
await sendNotificationByFilters(
  'manager_meeting',
  {
    title: 'Совещание менеджеров',
    message: 'Завтра в 10:00 совещание всех менеджеров в киевском офисе'
  },
  {
    positionId: 'manager-position-id',
    cityId: '550e8400-e29b-41d4-a716-446655440000'
  }
);
```

### Уведомления о технических работах
```typescript
// Уведомить всех пользователей из украинских городов
await sendNotificationByFilters(
  'maintenance_ukraine',
  {
    title: 'Техническое обслуживание',
    message: 'Плановые работы с 23:00 до 06:00',
    type: 'warning'
  },
  {
    countryId: '223e8400-e29b-41d4-a716-446655440000'
  }
);
```

### Локализованные объявления
```typescript
// Объявление для команды в определенном городе
await sendNotificationByFilters(
  'team_city_announcement',
  {
    title: 'Корпоратив команды',
    message: 'Приглашаем всех членов команды на корпоратив в нашем офисе'
  },
  {
    teamId: 'team-123',
    cityId: '550e8400-e29b-41d4-a716-446655440000'
  }
);
```

## Рекомендации

1. **Используйте географическую фильтрацию для:**
   - Локальных объявлений
   - Региональных политик
   - Уведомлений о технических работах
   - Офисных мероприятий

2. **Комбинируйте фильтры для точной настройки:**
   - Город + отдел
   - Страна + роль
   - Город + формат работы

3. **Учитывайте временные зоны:**
   - При отправке уведомлений в разные города
   - Для планирования мероприятий 