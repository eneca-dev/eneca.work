# Компонент списка разделов (SectionsList)

## Общее описание

страница `SectionsList` предназначена для отображения списка разделов системы планирования. Раздел представляет собой логическую единицу работы или группу работ в проекте. Компонент позволяет просматривать, фильтровать и сортировать разделы, а также отображает таймлайн загрузки ресурсов для каждого раздела.

## Функциональность

### Основные возможности

1. **Отображение списка разделов**
   - Список содержит название раздела, описание, проект и ответственного
   - Для каждого раздела отображается визуальный индикатор прогресса (на основе выполненных задач)
   - Таймлайн загрузки ресурсов отображается для каждого раздела
   - Дополнительная информация о договоре, объекте и стадии отображается для каждого раздела

2. **Фильтрация**
   - По ответственным (section_responsible)
   - По проектам (section_parent_project)
   - По периоду времени для таймлайна (диапазон дат)
   - По номеру договора, объекту или стадии

3. **Сортировка**
   - По названию (section_name)
   - По дате создания (section_created)
   - По дате обновления (section_updated)
   - По загрузке ресурсов (суммарная загрузка)
   - По договору, объекту или стадии

4. **Поиск**
   - Полнотекстовый поиск по названию и описанию раздела, а также по договору, объекту и стадии

### Взаимодействие с данными

1. **Получение данных**
   - Данные разделов загружаются из таблицы `sections` в Supabase
   - Данные загрузок загружаются из таблицы `loadings` в Supabase
   - Используется пагинация для оптимизации загрузки

2. **Обновление данных**
   - Периодическое обновление данных для отображения актуального состояния
   - Обновление при применении фильтров или смене периода таймлайна

## Макет (Layout)

### Общая структура

Компонент имеет двухпанельную структуру с горизонтальным разделением:

1. **Левая панель - Таблица разделов**
   - Отображается как отдельный вертикальный элемент
   - Содержит список разделов в табличном формате
   - Включает следующие колонки:
     - Наименование раздела (крайний левый столбец)
     - Проект
     - Стадия
     - Объект
    

2. **Правая панель - Таймлайн**
   - Напротив каждого раздела отображается строка таймлайна с ячейками, представляющими дни
   - Таймлайн горизонтально синхронизирован со строками разделов
   - Шапка таймлайна содержит иерархическую структуру: месяцы, недели, дни

### Табличная часть

- Таблица с разделами имеет фиксированную ширину
- Колонки могут быть настроены (скрыты/показаны) пользователем
- Каждая строка соответствует одному разделу
- При наличии нескольких загрузок для раздела, они отображаются как дополнительные строки в таймлайне, cтрока расширяется по вертикали
- Строки можно группировать по проекту, стадии или договору

### Взаимодействие компонентов

- При прокрутке списка разделов, таймлайн синхронно прокручивается по вертикали
- При прокрутке таймлайна по горизонтали, табличная часть остается фиксированной
- Выделение раздела в таблице подсвечивает соответствующую строку в таймлайне
- Фильтрация влияет на обе части компонента одновременно

## Таймлайн загрузки ресурсов

### Описание
Таймлайн представляет собой иерархическую календарную сетку, показывающую загрузки ресурсов для каждого раздела. Он имеет фиксированный масштаб с ячейками строго определенной ширины и отображает столько дней, сколько позволяет ширина экрана.

### Особенности таймлайна
1. **Структура таймлайна**
   - Фиксированный масштаб с иерархическим отображением:
     - Верхний уровень: месяцы
     - Средний уровень: недели
     - Нижний уровень: дни
   - Дни имеют фиксированную узкую ширину (не меняется при изменении размера экрана)
   - При увеличении ширины экрана отображается больше дней, а не меняется размер ячеек
   - Текущий день всегда выделяется
   - Каждая ячейка дня содержит значение загрузки ресурса (в процентах)
   - Кнопки навигации позволяют перемещаться вперед/назад по таймлайну на 10 дней

2. **Представление загрузок**
   - Если в разделе несколько загрузок, они отображаются отдельными строками
   - Каждая строка соответствует одной загрузке
   - Для каждого раздела отображаются дополнительные параметры:
     - Договор (номер договора)
     - Объект (название объекта)
     - Стадия (буквенное обозначение стадии)

3. **Визуальное представление**
   - Заполненные ячейки закрашиваются цветом в зависимости от значения загрузки
   - Градиент цвета отражает интенсивность загрузки (от светлого к темному)
   - Незаполненные ячейки остаются пустыми
   - Месяцы и недели визуально разделяются для лучшей читаемости (разделительные линии, цветовое выделение)

4. **Взаимодействие**
   - При клике на пустую ячейку - создание новой загрузки на этот день
   - При клике на заполненную ячейку - редактирование существующей загрузки
   - При наведении на ячейку - отображение подробной информации о загрузке
   - Кнопки "Назад" и "Вперед" позволяют сдвигать видимый диапазон на 10 дней

## Интерфейс API

### Входные параметры (props)

```typescript
interface SectionsListProps {
  // Начальные фильтры
  initialFilters?: {
    projectIds?: string[]; // IDs проектов для фильтрации
    responsibleIds?: string[]; // IDs ответственных
    dateRange?: {
      start: Date; // Начальная дата для таймлайна
      end: Date; // Конечная дата для таймлайна
    };
    contract?: string; // Фильтр по номеру договора
    object?: string; // Фильтр по объекту
    stage?: string; // Фильтр по стадии
  };
  
  // Настройки таймлайна
  timelineOptions?: {
    highlightWeekends: boolean; // Выделять ли выходные дни
    dayWidth: number; // Фиксированная ширина ячейки дня в пикселях (по умолчанию 24px)
    navigationStep: number; // Шаг навигации при использовании кнопок вперед/назад (по умолчанию 10 дней)
  };
  
  // Настройки макета
  layoutOptions?: {
    tableColumns?: {
      id: string;
      title: string;
      visible: boolean;
      width?: number;
    }[]; // Конфигурация столбцов таблицы
    tableWidth?: number; // Фиксированная ширина табличной части
    expandedGroups?: string[]; // Раскрытые группы при группировке
    groupBy?: 'project' | 'stage' | 'contract' | null; // Группировка по полю
  };
  
  // Колбэк при выборе раздела
  onSectionSelect?: (sectionId: string) => void;
  
  // Колбэк при создании/изменении загрузки
  onLoadingChange?: (loading: Loading) => void;
  
  // Количество элементов на странице
  pageSize?: number;
  
  // Флаг автообновления данных
  autoRefresh?: boolean;
  
  // Интервал автообновления в мс
  refreshInterval?: number;
}
```

### События

1. `onSectionSelect`: Вызывается при выборе раздела пользователем
2. `onFilterChange`: Внутреннее событие, обновляющее состояние фильтров
3. `onSortChange`: Внутреннее событие, изменяющее порядок сортировки
4. `onLoadingCreate`: Вызывается при создании новой загрузки
5. `onLoadingUpdate`: Вызывается при обновлении существующей загрузки
6. `onLoadingDelete`: Вызывается при удалении загрузки
7. `onDateRangeChange`: Вызывается при изменении диапазона дат таймлайна
8. `onNavigateTimeline`: Вызывается при навигации по таймлайну с помощью кнопок
9. `onColumnVisibilityChange`: Вызывается при изменении видимости колонок таблицы
10. `onGroupByChange`: Вызывается при изменении группировки разделов

## Модель данных

Компонент взаимодействует со следующей структурой данных из Supabase:

```typescript
interface Section {
  section_id: string; // UUID раздела
  section_name: string; // Название раздела
  section_description: string; // Описание раздела
  section_responsible: string | null; // UUID ответственного
  section_parent_project: string; // UUID родительского проекта
  section_created: string; // Дата создания
  section_updated: string; // Дата обновления
  
  // Дополнительные параметры (не привязаны к базе данных)
  contract_number?: string; // Номер договора
  object_name?: string; // Название объекта
  stage_code?: string; // Буквенное обозначение стадии
}

interface Project {
  project_id: string; // UUID проекта
  project_name: string; // Название проекта
  project_description: string; // Описание проекта
  project_manager: string | null; // UUID менеджера проекта
  project_lead_engineer: string | null; // UUID ведущего инженера
  project_status: 'active' | 'completed' | 'cancelled'; // Статус проекта
  project_created: string; // Дата создания
  project_updated: string; // Дата обновления
}

interface Task {
  task_id: string; // UUID задачи
  task_name: string; // Название задачи
  task_description: string; // Описание задачи
  task_responsible: string | null; // UUID ответственного
  task_parent_section: string; // UUID родительского раздела
  task_created: string; // Дата создания
  task_updated: string; // Дата обновления
  task_completed: string | null; // Дата завершения
}

interface Loading {
  loading_id: string; // UUID загрузки
  loading_responsible: string; // UUID ответственного
  loading_section: string; // UUID раздела
  loading_start: string; // Дата и время начала загрузки
  loading_finish: string; // Дата и время окончания загрузки
  loading_rate: number; // Процент загрузки ресурса (0-1)
  loading_created: string; // Дата и время создания записи
  loading_updated: string; // Дата и время обновления записи
}
```

## Состояния и управление данными

Компонент использует Zustand для управления внутренним состоянием:

```typescript
interface SectionsListState {
  // Данные
  sections: Section[];
  projects: Project[];
  loadings: Loading[];
  isLoading: boolean;
  error: string | null;
  
  // Пагинация
  currentPage: number;
  totalPages: number;
  pageSize: number;
  
  // Фильтры
  filters: {
    projectIds: string[];
    responsibleIds: string[];
    searchQuery: string;
    dateRange: {
      start: Date;
      end: Date;
    };
    contract: string | null;
    object: string | null;
    stage: string | null;
  };
  
  // Таймлайн
  highlightWeekends: boolean;
  dayWidth: number; // Фиксированная ширина ячейки дня в пикселях
  visibleDaysCount: number; // Количество видимых дней (рассчитывается из ширины контейнера)
  containerWidth: number; // Доступная ширина контейнера таймлайна
  navigationStep: number; // Шаг навигации по таймлайну (по умолчанию 10 дней)
  
  // Параметры макета
  tableColumns: {
    id: string;
    title: string;
    visible: boolean;
    width: number;
  }[]; // Конфигурация колонок таблицы
  tableWidth: number; // Ширина табличной части
  groupBy: 'project' | 'stage' | 'contract' | null; // Группировка
  expandedGroups: string[]; // Раскрытые группы
  
  // Сортировка
  sortField: 'section_name' | 'section_created' | 'section_updated' | 'loading_rate' | 'contract_number' | 'object_name' | 'stage_code';
  sortDirection: 'asc' | 'desc';
  
  // Действия
  fetchSections: () => Promise<void>;
  fetchProjects: () => Promise<void>;
  fetchLoadings: (sectionIds: string[]) => Promise<void>;
  setFilters: (filters: Partial<Filters>) => void;
  setSorting: (field: SortField, direction: 'asc' | 'desc') => void;
  setPage: (page: number) => void;
  selectSection: (sectionId: string) => void;
  setDateRange: (start: Date, end: Date) => void;
  setContainerWidth: (width: number) => void; // Установка доступной ширины контейнера
  navigateTimeline: (direction: 'forward' | 'backward') => void; // Навигация по таймлайну
  
  // Действия с макетом
  setTableColumns: (columns: TableColumn[]) => void; // Обновление конфигурации колонок
  setTableWidth: (width: number) => void; // Установка ширины таблицы
  setGroupBy: (field: 'project' | 'stage' | 'contract' | null) => void; // Установка группировки
  toggleGroupExpand: (groupId: string) => void; // Переключение раскрытия группы
  
  // Действия с загрузками
  createLoading: (loading: Omit<Loading, 'loading_id' | 'loading_created' | 'loading_updated'>) => Promise<void>;
  updateLoading: (loading: Partial<Loading> & { loading_id: string }) => Promise<void>;
  deleteLoading: (loadingId: string) => Promise<void>;
  
  // Действия с дополнительными параметрами раздела
  updateSectionParams: (sectionId: string, params: {
    contract_number?: string;
    object_name?: string;
    stage_code?: string;
  }) => Promise<void>;
}
```

## UI компоненты

1. **Главный контейнер**
   - Двухпанельная структура с горизонтальным разделением
   - Левая панель: таблица разделов
   - Правая панель: таймлайн загрузки

2. **Панель фильтров (верхняя часть)**
   - Выпадающие списки для проектов и ответственных
   - Поле поиска
   - Выбор диапазона дат для таймлайна
   - Фильтры по договору, объекту и стадии
   - Кнопки управления группировкой и видимостью колонок

3. **Таблица разделов (левая панель)**
   - Сортируемые заголовки колонок
   - Строки с данными о разделах
   - Основные колонки:
     - Наименование раздела
     - Проект
     - Стадия
     - Договор
     - Объект
   - Возможность группировки по ключевым полям
   - Возможность настройки видимости и ширины колонок

4. **Компонент таймлайна (правая панель)**
   - Иерархическая структура заголовков: 
     - Верхний ряд: месяцы
     - Средний ряд: недели
     - Нижний ряд: дни
   - Узкие ячейки дней с фиксированной шириной и индикацией загрузки
   - Группировка загрузок по отдельным строкам
   - Выделение текущего дня
   - Кнопки навигации для перемещения по таймлайну

5. **Панель управления таймлайном (верхняя часть правой панели)**
   - Кнопки навигации по таймлайну (вперед/назад на 10 дней)
   - Переключатель выделения выходных дней
   - Индикация текущего периода отображения

## Ограничения и особенности

1. По умолчанию загружается до 20 разделов на странице
2. При пустом списке отображается сообщение "Нет доступных разделов"
3. При ошибке загрузки показывается сообщение об ошибке и кнопка повтора
4. Для оптимизации производительности используется виртуализация списка при большом количестве элементов
5. Ширина ячеек дней в таймлайне фиксирована и не меняется при изменении размера экрана
6. Количество видимых дней в таймлайне зависит от доступной ширины экрана (чем шире экран, тем больше дней отображается)
7. Текущий день всегда выделяется в таймлайне
8. Каждая ячейка представляет один день и показывает значение загрузки в процентах
9. Несколько загрузок для одного раздела отображаются отдельными строками с отдельными параметрами
10. Навигация по таймлайну осуществляется с помощью кнопок, позволяющих перемещаться вперед и назад на фиксированное количество дней (по умолчанию 10)
11. Левая панель с таблицей разделов имеет фиксированную ширину, которую можно настраивать
12. Правая панель с таймлайном занимает все оставшееся пространство экрана
