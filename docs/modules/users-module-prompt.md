# Модуль управления пользователями

## Описание
Модуль отвечает за управление пользователями внутри приложения. Все действия по управлению пользователями осуществляются через интерфейс приложения. Модуль доступен из бокового меню (иконка пользователей вместо шестерёнки).

## Роли пользователей (Примеры наборов прав)
Система доступа основана на гранулярных разрешениях. Роли могут использоваться как удобные наборы этих разрешений, назначаемые пользователям. Примеры таких ролей:
- **Администратор приложения** — имеет все разрешения на управление пользователями и структурами.
- **Администратор отдела** — имеет разрешения на просмотр всех пользователей и редактирование пользователей своего отдела (`user.edit.department`).
- **Администратор команды** — имеет разрешения на просмотр всех пользователей и редактирование пользователей своей команды (`user.edit.team`).
- **Пользователь** — имеет разрешение только на редактирование своего профиля (`user.edit.self`) и просмотр общедоступной информации.

## Основные страницы и функции

### Страница управления пользователями
- **Макет:** *Предполагается:* боковая панель для фильтров/группировки, основная область для отображения списка или карточек пользователей.
- **Карточка текущего пользователя:** Отображается вверху страницы или в отдельном блоке, с переходом в настройки (доступно всем).
- **Список пользователей:** Отображение всех пользователей (доступно всем) с основной информацией (ФИО, должность, отдел/команда, аватар). Возможность группировки по отделам, командам, должностям, категориям.
- **Фильтрация/Группировка:** *Вопрос: Какие конкретно элементы управления будут использоваться для фильтрации и группировки (выпадающие списки, поиск, чекбоксы)?*
- **Редактирование/Создание:**
    - Иконка шестерёнки при наведении на пользователя для входа в режим редактирования (доступно при наличии разрешений `user.edit`, `user.edit.department` или `user.edit.team` для соответствующих пользователей).
    - Кнопка "Добавить пользователя" (доступно при наличии `user.create`).
    - *Вопрос: Как будет реализована форма создания/редактирования пользователя (модальное окно/отдельная страница)? Какие поля будут доступны для редактирования в зависимости от разрешений?*
- **Поддержка тем:** Поддержка светлой и тёмной темы.

### Вкладка "Аналитика"
- **Макет:** *Предполагается:* панель с фильтрами и выбором периода, основная область с виджетами/графиками.
- **Доступ:** Отображение аналитики по пользователям (доступно при наличии разрешения `analytics.view`).
- **Функционал:** Фильтрация и группировка данных согласно описанию в разделе "Аналитика".

## Процессы

- **Добавление пользователя:** *Вопрос: Как будет происходить добавление нового пользователя (создание админом с временным паролем, отправка приглашения по email для самостоятельной регистрации)?*
- **Деактивация/Удаление:** *Вопрос: Нужна ли функция деактивации пользователя (запрет входа, но сохранение данных и истории) в дополнение к полному удалению (`user.delete`)?*

## Обращения к базе данных (через Supabase)
- Получение списка всех пользователей с их основной информацией (для отображения в списке).
- Получение детальной информации о пользователе, включая его разрешения или роли (для проверок доступа и отображения).
- Получение и обновление информации о текущем пользователе (требует `user.edit.self`).
- Получение агрегированной информации для аналитики (требует `analytics.view`).
- Обновление данных пользователя (требует `user.edit`, `user.edit.department` или `user.edit.team` в зависимости от контекста и применяемых RLS-политик).
- Создание/удаление/деактивация(?) пользователей (требует `user.create`/`user.delete`/`user.deactivate`(?)).
- Получение/обновление информации об отделах, командах, должностях, категориях (требует `structure.edit` или более гранулярных прав, если они будут введены).

## Таблицы базы данных (Supabase)
- **users** (id, name, email, avatar_url, position_id, category_id, is_active, ...) - Основная информация о пользователе. Добавлено поле `is_active` для возможной деактивации.
- **permissions** (id, name, description) - Справочник всех возможных разрешений.
- **roles** (id, name, description) - Справочник ролей (наборов разрешений).
- **role_permissions** (role_id, permission_id) - Связь между ролями и разрешениями (многие-ко-многим).
- **user_roles** (user_id, role_id) - Назначение ролей пользователям (многие-ко-многим).
- **departments** (id, name) - Отделы.
- **teams** (id, name, department_id) - Команды (с привязкой к отделу).
- **positions** (id, name) - Должности.
- **categories** (id, name) - Категории пользователей.
- *Вопрос: Как будет реализована связь пользователя с его отделом(ами)/командой(ами) — через поля `department_id`/`team_id` в таблице `users` (ограничение: один отдел/команда) или через отдельные таблицы связей (например, `user_departments`, `user_teams`) для поддержки возможной принадлежности к нескольким структурам? Это влияет на реализацию прав `user.edit.department`/`user.edit.team` и RLS.*
- *Возможно потребуется таблица `audit_log` для механизма аудита.*

## Аналитика
Аналитика содержит данные о количестве пользователей, категориях, отделах, командах с возможностью фильтрации и группировки.

Возможные показатели и варианты визуализации:
- Общее количество пользователей (числовой индикатор, с разделением на активных/неактивных, если будет деактивация)
- Количество пользователей по отделам (гистограмма или круговая диаграмма)
- Количество пользователей по командам (гистограмма)
- Количество пользователей по категориям (круговая диаграмма)
- Динамика изменения количества пользователей (линейный график по датам регистрации/добавления/деактивации)
- Топ-5 самых крупных отделов/команд (рейтинговый список)
- Фильтрация и группировка по отделу, команде, категории, дате регистрации, статусу (активен/неактивен)
- Возможность выгрузки аналитических данных в CSV/Excel (требует разрешения `analytics.export`)

## Механизм смены темы
Механизм смены темы (светлая/тёмная) реализован с помощью библиотеки next-themes. Тема переключается через добавление класса .dark к html/body, что активирует соответствующие CSS-переменные, определённые в globals.css. Выбор темы сохраняется в localStorage и может автоматически подстраиваться под системную тему пользователя. Интеграция с Supabase и Redux для хранения состояния темы не используется. Все модули приложения автоматически поддерживают обе темы при использовании UI Kit и переменных темы.

## Управление состоянием (Redux)
*Вопрос: Какие данные модуля предполагается хранить в Redux (полный список пользователей для отображения, кешированные данные справочников (отделы, команды), состояние фильтров/группировки, UI-состояние форм/модальных окон)?*

## Обработка ошибок
*Вопрос: Как должны отображаться ошибки пользователю (тосты/нотификации, сообщения под полями в формах, отдельные страницы ошибок для критических случаев)?* Необходимо предусмотреть обработку ошибок отсутствия прав, ошибок валидации данных, сетевых ошибок и ошибок Supabase.

## Слабые места и точки для улучшения
- **Конфликты прав и структура:** Необходимо детально проработать сценарии, когда пользователь принадлежит к нескольким командам/отделам (если это возможно согласно ответу на вопрос в разделе "Таблицы базы данных"), и как разрешения администраторов отделов/команд должны работать в таких случаях. Определить точную структуру связи пользователей с отделами/командами.
- **Аудит:** Не определены механизмы аудита действий администраторов (кто, когда и какие изменения вносил). *Предложение: Создать таблицу `audit_log` и использовать триггеры БД или Supabase Functions для записи изменений.*
- **Детализация разрешений:** Нужно точно определить, какие **конкретно поля** пользователя может редактировать каждое разрешение (`user.edit`, `user.edit.self`, `user.edit.department`, `user.edit.team`).

## Разрешения модуля управления пользователями
Просмотр основной информации о пользователях, отделах, командах, должностях, категориях доступен всем пользователям по умолчанию и не требует отдельного разрешения.

- `user.edit` — редактирование любых пользователей (всех полей?).
- `user.edit.self` — редактирование только своей информации (каких полей?).
- `user.edit.department` — редактирование пользователей своего отдела (каких полей?).
- `user.edit.team` — редактирование пользователей своей команды (каких полей?).
- `user.create` — создание новых пользователей.
- `user.delete` — удаление пользователей.
- `user.deactivate` — *Возможное разрешение:* деактивация/активация пользователей.
- `structure.edit` — редактирование любых отделов, команд, должностей, категорий.
- *Возможно потребуются гранулярные разрешения для структур: `department.edit`, `team.edit`, `position.edit`, `category.edit`.*
- `analytics.view` — просмотр вкладки аналитики.
- `analytics.export` — выгрузка данных из аналитики.
- `role.assign` — назначение ролей/разрешений пользователям (если это будет делаться через интерфейс).

## Использование Supabase
В качестве базы данных и бэкенда для модуля управления пользователями используется Supabase. Все данные о пользователях, ролях, разрешениях, структурах (отделы, команды и т.д.), а также операции по их получению, обновлению и реализации логики доступа осуществляются через Supabase (PostgreSQL, Functions, RLS).
- **RLS (Row Level Security):** Для обеспечения безопасности и гранулярного контроля доступа **необходимо** активно использовать Row Level Security (RLS) в Supabase, особенно для реализации разрешений `user.edit.department`, `user.edit.team`, `user.edit.self`.
- **Functions:** *Вопрос: Планируется ли активное использование Supabase Edge Functions (например, для сложной логики при создании/обновлении пользователя, триггеров на изменение данных, отправки уведомлений, агрегации данных для аналитики)?*
