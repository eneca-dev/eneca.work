# LoadingModal - Модальное окно для управления загрузками сотрудников

## Общее описание

`LoadingModal` — это комплексный React-компонент для создания и редактирования загрузок (workload) сотрудников на этапах проектов. Модалка предоставляет двухпанельный интерфейс с навигацией по проектам и формой для управления параметрами загрузки.

## Режимы работы

### 1. Режим создания (`mode: "create"`)
- Создание новых загрузок для сотрудников
- Двухэтапный процесс: выбор этапа → заполнение формы
- Большая кнопка "Создать загрузку" после выбора этапа

### 2. Режим редактирования (`mode: "edit"`)
- Редактирование существующих загрузок
- Отслеживание изменений (флаг `hasChanges`)
- Дополнительные действия: архивация и удаление
- Автоматическое переключение на режим "Все проекты"

## Основные возможности

### Навигация по проектам

#### Иерархическая структура (FileTree)
Модалка строит древовидную структуру проектов:
- **Проект** (Project)
  - **Стадия** (Stage)
    - **Объект** (Object)
      - **Раздел** (Section)
        - "Перейти к декомпозиции" (навигационная нода)
        - **Этап** (Decomposition Stage) - конечный выбираемый элемент

#### Ленивая загрузка данных
- Проекты загружаются при открытии модалки
- Детальная структура загружается при раскрытии узлов
- Кеширование данных для оптимизации (`projectDataCache`)
- Очередь для отложенных вызовов `buildFileTree`

#### Фильтрация проектов
Два режима просмотра:
- **"Мои проекты"** (`viewMode: "my"`) - фильтрация по департаменту пользователя
- **"Все проекты"** (`viewMode: "all"`) - показать все проекты

#### Поиск
- Поиск по названию проекта (`projectSearchTerm`)
- Фильтрация дерева в реальном времени

#### Обновление данных
- Обновление отдельного проекта (кнопка с иконкой `RefreshCw`)
- Обновление всего списка проектов
- Визуальная индикация процесса обновления
- Очистка кеша при обновлении

### Работа с формой загрузки

#### Поля формы
1. **Сотрудник** (Employee)
   - Поиск с автодополнением
   - Отображение аватара, должности, команды
   - Dropdown с позиционированием (вверх/вниз)

2. **Даты** (DateRange)
   - Дата начала (`startDate`)
   - Дата окончания (`endDate`)
   - Компонент `DateRangePicker`
   - Валидация: начало < окончания
   - Расчет рабочих дней с учетом календарных событий

3. **Ставка загрузки** (Rate)
   - Предустановленные значения: 0.2, 0.25, 0.5, 0.75, 1.0
   - Ручной ввод для нестандартных значений
   - Валидация: 0 < rate ≤ 2
   - Цветовая индикация кнопок

4. **Комментарий** (Comment)
   - Необязательное текстовое поле
   - Многострочный ввод

#### Валидация
- Проверка всех обязательных полей
- Валидация диапазона дат
- Валидация ставки загрузки
- Блокировка кнопки "Сохранить"/"Создать" при невалидных данных

### Специальные функции

#### Навигация к декомпозиции
- Специальная нода "Перейти к декомпозиции" в каждом разделе
- Открывает `SectionPanel` с вкладкой декомпозиции
- Позволяет создавать новые этапы декомпозиции прямо из модалки
- Автоматическое обновление дерева после изменений

#### Создание этапа декомпозиции
- Кнопка "Создать этап" (`FilePlus`)
- Промпт для ввода названия этапа
- Асинхронное создание через Supabase
- Автоматическое обновление кеша проекта
- Автоматический выбор созданного этапа

#### Автоматический выбор этапа
- При передаче `stageId` в пропсах
- Автоматическая загрузка иерархии проекта
- Раскрытие всех родительских узлов
- Переключение на "Все проекты" если этап не найден в "Моих проектах"
- Установка названия проекта в поиск

### Операции в режиме редактирования

#### Сохранение изменений
- Отслеживание изменений (`hasChanges`)
- Обновление в Supabase
- Обновление в локальном store
- Колбэк `onLoadingUpdated` после успешного сохранения

#### Архивация
- Двухэтапное подтверждение
- Soft delete - запись помечается как архивированная
- Возможность восстановления
- Обновление в store через `archiveLoadingInStore`

#### Удаление
- Трехступенчатый процесс:
  1. Предупреждение о необходимости архивации
  2. Выбор: архивировать или удалить
  3. Финальное подтверждение удаления
- Hard delete - полное удаление из БД
- Необратимая операция
- Обновление в store через `deleteLoadingInStore`

## Технические особенности

### Оптимизация производительности

#### Кеширование
- Кеш данных проектов с ключами `{projectId}-{viewMode}`
- Раздельные кеши для режимов "my" и "all"
- Принудительное обновление через флаг `forceRefresh`

#### Предотвращение дублирования запросов
- Ref-флаг `isLoadingTreeRef` для блокировки параллельных вызовов
- Состояние `loadingNodes` для отслеживания загружающихся узлов
- Очередь для отложенных задач (`pendingBuildQueue`)

#### Отложенная загрузка
- Дети узлов загружаются только при раскрытии
- Единый запрос на весь проект через view `view_project_tree_with_loadings`
- Локальное построение иерархии из плоских данных

### Интеграция с системой

#### Supabase
- Работа с views: `view_projects_with_department_info`, `view_project_tree_with_loadings`
- CRUD операции для загрузок
- Real-time обновления не реализованы

#### Stores
- `usePlanningStore` - операции с загрузками
- `useProjectsStore` - выбор разделов
- `useUserStore` - данные текущего пользователя
- `useUiStore` - уведомления

#### Sentry
- Трекинг ошибок загрузки данных
- Spans для мониторинга производительности
- Детальная информация в extra fields

### Хуки и эффекты

1. **Инициализация** - загрузка дерева и сотрудников при открытии
2. **Переключение viewMode** - очистка кеша и перезагрузка
3. **Автоматический выбор этапа** - при передаче `stageId`
4. **Обработка отложенных выборов** - после переключения режима
5. **Сброс состояния** - при закрытии/повторном открытии
6. **Загрузка календарных событий** - для расчета рабочих дней
7. **Очистка таймаутов** - при размонтировании компонента

## UI/UX особенности

### Двухпанельная структура
- **Левая панель** (40%) - навигация по проектам
- **Правая панель** (60%) - форма загрузки

### Адаптивный дизайн
- Темная/светлая тема через проп `theme`
- Tailwind CSS с классами условной стилизации
- Responsive компоненты

### Визуальная обратная связь
- Иконки для типов узлов (Folder/FolderOpen/FileUser)
- Индикаторы загрузки (спиннеры)
- Уведомления через `useUiStore`
- Breadcrumbs для отображения пути
- Цветовая индикация состояний кнопок

### Accessibility
- Tooltips для интерактивных элементов
- Семантический HTML
- Управление фокусом (не полностью реализовано)

## Структуры данных

### FileTreeNode
```typescript
interface FileTreeNode {
  id: string
  name: string
  type: "file" | "folder"
  children?: FileTreeNode[]
  parentId?: string
  // Metadata
  projectId?: string
  stageId?: string
  objectId?: string
  sectionId?: string
  decompositionStageId?: string
  loadingId?: string
  loading?: Loading
  isUnsaved?: boolean
  isNavigationNode?: boolean
}
```

### ProjectTreeViewRow
Плоская структура из Supabase view с полной информацией о проекте, этапах, объектах, разделах и загрузках.

### EmployeeSearchResult
Данные сотрудника из поиска с информацией о должности, команде, департаменте.

## Потенциальные проблемы

1. **Race conditions** при переключении viewMode и загрузке данных
2. **Большой размер файла** (3113 строк) - сложность поддержки
3. **Отсутствие виртуализации** для больших списков проектов
4. **Множественные useEffect** с зависимостями - риск бесконечных циклов
5. **Сложная логика синхронизации** состояний (pendingStageSelection, pendingBuildQueue)

## Зависимости

- React (hooks: useState, useEffect, useRef, useCallback, useMemo)
- Supabase client
- Sentry для мониторинга
- Lucide-react для иконок
- Custom UI components (Tooltip, Input, DateRangePicker)
- Custom hooks (useSectionStatuses, useCalendarEvents)
- Custom stores (Zustand)

## Выводы

Это крайне сложный и функционально насыщенный компонент, который выполняет множество задач:
- Навигация по многоуровневой иерархии проектов
- CRUD операции для загрузок
- Интеграция с множеством систем
- Оптимизация производительности через кеширование
- Сложная логика автоматического выбора и навигации

Компонент требует рефакторинга для упрощения и улучшения maintainability.
