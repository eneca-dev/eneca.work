# Optimistic Update для редактирования и удаления чекпоинтов

## Задача

Модалка редактирования чекпоинта должна закрываться **мгновенно** при нажатии "Сохранить" или "Удалить", а изменения должны сразу отображаться на графике.

## Решение

Модалка редактирования теперь закрывается **до** ответа сервера, а optimistic updates из хуков обновляют UI мгновенно.

### Архитектура

```
1. Пользователь нажимает "Сохранить" / "Удалить"
   ↓
2. Модалка закрывается СРАЗУ
   ↓
3. Хук применяет optimistic update к кешу
   ↓
4. UI обновляется мгновенно (график перерисовывается)
   ↓
5. В фоне идёт запрос к серверу
   ↓
6. При успехе: кеш инвалидируется, данные рефетчатся
   При ошибке: optimistic update откатывается автоматически
```

## Изменения

### CheckpointEditModal - handleSave

**Было:**
```typescript
updateCheckpoint.mutate(payload, {
  onSuccess: () => {
    onSuccess?.()
    onClose() // ❌ Модалка закрывается ПОСЛЕ ответа сервера
  },
})
```

**Стало:**
```typescript
// ✅ Закрываем модалку СРАЗУ
onClose()
onSuccess?.()

// Обновление происходит в фоне с optimistic update
updateCheckpoint.mutate(payload, {
  onSuccess: () => {
    console.log('Updated')
  },
  onError: () => {
    // TODO: Показать toast с ошибкой
  },
})
```

### CheckpointEditModal - handleConfirmDelete

**Было:**
```typescript
deleteCheckpoint.mutate(checkpointId, {
  onSuccess: () => {
    onSuccess?.()
    onClose() // ❌ Модалка закрывается ПОСЛЕ ответа сервера
  },
})
```

**Стало:**
```typescript
// ✅ Закрываем модалку СРАЗУ
onClose()

// Удаление происходит в фоне с optimistic update
deleteCheckpoint.mutate(checkpointId, {
  onSuccess: () => {
    onSuccess?.() // Уведомляем родителя
  },
  onError: () => {
    // TODO: Показать toast с ошибкой
  },
})
```

### Важно: handleToggleComplete остаётся как было

```typescript
completeCheckpoint.mutate({ checkpointId, completed: true }, {
  onSuccess: () => {
    onSuccess?.() // ✅ Модалка НЕ закрывается - это правильно
  },
})
```

**Почему модалка НЕ закрывается:**
- Пользователь остаётся в модалке редактирования
- Видит мгновенное изменение иконки выполнения
- Может продолжить редактирование других полей
- Это лучший UX для toggle-кнопки

## Как работает Optimistic Update

### Обновление (useUpdateCheckpoint)

1. Пользователь меняет название с "Экспертиза" на "Государственная экспертиза"
2. Нажимает "Сохранить"
3. **Модалка закрывается мгновенно** (0ms)
4. `useUpdateCheckpoint` применяет merge функцию:
   ```typescript
   merge: (item, input) => ({
     ...item,
     title: input.title ?? item.title,
     checkpoint_date: input.checkpointDate ?? item.checkpoint_date,
     // ...
   })
   ```
5. TanStack Query обновляет кеш → график перерисовывается
6. Пользователь видит новое название **мгновенно**
7. Через 200-500ms приходит ответ сервера
8. Кеш инвалидируется → рефетч → данные синхронизируются

### Удаление (useDeleteCheckpoint)

1. Пользователь нажимает "Удалить" → подтверждает
2. **Модалка закрывается мгновенно** (0ms)
3. `useDeleteCheckpoint` применяет фильтр:
   ```typescript
   updater: (old, input) => {
     const idToDelete = getId(input)
     return old.filter(item => getItemId(item) !== idToDelete)
   }
   ```
4. TanStack Query удаляет из кеша → график перерисовывается
5. Чекпоинт **исчезает с графика мгновенно**
6. Через 200-500ms приходит ответ сервера
7. Кеш инвалидируется → рефетч → чекпоинт не возвращается

## Преимущества

✅ **Мгновенный отклик** - модалка закрывается сразу (0ms vs 200-500ms)
✅ **Лучший UX** - пользователь не ждёт сервера
✅ **График обновляется мгновенно** - изменения видны сразу
✅ **Автоматический откат** - при ошибке изменения откатываются
✅ **Консистентность** - работает одинаково с созданием

## Сценарии использования

### Успешное редактирование

1. Открыть чекпоинт "Экспертиза"
2. Изменить дату с 2025-12-31 на 2026-01-15
3. Нажать "Сохранить"
4. ✅ Модалка закрылась мгновенно
5. ✅ На графике чекпоинт переместился на новую дату
6. Подождать 1-2 секунды
7. ✅ Чекпоинт остался на новой дате (данные синхронизированы)

### Успешное удаление

1. Открыть чекпоинт "Экспертиза"
2. Нажать "Удалить" → подтвердить
3. ✅ Модалка закрылась мгновенно
4. ✅ Чекпоинт исчез с графика
5. Подождать 1-2 секунды
6. ✅ Чекпоинт не вернулся (удаление успешно)

### Ошибка сети (откат)

1. Отключить интернет
2. Открыть чекпоинт, изменить название
3. Нажать "Сохранить"
4. ✅ Модалка закрылась мгновенно
5. ✅ Название изменилось на графике
6. Включить интернет
7. ❌ Через 1-2 сек название вернулось к старому (откат)
8. ⚠️ TODO: Показать toast-уведомление об ошибке

### Toggle выполнения (модалка НЕ закрывается)

1. Открыть чекпоинт
2. Нажать кнопку "Отметить выполненным"
3. ✅ Иконка стала зелёной мгновенно
4. ✅ Модалка осталась открытой (правильно!)
5. Пользователь может продолжить редактирование
6. ✅ На графике чекпоинт тоже отмечен выполненным

## Технические детали

### Почему модалка закрывается в handleSave, но не в handleToggleComplete?

**handleSave / handleConfirmDelete:**
- Это финальные действия → пользователь завершает работу с модалкой
- Ожидание: модалка должна закрыться после нажатия
- **Решение:** Закрываем сразу для лучшего UX

**handleToggleComplete:**
- Это промежуточное действие → пользователь остаётся в модалке
- Ожидание: модалка НЕ должна закрываться
- **Решение:** Только обновляем иконку, модалка остаётся открытой

### Откат при ошибке

TanStack Query автоматически откатывает optimistic update при ошибке:

```typescript
onError: (error, input, context) => {
  // TanStack Query восстанавливает предыдущее состояние кеша
  const ctx = context as { previousQueries: [...] }
  for (const { queryKey, data } of ctx.previousQueries) {
    queryClient.setQueryData(queryKey, data) // Откат
  }
}
```

**Что видит пользователь:**
1. Модалка закрылась → изменения применились
2. Через 1-2 сек изменения исчезли (откатились)
3. ⚠️ Нет уведомления об ошибке (TODO)

**Что нужно добавить:**
```typescript
onError: (error) => {
  toast.error('Не удалось сохранить изменения', {
    description: error.message,
    action: {
      label: 'Повторить',
      onClick: () => {/* retry */}
    }
  })
}
```

## Ограничения и TODO

### Текущие ограничения:

1. **Нет toast-уведомлений при ошибке**
   - Пользователь не понимает, почему изменения откатились
   - TODO: Интегрировать react-hot-toast или sonner

2. **Нет retry при ошибке**
   - При сетевой ошибке изменения просто откатываются
   - TODO: Добавить `retry: 3` в TanStack Query config

3. **Нет индикатора "Сохраняется"**
   - Можно показать тонкий прогресс-бар на графике
   - TODO: Добавить `isPending` индикатор на чекпоинтах

### Возможные улучшения:

1. **Показать индикатор pending на графике:**
   ```typescript
   const CheckpointMarker = ({ checkpoint }) => {
     const mutation = useMutation() // Получить текущую мутацию
     const isPending = mutation.isPending

     return (
       <div className={isPending ? 'opacity-50 animate-pulse' : ''}>
         {/* Чекпоинт */}
       </div>
     )
   }
   ```

2. **Автоматический retry:**
   ```typescript
   export const useUpdateCheckpoint = createUpdateMutation({
     // ...
     retry: 3,
     retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
   })
   ```

3. **Переоткрыть модалку при ошибке:**
   ```typescript
   onError: (error) => {
     toast.error('Ошибка сохранения', {
       action: {
         label: 'Исправить',
         onClick: () => {
           // Переоткрыть модалку с теми же данными
           openEditModal(checkpointId)
         }
       }
     })
   }
   ```

## Изменённые файлы

- `modules/modals/components/checkpoint/CheckpointEditModal.tsx` - модалка редактирования
- `OPTIMISTIC_UPDATES_CHECKPOINTS.md` - обновлённая документация

## Производительность

Optimistic updates НЕ добавляют дополнительных запросов:
- 1 запрос к серверу (как и раньше)
- Но модалка закрывается МГНОВЕННО (не ждёт ответа)
- Кеш обновляется синхронно (без задержек)

### Измерения:

**Раньше:**
- Нажать "Сохранить" → ждать 200-500ms → модалка закрывается → график обновляется

**Сейчас:**
- Нажать "Сохранить" → модалка закрывается СРАЗУ (0ms) → график обновляется СРАЗУ → через 200-500ms данные синхронизируются

**Выигрыш в UX:** ~300-500ms → воспринимается как мгновенный отклик

## Связанные документы

- [OPTIMISTIC_CREATE_CHECKPOINT.md](OPTIMISTIC_CREATE_CHECKPOINT.md) - Optimistic create
- [OPTIMISTIC_UPDATES_CHECKPOINTS.md](OPTIMISTIC_UPDATES_CHECKPOINTS.md) - Общая документация
- `modules/cache/README.md` - Документация cache-модуля
