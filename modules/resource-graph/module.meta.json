{
  "$schema": "../../schemas/module-meta/module.schema.json",

  "meta": {
    "name": "resource-graph",
    "displayName": "Resource Graph",
    "description": "Визуализация иерархии проектов с timeline, загрузками сотрудников, готовностью и бюджетами",
    "version": "2.0.16",
    "status": "stable",
    "route": "/dashboard/resource-graph",
    "tags": ["feature", "ui", "data-layer"]
  },

  "architecture": {
    "structure": {
      "actions/": "Server Actions для работы с Supabase (queries + mutations)",
      "components/": "React компоненты (главный + timeline визуализация)",
      "components/timeline/": "Timeline компоненты (header, rows, bars, overlays)",
      "components/timeline/rows/": "Row компоненты для каждого уровня иерархии",
      "components/timeline/shared/": "Переиспользуемые компоненты (ProgressCircle, etc)",
      "constants/": "Константы (ROW_HEIGHT, COLORS, SCALES)",
      "filters/": "Хуки для автокомплита InlineFilter",
      "hooks/": "React Query хуки (query + mutation)",
      "stores/": "Zustand stores (UI state, filters, display settings)",
      "types/": "TypeScript типы данных",
      "utils/": "Утилиты (format, hierarchy transform)"
    },
    "entryPoint": "index.ts",
    "publicApi": [
      "ResourceGraph",
      "ResourceGraphInternal",
      "useResourceGraphData",
      "useUserWorkload",
      "useSectionsBatch",
      "useDisplaySettingsStore",
      "useFiltersStore",
      "useUIStateStore",
      "RESOURCE_GRAPH_FILTER_CONFIG"
    ]
  },

  "hooks": [
    {
      "name": "useResourceGraphData",
      "description": "Получение полной иерархии проектов с фильтрацией",
      "file": "hooks/index.ts",
      "params": "FilterQueryParams?",
      "returns": "{ data: Project[], isLoading, error }",
      "example": "const { data: projects } = useResourceGraphData({ project_id: 'xxx' })"
    },
    {
      "name": "useUserWorkload",
      "description": "Загрузка конкретного пользователя как ответственного",
      "file": "hooks/index.ts",
      "params": "userId: string",
      "returns": "{ data: Project[], isLoading }",
      "example": "const { data } = useUserWorkload(userId)"
    },
    {
      "name": "useSectionsBatch",
      "description": "Batch загрузка всех данных секций объекта одним запросом",
      "file": "hooks/index.ts",
      "params": "objectId, sectionIds[], options?",
      "returns": "{ data: SectionsBatchData }",
      "example": "const { data } = useSectionsBatch(objectId, sectionIds, { enabled: isExpanded })"
    },
    {
      "name": "useWorkLogs",
      "description": "Work logs для раздела",
      "file": "hooks/index.ts",
      "params": "sectionId: string",
      "returns": "{ data: WorkLog[] }"
    },
    {
      "name": "useLoadings",
      "description": "Загрузки сотрудников на этап",
      "file": "hooks/index.ts",
      "params": "sectionId: string",
      "returns": "{ data: Loading[] }"
    },
    {
      "name": "useStageReadiness",
      "description": "Готовность этапов раздела (снэпшоты)",
      "file": "hooks/index.ts",
      "params": "sectionId: string",
      "returns": "{ data: Record<stageId, ReadinessPoint[]> }"
    },
    {
      "name": "useStageResponsibles",
      "description": "Ответственные за этапы раздела",
      "file": "hooks/index.ts",
      "params": "sectionId: string",
      "returns": "{ data: Record<stageId, StageResponsible[]> }"
    },
    {
      "name": "useTagOptions",
      "description": "Все теги проектов (кеш 24ч)",
      "file": "hooks/index.ts",
      "returns": "{ data: ProjectTag[] }"
    },
    {
      "name": "useProjectTagsMap",
      "description": "Map проектов к их тегам (оптимизация)",
      "file": "hooks/index.ts",
      "returns": "{ data: Record<projectId, ProjectTag[]> }"
    },
    {
      "name": "useCompanyCalendarEvents",
      "description": "Праздники и переносы рабочих дней",
      "file": "hooks/index.ts",
      "returns": "{ data: CompanyCalendarEvent[] }"
    },
    {
      "name": "useUpdateLoadingDates",
      "description": "Mutation: Drag-resize загрузки на timeline",
      "file": "hooks/index.ts",
      "params": "{ loadingId, sectionId, startDate, finishDate }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useUpdateStageDates",
      "description": "Mutation: Drag-resize этапа декомпозиции",
      "file": "hooks/index.ts",
      "params": "{ stageId, startDate, finishDate }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useUpdateSectionDates",
      "description": "Mutation: Drag-resize раздела",
      "file": "hooks/index.ts",
      "params": "{ sectionId, startDate, endDate }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useCreateLoading",
      "description": "Mutation: Создать загрузку сотрудника",
      "file": "hooks/index.ts",
      "params": "{ sectionId, stageId, responsibleId, startDate, endDate, rate, comment? }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useUpdateLoading",
      "description": "Mutation: Обновить загрузку",
      "file": "hooks/index.ts",
      "params": "{ loadingId, sectionId, updates }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useDeleteLoading",
      "description": "Mutation: Удалить загрузку",
      "file": "hooks/index.ts",
      "params": "{ loadingId, sectionId }",
      "returns": "UseMutationResult"
    },
    {
      "name": "useTimelineResize",
      "description": "Управление drag-to-resize элементов на timeline",
      "file": "hooks/useTimelineResize.ts",
      "params": "{ startDate, endDate, range, onResize }",
      "returns": "{ leftHandleProps, rightHandleProps, previewPosition }",
      "example": "const { leftHandleProps, rightHandleProps } = useTimelineResize({ ... })"
    }
  ],

  "actions": [
    {
      "name": "getResourceGraphData",
      "description": "Полная иерархия проектов из v_resource_graph с фильтрацией",
      "file": "actions/index.ts",
      "input": "FilterQueryParams?",
      "output": "ActionResult<Project[]>",
      "mutates": false
    },
    {
      "name": "getUserWorkload",
      "description": "Загрузка пользователя как ответственного",
      "file": "actions/index.ts",
      "input": "userId, dateRange?",
      "output": "ActionResult<Project[]>",
      "mutates": false
    },
    {
      "name": "getSectionsBatchData",
      "description": "Batch загрузка 8 типов данных для секций",
      "file": "actions/index.ts",
      "input": "sectionIds[], options?",
      "output": "ActionResult<SectionsBatchData>",
      "mutates": false
    },
    {
      "name": "getWorkLogsForSection",
      "description": "Work logs раздела",
      "file": "actions/index.ts",
      "input": "sectionId",
      "output": "ActionResult<WorkLog[]>",
      "mutates": false
    },
    {
      "name": "getLoadingsForSection",
      "description": "Загрузки раздела",
      "file": "actions/index.ts",
      "input": "sectionId",
      "output": "ActionResult<Loading[]>",
      "mutates": false
    },
    {
      "name": "getStageReadinessForSection",
      "description": "Готовность всех этапов раздела",
      "file": "actions/index.ts",
      "input": "sectionId",
      "output": "ActionResult<Record<stageId, ReadinessPoint[]>>",
      "mutates": false
    },
    {
      "name": "getStageResponsiblesForSection",
      "description": "Ответственные за этапы раздела",
      "file": "actions/index.ts",
      "input": "sectionId",
      "output": "ActionResult<Record<stageId, StageResponsible[]>>",
      "mutates": false
    },
    {
      "name": "getProjectTags",
      "description": "Все теги проектов",
      "file": "actions/index.ts",
      "input": "void",
      "output": "ActionResult<ProjectTag[]>",
      "mutates": false
    },
    {
      "name": "getCompanyCalendarEvents",
      "description": "Праздники и переносы",
      "file": "actions/index.ts",
      "input": "void",
      "output": "ActionResult<CompanyCalendarEvent[]>",
      "mutates": false
    },
    {
      "name": "updateLoadingDates",
      "description": "Изменить даты загрузки (drag-resize)",
      "file": "actions/index.ts",
      "input": "{ loadingId, startDate, finishDate }",
      "output": "ActionResult<void>",
      "mutates": true
    },
    {
      "name": "updateStageDates",
      "description": "Изменить даты этапа декомпозиции",
      "file": "actions/index.ts",
      "input": "{ stageId, startDate, finishDate }",
      "output": "ActionResult<void>",
      "mutates": true
    },
    {
      "name": "updateSectionDates",
      "description": "Изменить даты раздела",
      "file": "actions/index.ts",
      "input": "{ sectionId, startDate, endDate }",
      "output": "ActionResult<void>",
      "mutates": true
    },
    {
      "name": "createLoading",
      "description": "Создать загрузку сотрудника на этап",
      "file": "actions/index.ts",
      "input": "{ sectionId, stageId, responsibleId, startDate, endDate, rate, comment? }",
      "output": "ActionResult<Loading>",
      "mutates": true
    },
    {
      "name": "updateLoading",
      "description": "Обновить загрузку (ставка, комментарий, ответственный)",
      "file": "actions/index.ts",
      "input": "{ loadingId, updates }",
      "output": "ActionResult<Loading>",
      "mutates": true
    },
    {
      "name": "deleteLoading",
      "description": "Удалить загрузку",
      "file": "actions/index.ts",
      "input": "loadingId",
      "output": "ActionResult<void>",
      "mutates": true
    },
    {
      "name": "deleteDecompositionItem",
      "description": "Удалить задачу и связанные work logs",
      "file": "actions/index.ts",
      "input": "itemId",
      "output": "ActionResult<void>",
      "mutates": true
    }
  ],

  "stores": [
    {
      "name": "useDisplaySettingsStore",
      "description": "Настройки отображения timeline (масштаб, выходные, праздники)",
      "file": "stores/index.ts",
      "persistence": "resource-graph-display-settings",
      "state": ["settings: DisplaySettings"],
      "actions": ["setScale", "toggleWeekends", "toggleHolidays", "toggleCompactMode", "resetSettings"]
    },
    {
      "name": "useFiltersStore",
      "description": "Состояние InlineFilter (строка фильтра)",
      "file": "stores/index.ts",
      "persistence": "resource-graph-filters",
      "state": ["filterString: string"],
      "actions": ["setFilterString", "clearFilters", "getQueryParams", "hasFilters"]
    },
    {
      "name": "useUIStateStore",
      "description": "UI состояние (развёрнутые узлы, выбранный элемент)",
      "file": "stores/index.ts",
      "persistence": "resource-graph-ui-state",
      "state": ["expandedNodes: Record<TreeNodeType, Set<string>>", "selectedItemId", "selectedItemType"],
      "actions": ["isExpanded", "toggleNode", "expandNode", "collapseNode", "batchExpand", "batchCollapse", "expandAll", "collapseAll", "setSelectedItem"]
    }
  ],

  "components": [
    {
      "name": "ResourceGraph",
      "description": "Полный компонент с InlineFilter header",
      "file": "components/ResourceGraph.tsx",
      "props": [],
      "example": "<ResourceGraph />"
    },
    {
      "name": "ResourceGraphInternal",
      "description": "Timeline без header (для встраивания)",
      "file": "components/ResourceGraph.tsx",
      "props": ["filterString", "queryParams", "filterConfig"]
    },
    {
      "name": "ResourceGraphTimeline",
      "description": "Основной timeline компонент",
      "file": "components/timeline/ResourceGraphTimeline.tsx",
      "props": ["projects", "range", "scale", "calendarEvents"]
    },
    {
      "name": "TimelineHeader",
      "description": "Header с выбором масштаба, фиксированный при скролле",
      "file": "components/timeline/TimelineHeader.tsx",
      "props": ["range", "scale", "calendarEvents"]
    },
    {
      "name": "ProjectRow",
      "description": "Строка проекта (верхний уровень иерархии)",
      "file": "components/timeline/rows/ProjectRow.tsx",
      "props": ["project"]
    },
    {
      "name": "ObjectRow",
      "description": "Строка объекта",
      "file": "components/timeline/rows/ObjectRow.tsx",
      "props": ["object", "projectId"]
    },
    {
      "name": "SectionRow",
      "description": "Строка раздела (двухстрочная, с чекпоинтами и готовностью)",
      "file": "components/timeline/rows/SectionRow.tsx",
      "props": ["section", "sectionId", "batchData"]
    },
    {
      "name": "DecompositionStageRow",
      "description": "Строка этапа декомпозиции с загрузками сотрудников",
      "file": "components/timeline/rows/DecompositionStageRow.tsx",
      "props": ["stage", "sectionId", "batchData"]
    },
    {
      "name": "LoadingBars",
      "description": "Визуализация загрузок на timeline (цветные блоки)",
      "file": "components/timeline/LoadingBars.tsx",
      "props": ["loadings", "range", "onEdit", "onDelete"]
    },
    {
      "name": "LoadingBadges",
      "description": "Info-чипсы загрузок в sidebar (Glass стиль)",
      "file": "components/timeline/LoadingBadges.tsx",
      "props": ["loadings"]
    },
    {
      "name": "WorkLogMarkers",
      "description": "Маркеры work logs на timeline (Glass pills)",
      "file": "components/timeline/WorkLogMarkers.tsx",
      "props": ["workLogs", "range"]
    },
    {
      "name": "ReadinessGraph",
      "description": "Комбинированный график готовности (плановая + фактическая)",
      "file": "components/timeline/ReadinessGraph.tsx",
      "props": ["plannedReadiness", "actualReadiness", "range"]
    },
    {
      "name": "ProgressCircle",
      "description": "SVG кольцо прогресса (0-100%)",
      "file": "components/timeline/shared/ProgressCircle.tsx",
      "props": ["progress", "size?", "strokeWidth?", "color?"],
      "example": "<ProgressCircle progress={75} size={24} />"
    }
  ],

  "patterns": [
    {
      "name": "Batch Loading Pattern",
      "description": "При развороте объекта загружай все данные секций одним запросом через useSectionsBatch вместо N отдельных запросов",
      "example": "const { data } = useSectionsBatch(objectId, sectionIds, { enabled: isExpanded })"
    },
    {
      "name": "Lazy Expand Pattern",
      "description": "Загружай детальные данные (loadings, workLogs) только при развороте элемента через enabled: isExpanded",
      "example": "useLoadings(sectionId, { enabled: isExpanded })"
    },
    {
      "name": "Drag-to-Resize Pattern",
      "description": "Используй useTimelineResize для drag-resize элементов на timeline с превью позиции",
      "example": "const { leftHandleProps, rightHandleProps, previewPosition } = useTimelineResize({ startDate, endDate, range, onResize })"
    },
    {
      "name": "Filter Config Pattern",
      "description": "Используй RESOURCE_GRAPH_FILTER_CONFIG для InlineFilter с типизированными полями фильтрации",
      "example": "<InlineFilter config={RESOURCE_GRAPH_FILTER_CONFIG} value={filterString} onChange={setFilterString} />"
    },
    {
      "name": "Timeline Range Calculation",
      "description": "Вычисляй диапазон timeline на основе данных проектов с буфером в 1 месяц по краям",
      "example": "calculateTimelineRange(projects, { bufferMonths: 1 })"
    }
  ],

  "antipatterns": [
    {
      "name": "Individual Section Queries",
      "description": "НЕ делай отдельный запрос для каждой секции при загрузке объекта",
      "instead": "Используй useSectionsBatch для batch загрузки всех данных"
    },
    {
      "name": "Direct Store Mutation",
      "description": "НЕ мутируй expandedNodes напрямую как объект",
      "instead": "Используй методы store: toggleNode, expandNode, collapseNode"
    },
    {
      "name": "Timeline Position Calculation in Render",
      "description": "НЕ вычисляй позиции элементов на timeline в каждом рендере",
      "instead": "Используй useMemo с зависимостями от range и scale"
    },
    {
      "name": "Uncontrolled Filter State",
      "description": "НЕ храни filterString в локальном useState компонента",
      "instead": "Используй useFiltersStore для синхронизации фильтров"
    }
  ],

  "technologies": [
    "@tanstack/react-query",
    "zustand",
    "@supabase/supabase-js",
    "date-fns",
    "tailwindcss",
    "lucide-react"
  ],

  "dependencies": {
    "modules": [
      "cache",
      "modals",
      "budgets",
      "checkpoints",
      "inline-filter",
      "permissions",
      "projects"
    ],
    "database": {
      "tables": [
        "projects",
        "objects",
        "sections",
        "decomposition_stages",
        "decomposition_items",
        "item_progress_history",
        "loadings",
        "work_logs",
        "profiles",
        "project_tags",
        "project_tag_links",
        "calendar_events",
        "stage_readiness_snapshots"
      ],
      "views": [
        "v_resource_graph",
        "v_org_structure",
        "v_project_structure",
        "view_section_checkpoints",
        "v_cache_budgets"
      ],
      "enums": [
        "project_status_enum",
        "work_category_enum"
      ],
      "functions": []
    }
  },

  "dependents": [
    "dashboard",
    "planning",
    "project-reports"
  ],

  "cache": {
    "queryKeys": [
      "resourceGraph.list",
      "resourceGraph.user",
      "resourceGraph.workLogs",
      "resourceGraph.loadings",
      "resourceGraph.stageReadiness",
      "resourceGraph.stageResponsibles",
      "resourceGraph.sectionsBatch",
      "projectTags.list",
      "projectTags.map",
      "companyCalendar.events",
      "filterStructure.project"
    ],
    "realtimeChannels": [
      "decomposition_items",
      "loadings",
      "work_logs",
      "sections",
      "decomposition_stages",
      "stage_readiness_snapshots"
    ],
    "invalidationRules": [
      {
        "trigger": "decomposition_items INSERT/UPDATE/DELETE",
        "invalidates": ["resourceGraph.all"]
      },
      {
        "trigger": "loadings INSERT/UPDATE/DELETE",
        "invalidates": ["resourceGraph.loadings(sectionId)", "resourceGraph.stageReadiness(sectionId)"]
      },
      {
        "trigger": "work_logs INSERT/UPDATE/DELETE",
        "invalidates": ["resourceGraph.workLogs(sectionId)"]
      },
      {
        "trigger": "sections UPDATE",
        "invalidates": ["resourceGraph.all"]
      },
      {
        "trigger": "stage_readiness_snapshots INSERT",
        "invalidates": ["resourceGraph.stageReadiness(sectionId)"]
      }
    ]
  },

  "permissions": [
    "resource_graph.view",
    "resource_graph.edit_loadings",
    "resource_graph.edit_dates",
    "resource_graph.delete_items"
  ],

  "tasks": [
    {
      "id": "RG-001",
      "title": "Исправить рендеринг вертикальных связей чекпоинтов",
      "description": "Навести порядок с чекпоинтами: вертикальные связи не рендерятся иногда, разваливаются при раскрытии различных строк. Проверить расчёт позиций, учёт высоты строк, z-index слоёв",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "completedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": ["RG-003"]
    },
    {
      "id": "RG-002",
      "title": "Оптимизация запросов в БД",
      "description": "Пересмотреть и оптимизировать все запросы: объединить где возможно, исправить порядок загрузки, убрать дублирующиеся запросы, проверить индексы",
      "category": "performance",
      "priority": "high",
      "status": "todo",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": ["RG-003"],
      "affectedFiles": [
        "modules/resource-graph/actions/**",
        "modules/resource-graph/hooks/**"
      ],
      "estimatedHours": 4
    },
    {
      "id": "RG-003",
      "title": "Аудит и тестирование Realtime подписок",
      "description": "Проверить код realtime подписок, протестировать обновление графика в реальном времени. Увеличить время жизни кеша где это имеет смысл. Убедиться что график живой и реагирует на изменения",
      "category": "refactor",
      "priority": "high",
      "status": "todo",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": ["RG-001", "RG-002"],
      "blocks": []
    },
    {
      "id": "RG-004",
      "title": "Инлайн редактирование параметров раздела",
      "description": "Добавить возможность редактировать параметры раздела прямо на графике: назначение ответственных, размещение раздела на графике если у него не указаны сроки (drag-and-drop или клик для установки дат). \n\n⚠️ ДЕКОМПОЗИРОВАНО на подзадачи: RG-015 (ответственные), RG-016 (сроки), RG-017 (layout сайдбара)",
      "category": "feature",
      "priority": "high",
      "status": "decomposed",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "decomposedInto": ["RG-015", "RG-016", "RG-017"],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/rows/DecompositionStageRow.tsx",
        "modules/resource-graph/actions/index.ts"
      ],
      "estimatedHours": 6
    },
    {
      "id": "RG-005",
      "title": "Показатель прироста процента готовности в строке задач",
      "description": "В строку задач (DecompositionItemRow) добавить отображение прироста процента готовности по дням. При изменении процента готовности показывать маленькую цифру прироста (например +5% или -2%)",
      "category": "feature",
      "priority": "medium",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "completedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-006",
      "title": "Фильтры по состоянию бюджета раздела",
      "description": "Добавить фильтры в InlineFilter: по состоянию бюджета раздела (отсутствует, превышен, в норме, близок к превышению и т.д.)",
      "category": "feature",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/filters/**",
        "modules/resource-graph/constants/filter-config.ts"
      ],
      "estimatedHours": 2
    },
    {
      "id": "RG-007",
      "title": "Фильтры по срокам раздела",
      "description": "Добавить фильтры по срокам раздела: просроченные, заканчиваются на этой неделе, без сроков, в работе и т.д.",
      "category": "feature",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/filters/**",
        "modules/resource-graph/constants/filter-config.ts"
      ],
      "estimatedHours": 2
    },
    {
      "id": "RG-008",
      "title": "График для строки проекта",
      "description": "Добавить визуализацию графика (готовность, бюджет, сроки) в строку проекта по аналогии с графиками в строках разделов",
      "category": "feature",
      "priority": "medium",
      "status": "backlog",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-009",
      "title": "Кнопка развернуть всё до разделов",
      "description": "Добавить возможность развернуть всю иерархию до уровня разделов одной кнопкой (expand all to sections)",
      "category": "feature",
      "priority": "low",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2026-01-05",
      "completedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-010",
      "title": "Аудит системы разрешений",
      "description": "Проверить работу системы разрешений в модуле: убедиться что все действия защищены проверками permissions, RLS работает корректно, UI скрывает недоступные действия. Дополнить недостающие проверки",
      "category": "security",
      "priority": "high",
      "status": "todo",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-011",
      "title": "Унификация кнопок развернуть/свернуть",
      "description": "Заменить кнопки развернуть и свернуть на единый с остальными вкладками стиль (как в других модулях)",
      "category": "refactor",
      "priority": "low",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2026-01-05",
      "completedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-012",
      "title": "Компактная модалка раздела",
      "description": "Сделать модалку раздела более компактной и привести её стиль к модалке создания бюджетов (тёмная тема, amber акценты, Resource Graph стиль)",
      "category": "refactor",
      "priority": "medium",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2026-01-05",
      "completedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-013",
      "title": "Вывести статус раздела на график",
      "description": "Отображать статус раздела (в работе, на паузе, завершён и т.д.) на timeline графике в виде визуального индикатора",
      "category": "feature",
      "priority": "medium",
      "status": "backlog",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-014",
      "title": "Отображение бюджета в модалке задачи и sidebar",
      "description": "В модалке задачи (TaskSidebar) и в строке задачи (DecompositionItemRow sidebar) отобразить информацию о бюджете задачи: общая сумма, израсходовано, остаток, процент расхода. Обеспечить корректную работу с БД для этих бюджетов",
      "category": "feature",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2025-01-05",
      "updatedAt": "2025-01-05",
      "completedAt": "2025-01-05",
      "blockedBy": [],
      "blocks": []
    },
    {
      "id": "RG-015",
      "title": "Инлайн назначение ответственных за раздел",
      "description": "Добавить возможность назначать/менять ответственного за раздел прямо в строке SectionRow без открытия модалки.\n\n## Текущее поведение\n- Ответственный отображается в виде Avatar в sidebar строки раздела\n- Для смены ответственного нужно кликнуть по названию → открыть SectionModal → найти ResponsibleDropdown\n- Это занимает 3+ клика и время на загрузку модалки\n\n## Целевое поведение\n- При клике на аватар ответственного открывается компактный dropdown\n- Dropdown содержит: поле поиска + список пользователей с аватарами\n- При выборе пользователя вызывается updateSection action\n- Optimistic update: аватар меняется сразу, затем синхронизируется с сервером\n- При ошибке — возврат к предыдущему значению + toast с ошибкой\n\n## UI/UX требования\n- Dropdown появляется под аватаром (или справа, если не влезает)\n- Стиль dropdown: тёмная тема (slate-800), amber акценты при hover\n- Поиск: фильтрация по имени и email\n- Показывать 'Не назначен' как первую опцию\n- Loading spinner на аватаре во время сохранения\n- Компонент переиспользует логику из ResponsibleDropdown (modules/modals/components/section/ResponsibleDropdown.tsx)\n\n## Технические детали\n- Создать SectionResponsibleInline компонент\n- Использовать useUsers() hook для списка пользователей\n- Использовать updateSection action (modules/modals/hooks/useUpdateSection.ts)\n- Инвалидация: queryKeys.resourceGraph.list при успехе\n- Проверка permission: resource_graph.edit_dates (или новый permission)",
      "category": "feature",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-05",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/shared/SectionResponsibleInline.tsx",
        "modules/modals/hooks/useUpdateSection.ts"
      ],
      "estimatedHours": 4,
      "acceptanceCriteria": [
        "Клик по аватару открывает dropdown с поиском пользователей",
        "Выбор пользователя мгновенно меняет аватар (optimistic update)",
        "При ошибке сохранения — возврат + toast",
        "Dropdown закрывается при клике вне или Escape",
        "Работает permission check"
      ],
      "technicalNotes": {
        "existingComponents": [
          "ResponsibleDropdown — можно переиспользовать логику",
          "useUsers() — hook для списка пользователей",
          "useUpdateSection — mutation hook"
        ],
        "newComponents": [
          "SectionResponsibleInline — компактный inline-редактор"
        ],
        "dataFlow": "Click → Open dropdown → Select user → updateSection mutation → Invalidate cache → UI updates"
      }
    },
    {
      "id": "RG-016",
      "title": "Инлайн внесение сроков в раздел (кнопка Разместить)",
      "description": "Для разделов без указанных сроков добавить возможность 'разместить' раздел на timeline прямо из строки.\n\n## Текущее поведение\n- Если у раздела нет startDate/endDate, он отображается без рамки на timeline\n- Для установки сроков нужно открыть SectionModal → DateRangeInput\n- Drag-resize работает только если сроки уже установлены\n\n## Целевое поведение\n\n### Вариант 1: Кнопка 'Разместить'\n- Если startDate/endDate пустые, в timeline части строки показывать кнопку 'Разместить'\n- При клике открывается popover с двумя date picker'ами (начало + конец)\n- После выбора дат — сохранение через updateSectionDates\n\n### Вариант 2: Click-to-place\n- Если сроки пустые, при клике на timeline в этой строке:\n  - Первый клик устанавливает startDate на дату клика\n  - Появляется временная рамка, следующая за курсором\n  - Второй клик устанавливает endDate\n  - Либо: зажать + drag для выбора диапазона\n\n### Рекомендуемый вариант: Кнопка + Popover\n- Проще в реализации\n- Понятнее для пользователя\n- Меньше edge cases\n\n## UI/UX требования\n- Кнопка 'Разместить' отображается по центру timeline части строки\n- Стиль: ghost button с иконкой Calendar, text-muted-foreground\n- При hover — подсветка amber\n- Popover: тёмная тема, два поля дат рядом\n- Валидация: endDate >= startDate\n- После сохранения: появляется SectionPeriodFrame с возможностью resize\n\n## Технические детали\n- Создать SectionPlaceButton компонент (или PlaceSectionPopover)\n- Использовать существующий updateSectionDates action\n- Позиция кнопки: по центру timeline ячейки\n- Date pickers: использовать существующий DatePicker компонент\n- После сохранения — refetch данных (queryKeys.resourceGraph.list)",
      "category": "feature",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-05",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/shared/PlaceSectionPopover.tsx",
        "modules/resource-graph/hooks/index.ts"
      ],
      "estimatedHours": 5,
      "acceptanceCriteria": [
        "Для разделов без сроков отображается кнопка 'Разместить' в timeline",
        "Клик открывает popover с выбором дат начала и конца",
        "Валидация: дата окончания не раньше даты начала",
        "После сохранения появляется SectionPeriodFrame",
        "SectionPeriodFrame поддерживает drag-resize",
        "Ошибки отображаются в popover или toast"
      ],
      "technicalNotes": {
        "existingComponents": [
          "DateRangeInput — можно адаптировать для popover",
          "updateSectionDates action — уже готов",
          "useUpdateSectionDates hook — уже готов",
          "SectionPeriodFrame — рамка с resize handles"
        ],
        "newComponents": [
          "PlaceSectionPopover — popover с date pickers"
        ],
        "stateManagement": "После успешного сохранения section.startDate/endDate обновятся через refetch, и вместо кнопки появится SectionPeriodFrame"
      }
    },
    {
      "id": "RG-017",
      "title": "Выровнять параметры раздела в сайдбаре по сетке",
      "description": "Привести sidebar строки раздела (SectionRow) к единому сеточному layout, где все поля занимают фиксированное место независимо от заполненности.\n\n## Текущее поведение\n- Вторая строка sidebar содержит: даты, бюджет, сегодняшние показатели (П/Ф/Б)\n- Элементы выстраиваются в flex row с gap\n- Если бюджет не указан — его место 'схлопывается'\n- Если показатели не в периоде — их нет вообще\n- Это приводит к 'прыганью' элементов между разными разделами\n\n## Целевое поведение\n- Sidebar использует CSS Grid с фиксированными колонками:\n  ```\n  | Даты          | Бюджет      | Показатели П/Ф/Б |\n  | 01.01 - 31.12 | 1.2M BYN    | П:45% Ф:40% Б:30%|\n  ```\n- Каждая колонка имеет min-width\n- Если значение пустое — показывать placeholder или пустое место\n- Все разделы выровнены одинаково\n\n## UI/UX требования\n- Grid layout: `grid-cols-[auto_auto_1fr]` или подобный\n- Минимальные ширины: даты ~120px, бюджет ~80px, показатели ~100px\n- Для пустых значений: либо placeholder ('—'), либо пустое пространство\n- Бюджет: если нет бюджета, показать '—' или скрытую иконку Wallet\n- Показатели: если раздел вне периода, показать прочерки или скрыть колонку\n- Alignment: text-right для числовых значений, text-left для дат\n\n## Альтернативный вариант: двухстрочный layout\n```\nСтрока 1: | Название раздела |\nСтрока 2: | Даты | Бюджет | Показатели |\n```\nКаждая ячейка имеет фиксированную ширину через grid.\n\n## Технические детали\n- Изменить flex на grid в sidebar части SectionRow\n- Определить breakpoints если нужно (для узких экранов)\n- Возможно вынести в отдельный компонент SectionSidebarGrid",
      "category": "refactor",
      "priority": "medium",
      "status": "done",
      "completedAt": "2026-01-05",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "Даты, бюджет и показатели всегда занимают одинаковое место",
        "При отсутствии бюджета — placeholder или пустое место (не схлопывание)",
        "При отсутствии показателей — прочерки или пустое место",
        "Все разделы выровнены одинаково по вертикали",
        "Числовые значения выровнены по правому краю"
      ],
      "technicalNotes": {
        "currentLayout": "flex items-center gap-2 (вторая строка sidebar)",
        "proposedLayout": "grid grid-cols-[120px_80px_1fr] gap-2",
        "placeholders": {
          "dates": "Даты не указаны (но лучше не показывать вообще если нет)",
          "budget": "— или скрытая иконка Wallet",
          "indicators": "П:—% Ф:—% Б:—%"
        }
      }
    },
    {
      "id": "RG-018",
      "title": "Оптимизация загрузки данных разделов (убрать 'Загрузка данных...')",
      "description": "Убрать строку 'Загрузка данных...' при раскрытии объекта/раздела за счёт предзагрузки данных в фоне.\n\n## Текущее поведение\n- При клике на объект → `useSectionsBatch` начинает загрузку\n- Пока `batchLoading === true`, показывается строка 'Загрузка данных...'\n- Есть частичный prefetch при hover (только для чекпоинтов)\n- staleTime: Infinity (данные кешируются навсегда)\n\n## Проблема\n- Пользователь видит строку загрузки при каждом первом развороте объекта\n- Создаёт ощущение медленной работы\n- Даже при быстром hover и клике — не успевает прогрузиться\n\n## Анализ вариантов\n\n### Вариант 1: Eager Loading (Жадная загрузка) ❌\n- Грузить batch данные для ВСЕХ объектов сразу при загрузке графика\n- Плюсы: нет задержки при развороте\n- Минусы: огромная начальная загрузка, много лишних данных\n- Вердикт: НЕ подходит для больших проектов\n\n### Вариант 2: Background Prefetch ✅ РЕКОМЕНДУЕТСЯ\n- После загрузки основных данных графика, в фоне грузить batch данные\n- Приоритизация: первые N объектов (видимые на экране)\n- Используем `queryClient.prefetchQuery` в idle time\n- Плюсы: нет задержки для пользователя, оптимальная нагрузка\n- Минусы: сложнее в реализации\n\n### Вариант 3: Prefetch on Hover ✅ В ДОПОЛНЕНИЕ\n- Расширить существующий prefetch при hover на весь `useSectionsBatch`\n- Сейчас: только чекпоинты через `prefetchForSections`\n- Нужно: добавить `prefetchQuery` для `queryKeys.resourceGraph.sectionsBatch(objectId)`\n- Плюсы: мгновенный результат для вдумчивых пользователей\n- Минусы: не помогает при быстром клике\n\n### Вариант 4: Skeleton UI ✅ В ДОПОЛНЕНИЕ\n- Вместо строки 'Загрузка данных...' показывать skeleton разделов\n- Плюсы: лучший UX, ощущение скорости\n- Минусы: не решает проблему, только маскирует\n\n## Рекомендуемое решение: Вариант 2 + 3 + 4\n\n### Шаг 1: Prefetch on Hover (быстрая победа)\n```typescript\n// ObjectRow.tsx - расширить handleMouseEnter\nconst handleMouseEnter = useCallback(() => {\n  if (!isExpanded && sectionIds.length > 0) {\n    // Существующий prefetch чекпоинтов\n    prefetchForSections(sectionIds)\n    prefetchProjectSections(object.sections[0].id)\n    \n    // НОВОЕ: prefetch batch данных\n    queryClient.prefetchQuery({\n      queryKey: queryKeys.resourceGraph.sectionsBatch(object.id),\n      queryFn: () => getSectionsBatchData(sectionIds),\n      staleTime: Infinity,\n    })\n  }\n}, [...])\n```\n\n### Шаг 2: Background Prefetch (основное решение)\n```typescript\n// hooks/usePrefetchSectionsBatch.ts\nexport function usePrefetchSectionsBatch(objects: ProjectObject[]) {\n  const queryClient = useQueryClient()\n  \n  useEffect(() => {\n    // Ждём idle time браузера\n    const prefetchNext = () => {\n      requestIdleCallback(() => {\n        // Берём первые N объектов которые ещё не в кеше\n        const toPrefetch = objects\n          .filter(obj => {\n            const cached = queryClient.getQueryData(\n              queryKeys.resourceGraph.sectionsBatch(obj.id)\n            )\n            return !cached && obj.sections.length > 0\n          })\n          .slice(0, 3) // Batch по 3 объекта\n        \n        toPrefetch.forEach(obj => {\n          queryClient.prefetchQuery({\n            queryKey: queryKeys.resourceGraph.sectionsBatch(obj.id),\n            queryFn: () => getSectionsBatchData(obj.sections.map(s => s.id)),\n            staleTime: Infinity,\n          })\n        })\n        \n        // Продолжаем если есть ещё\n        if (toPrefetch.length > 0) {\n          setTimeout(prefetchNext, 1000) // Пауза между батчами\n        }\n      })\n    }\n    \n    // Начинаем через 2 секунды после загрузки графика\n    const timer = setTimeout(prefetchNext, 2000)\n    return () => clearTimeout(timer)\n  }, [objects, queryClient])\n}\n```\n\n### Шаг 3: Skeleton UI вместо 'Загрузка данных...'\n```typescript\n// Заменить строку загрузки на skeleton разделов\n{batchLoading && (\n  <>\n    {section.decompositionStages.slice(0, 3).map((stage, i) => (\n      <div key={i} className=\"animate-pulse h-10 bg-muted/20 border-b\" />\n    ))}\n  </>\n)}\n```\n\n## Технические детали\n- Использовать `requestIdleCallback` для фоновой загрузки\n- Fallback на `setTimeout` для Safari\n- Не блокировать UI при prefetch\n- Ограничить concurrent prefetch (max 3 объекта одновременно)\n- Инвалидация через Realtime работает как прежде",
      "category": "performance",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-05",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/ObjectRow.tsx",
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/hooks/usePrefetchSectionsBatch.ts",
        "modules/resource-graph/hooks/index.ts",
        "modules/resource-graph/components/ResourceGraph.tsx"
      ],
      "estimatedHours": 4,
      "acceptanceCriteria": [
        "Строка 'Загрузка данных...' больше не появляется (или появляется редко)",
        "При hover на кнопку развёртывания начинается prefetch",
        "Фоновая загрузка первых N объектов после initial load",
        "Skeleton UI показывается вместо текста при загрузке",
        "Нет деградации производительности на больших проектах",
        "requestIdleCallback с fallback на setTimeout"
      ],
      "technicalNotes": {
        "currentPrefetch": "Только чекпоинты при hover (prefetchForSections, prefetchProjectSections)",
        "targetPrefetch": "Весь useSectionsBatch + фоновая предзагрузка",
        "cacheStrategy": "staleTime: Infinity — данные не устаревают, обновляются через Realtime",
        "prioritization": "Первые объекты (видимые) → остальные в idle time",
        "browserSupport": "requestIdleCallback с fallback на setTimeout для Safari"
      }
    },
    {
      "id": "RG-019",
      "title": "Упростить кнопку Разместить - авто-размещение на 10 дней",
      "description": "При нажатии кнопки 'Разместить' автоматически устанавливать даты раздела: от сегодня на 10 дней вперёд, без открытия popover выбора дат.\n\n## Проблема\nPopover выбора дат в InlineDateRangeSelect выходит за пределы sticky sidebar и 'теряется'.\n\n## Решение\nВместо popover - мгновенное сохранение дат: startDate = today, endDate = today + 10 days.",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "completedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/shared/InlineDateRangeSelect.tsx"
      ],
      "estimatedHours": 0.5
    },
    {
      "id": "RG-020",
      "title": "Убрать инлайн выбор ответственного - открывать модалку",
      "description": "Заменить InlineResponsibleSelect на открытие SectionModal при клике на аватар.\n\n## Проблема\nDropdown с поиском пользователей выходит за пределы sticky sidebar и 'теряется'.\n\n## Решение\nПри клике на аватар открывать SectionModal, где можно изменить ответственного через полноценный UI.",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "completedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/shared/InlineResponsibleSelect.tsx"
      ],
      "estimatedHours": 0.5
    },
    {
      "id": "RG-021",
      "title": "[Bug] Элементы timeline просвечивают через sticky sidebar",
      "description": "Элементы графика (ручки перетаскивания сроков раздела, чекпоинты, tooltips) просвечивают через sticky sidebar при горизонтальном скролле.\n\n## Проблема\nНа скриншоте видно что:\n- Оранжевые ручки перетаскивания дат раздела видны поверх сайдбара\n- Чекпоинты (голубые маркеры) просвечивают\n- Tooltips чекпоинтов ('Чекпоинт') отображаются поверх сайдбара\n\n## Причина\nz-index элементов timeline выше чем z-index sticky sidebar, либо sidebar не имеет background.\n\n## Решение\n1. Добавить/увеличить z-index для sticky sidebar\n2. Убедиться что sidebar имеет solid background (не transparent)\n3. Проверить что все interactive элементы timeline имеют z-index ниже sidebar",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-06",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/ResourceGraphTimeline.tsx",
        "modules/resource-graph/components/timeline/shared/index.ts"
      ],
      "estimatedHours": 1,
      "acceptanceCriteria": [
        "Ручки перетаскивания дат НЕ видны поверх сайдбара при скролле",
        "Чекпоинты НЕ просвечивают через сайдбар",
        "Tooltips скрываются под сайдбаром при скролле",
        "Sidebar имеет solid background"
      ]
    },
    {
      "id": "RG-022",
      "title": "[Bug] Элементы просвечивают в щелях между строками",
      "description": "В промежутках (gaps) между строками разделов видны элементы из соседних строк.\n\n## Проблема\nПри скролле или при определённом положении элементы timeline (графики, чекпоинты) видны в щелях между строками.\n\n## Причина\nВозможно:\n1. Строки имеют gap/margin без background\n2. border-b создаёт щель без перекрытия\n3. Элементы имеют overflow: visible и выходят за границы строки\n\n## Решение\n1. Убедиться что каждая строка имеет solid background на всю высоту\n2. Добавить overflow: hidden для timeline части строки\n3. Или использовать negative margin для перекрытия",
      "category": "bug",
      "priority": "medium",
      "status": "done",
      "completedAt": "2026-01-06",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/rows/ObjectRow.tsx",
        "modules/resource-graph/components/timeline/rows/ProjectRow.tsx"
      ],
      "estimatedHours": 1,
      "acceptanceCriteria": [
        "Элементы НЕ просвечивают между строками",
        "Строки имеют solid background без щелей",
        "При скролле нет визуальных артефактов"
      ]
    },
    {
      "id": "RG-023",
      "title": "Кнопка 'Разместить' для этапа декомпозиции",
      "description": "Добавить кнопку 'Разместить' для этапов декомпозиции без дат, аналогично разделам.\n\n## Текущее поведение\n- Для разделов без дат есть кнопка 'Разместить' которая устанавливает даты от сегодня на 10 дней\n- Для этапов декомпозиции такой кнопки нет\n\n## Целевое поведение\n- Если у этапа нет startDate/finishDate, показывать кнопку 'Разместить'\n- При клике: startDate = today, finishDate = today + 10 days\n- Стиль кнопки идентичен кнопке в SectionRow\n\n## Реализация\nПереиспользовать логику из SectionRow → InlineDateRangeSelect, адаптировать для DecompositionStageRow.",
      "category": "feature",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/DecompositionStageRow.tsx",
        "modules/resource-graph/actions/index.ts"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "Для этапов без дат отображается кнопка 'Разместить'",
        "Клик устанавливает даты: today → today+10 days",
        "После размещения появляется рамка с возможностью resize",
        "Стиль кнопки соответствует кнопке в SectionRow"
      ]
    },
    {
      "id": "RG-024",
      "title": "[Bug] Модалка этапа: даты вылезают за экран",
      "description": "В модалке этапа декомпозиции (DecompositionStageModal) поля дат вылезают за границы экрана и создают горизонтальный скролл.\n\n## Проблема\n- DateRangePicker или отдельные поля дат слишком широкие\n- Не вписываются в ширину модалки\n- Появляется горизонтальный скролл в модалке\n\n## Решение\n1. Использовать responsive layout для полей дат\n2. На мобильных/узких экранах размещать даты вертикально\n3. Ограничить max-width input полей\n4. Использовать compact date format если нужно",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-06",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/modals/components/stage/DecompositionStageModal.tsx"
      ],
      "estimatedHours": 1,
      "acceptanceCriteria": [
        "Даты полностью видны в модалке без горизонтального скролла",
        "На узких экранах layout адаптируется",
        "Модалка не создаёт overflow на body"
      ]
    },
    {
      "id": "RG-025",
      "title": "[Research] Загрузка чекпоинтов вместе с данными раздела",
      "description": "Проанализировать возможность загрузки чекпоинтов в составе getSectionsBatchData вместо отдельного запроса.\n\n## Текущее поведение\n- Чекпоинты загружаются отдельным запросом useCheckpoints(sectionId)\n- Есть prefetch через usePrefetchCheckpoints\n- Это создаёт дополнительный round-trip к серверу\n\n## Вопросы для исследования\n1. Насколько увеличится payload getSectionsBatchData при добавлении чекпоинтов?\n2. Можно ли добавить чекпоинты в view_section_checkpoints как часть batch query?\n3. Какой прирост производительности даст объединение запросов?\n4. Не сломает ли это существующую логику prefetch?\n\n## План анализа\n1. Измерить текущее время загрузки чекпоинтов отдельно\n2. Проверить структуру getSectionsBatchData\n3. Попробовать добавить чекпоинты в batch\n4. Измерить разницу в производительности\n5. Оценить сложность рефакторинга",
      "category": "research",
      "priority": "low",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-06",
      "updatedAt": "2026-01-06",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/actions/index.ts",
        "modules/resource-graph/hooks/index.ts",
        "modules/checkpoints/hooks/index.ts"
      ],
      "estimatedHours": 2,
      "deliverables": [
        "Отчёт с замерами производительности",
        "Рекомендация: объединять или оставить раздельно",
        "План рефакторинга (если объединять)"
      ]
    },
    {
      "id": "RG-026",
      "title": "[Bug] Аватар пользователя отображает 'UNDEFINED' вместо инициалов",
      "description": "На вкладке 'Отделы' внутри команды ГР-2 на аватарке пользователя vladimir.nesterovich@enecagroup.com отображается текст 'UNDEFINED' вместо аватара или инициалов имени.\n\n## Проблема\n- В компоненте Avatar fallback показывает строку 'UNDEFINED'\n- Ожидается: либо аватар пользователя (если есть), либо первые буквы имени (например 'ВН' для Владимира Нестеровича)\n\n## Воспроизведение\n1. Открыть страницу /dashboard/tasks\n2. Перейти на вкладку 'Отделы'\n3. Открыть команду ГР-2\n4. Найти пользователя vladimir.nesterovich@enecagroup.com\n5. Наблюдать: на аватарке отображается 'UNDEFINED'\n\n## Возможные причины\n1. Поле `name` или `display_name` у пользователя не заполнено в БД\n2. Компонент AvatarFallback получает `undefined` вместо строки инициалов\n3. Функция генерации инициалов возвращает undefined при пустом имени\n4. Отсутствует fallback на email при пустом имени\n\n## Решение\n1. Проверить данные пользователя в таблице profiles (полнота полей name, display_name, email)\n2. Добавить fallback в компонент Avatar: если имя пустое, использовать email для генерации инициалов\n3. Добавить защиту в функцию генерации инициалов: возвращать первые 2 буквы email если имя отсутствует\n4. Пример: 'vladimir.nesterovich@enecagroup.com' → 'VN'",
      "category": "bug",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-08",
      "updatedAt": "2026-01-08",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/rows/DecompositionStageRow.tsx",
        "modules/resource-graph/components/timeline/LoadingBadges.tsx",
        "modules/resource-graph/components/timeline/LoadingBars.tsx",
        "shared/components/Avatar.tsx",
        "shared/utils/getInitials.ts"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "Аватар НЕ показывает 'UNDEFINED' ни при каких обстоятельствах",
        "Если имя пользователя пустое, используются инициалы из email",
        "Для vladimir.nesterovich@enecagroup.com отображается корректный fallback (инициалы или аватар)",
        "Все аватары в модуле resource-graph корректно отображают инициалы"
      ]
    },
    {
      "id": "RG-027",
      "title": "[Bug] При hover на строку сотрудника пропадает отображение выходных и сегодняшнего дня",
      "description": "При наведении курсора на строку сотрудника (DecompositionStageRow с загрузками) пропадает цветовое выделение выходных дней и сегодняшнего дня на timeline.\n\n## Проблема\n- TimelineGrid отображает фоны для выходных (серый/amber) и сегодняшнего дня (primary)\n- При hover на строку DecompositionStageRow эти фоны пропадают\n- Пользователь теряет визуальную ориентацию по датам во время наведения\n\n## Ожидаемое поведение\n- При hover на строку команды или отдела фоны выходных и сегодняшнего дня сохраняются\n- Hover эффект должен быть виден, но НЕ должен перекрывать фоновые индикаторы дат\n- Аналогично поведению в ProjectRow, ObjectRow, SectionRow\n\n## Возможные причины\n1. Строка DecompositionStageRow имеет класс 'group' но не имеет явного hover:bg-* стиля\n2. Возможно применяется глобальный CSS для .group:hover который перекрывает TimelineGrid\n3. z-index TimelineGrid ниже чем hover overlay\n4. Hover эффект использует непрозрачный фон вместо полупрозрачного\n\n## Решение\n1. Проверить есть ли hover:bg-* на строке DecompositionStageRow\n2. Если есть hover эффект, убедиться что он использует полупрозрачный фон (bg-muted/10 вместо bg-muted)\n3. Или применить hover эффект только к sidebar части, не затрагивая timeline область\n4. Проверить z-index: TimelineGrid должен быть выше hover overlay\n5. Альтернативно: применить pointer-events-none к TimelineGrid и mix-blend-mode для корректного наложения",
      "category": "bug",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-08",
      "updatedAt": "2026-01-08",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/rows/DecompositionStageRow.tsx",
        "modules/resource-graph/components/timeline/shared/TimelineGrid.tsx",
        "modules/resource-graph/components/timeline/rows/BaseRow.tsx"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "При hover на строку сотрудника фоны выходных дней остаются видимыми",
        "При hover на строку сотрудника фон сегодняшнего дня остаётся видимым",
        "Hover эффект на строку всё ещё виден (например, на sidebar части)",
        "Поведение консистентно со всеми другими типами строк (ProjectRow, ObjectRow, SectionRow)",
        "UX: пользователь не теряет визуальную ориентацию по датам при наведении"
      ]
    },
    {
      "id": "RG-028",
      "title": "[Bug] Модалка актуализации данных не соответствует теме пользователя",
      "description": "При нажатии на точку актуальности (FreshnessIndicator) для актуализации данных модальное окно отображается в светлой теме, хотя пользователь работает в тёмной теме.\n\n## Проблема\n- Пользователь работает в тёмной теме\n- При клике на точку актуальности открывается модалка 'Актуализировать данные?'\n- Модалка отображается в светлой теме (белый фон, тёмный текст)\n- Это создаёт визуальный диссонанс и плохой UX\n\n## Ожидаемое поведение\n- Модалка должна соответствовать текущей теме пользователя\n- Если пользователь в тёмной теме → модалка тёмная\n- Если пользователь в светлой теме → модалка светлая\n\n## Причина\n- В TeamRow.tsx на строке 102: `theme=\"light\"` - хардкод светлой темы\n- В DepartmentRow.tsx аналогичная проблема\n- Нужно передавать актуальную тему пользователя из useTheme() или аналога\n\n## Решение\n1. Импортировать useTheme() hook в TeamRow.tsx и DepartmentRow.tsx\n2. Получить текущую тему: `const { theme } = useTheme()`\n3. Передать динамическую тему в FreshnessIndicator:\n   ```typescript\n   <FreshnessIndicator\n     theme={theme === 'dark' ? 'dark' : 'light'}\n     // ... other props\n   />\n   ```\n4. Убедиться что все места использования FreshnessIndicator обновлены",
      "category": "bug",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-08",
      "updatedAt": "2026-01-08",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/departments-timeline/components/timeline/TeamRow.tsx",
        "modules/departments-timeline/components/timeline/DepartmentRow.tsx"
      ],
      "estimatedHours": 1,
      "acceptanceCriteria": [
        "Модалка актуализации отображается в тёмной теме когда пользователь в тёмной теме",
        "Модалка актуализации отображается в светлой теме когда пользователь в светлой теме",
        "Тема модалки переключается автоматически при смене темы пользователем",
        "Все использования FreshnessIndicator используют динамическую тему"
      ]
    },
    {
      "id": "RG-029",
      "title": "[Bug] Точка актуальности не обновляется после подтверждения актуализации",
      "description": "После подтверждения актуализации данных в модалке точка актуальности (FreshnessIndicator) не меняет свой цвет до перезагрузки страницы.\n\n## Проблема\n- Точка актуальности жёлтая/красная (данные устарели на 3+ дней)\n- Пользователь нажимает на точку → открывается модалка 'Актуализировать данные?'\n- Пользователь нажимает 'Подтвердить'\n- Модалка закрывается, но точка остаётся жёлтой/красной\n- Только после полной перезагрузки страницы (F5) точка становится зелёной\n\n## Ожидаемое поведение\n- После нажатия 'Подтвердить' точка должна мгновенно стать зелёной\n- daysSinceUpdate должен обновиться до 0\n- lastUpdate должен обновиться до текущей даты/времени\n- Не должна требоваться перезагрузка страницы\n\n## Причина\n- В FreshnessIndicator.tsx после успешного подтверждения (строка 198) просто закрывается модалка\n- Нет optimistic update локального состояния компонента\n- Нет invalidation кэша React Query для обновления данных из БД\n- Компонент продолжает рендерить старые props `daysSinceUpdate` до следующего refetch\n\n## Решение\n\n### Вариант 1: Invalidation кэша (рекомендуется)\n1. После успешного onConfirm вызвать invalidation:\n   ```typescript\n   if (result.success) {\n     await queryClient.invalidateQueries({ \n       queryKey: ['departmentsTimeline'] \n     })\n     onClose()\n   }\n   ```\n2. React Query автоматически перезапросит данные\n3. Компонент получит новые props с обновлённым daysSinceUpdate\n\n### Вариант 2: Optimistic update\n1. Добавить локальное состояние в FreshnessIndicator:\n   ```typescript\n   const [optimisticUpdate, setOptimisticUpdate] = useState<Date | null>(null)\n   const effectiveDaysSinceUpdate = optimisticUpdate ? 0 : daysSinceUpdate\n   ```\n2. После подтверждения установить optimisticUpdate:\n   ```typescript\n   if (result.success) {\n     setOptimisticUpdate(new Date())\n     onClose()\n   }\n   ```\n\n### Вариант 3: Callback с новыми данными\n1. onConfirm возвращает новые данные:\n   ```typescript\n   onConfirm: (teamId) => Promise<{ \n     success: boolean\n     data?: { daysSinceUpdate: number, lastUpdate: Date }\n   }>\n   ```\n2. Родительский компонент обновляет state",
      "category": "bug",
      "priority": "high",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-08",
      "updatedAt": "2026-01-08",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "components/shared/timeline/FreshnessIndicator.tsx",
        "modules/departments-timeline/hooks/index.ts",
        "modules/departments-timeline/components/timeline/TeamRow.tsx",
        "modules/departments-timeline/components/timeline/DepartmentRow.tsx"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "После нажатия 'Подтвердить' точка актуальности мгновенно становится зелёной",
        "Не требуется перезагрузка страницы для обновления цвета точки",
        "daysSinceUpdate обновляется до 0 сразу после подтверждения",
        "lastUpdate обновляется до текущей даты/времени сразу после подтверждения",
        "Tooltip точки показывает 'Обновлено сегодня' сразу после подтверждения",
        "Если актуализация не удалась (ошибка сервера), точка остаётся в прежнем состоянии"
      ]
    },
    {
      "id": "RG-030",
      "title": "[Bug] Фильтры по проекту, ответственному и метке не работают на вкладке Отделы",
      "description": "На вкладке 'Отделы' фильтры по проекту, ответственному и метке не применяются — отображаются все отделы и команды, хотя ожидается фильтрация только задействованных отделов/команд/сотрудников.\n\n## Проблема 1: Фильтр по проекту\n- Пользователь выбирает проект в InlineFilter на вкладке 'Отделы'\n- Timeline отображает все отделы, команды и сотрудников\n- Ожидается: должны отображаться только те отделы/команды/сотрудники, у которых есть загрузки (loadings) в выбранном проекте\n\n## Проблема 2: Фильтр по ответственному (responsible_id)\n- Пользователь выбирает конкретного сотрудника в фильтре\n- Timeline отображает все отделы и команды\n- Ожидается: должны отображаться только отдел и команда, в которых работает этот сотрудник\n- ПРИМЕЧАНИЕ: Сам сотрудник фильтруется корректно (строка 181-187), НО его отдел и команда всё равно показывают всех остальных сотрудников\n\n## Проблема 3: Фильтр по метке (tag_id)\n- Пользователь выбирает метку проекта в фильтре\n- Timeline отображает все отделы и команды\n- Ожидается: должны отображаться только отделы/команды/сотрудники, работающие над проектами с этой меткой\n- ПРИМЕЧАНИЕ: Фильтр по метке вообще не реализован в getDepartmentsData\n\n## Воспроизведение\n\n### Для фильтра по проекту:\n1. Открыть страницу /dashboard/tasks\n2. Перейти на вкладку 'Отделы'\n3. В InlineFilter выбрать конкретный проект (например, 'Проект А')\n4. Наблюдать: отображаются все отделы, а не только те, что работают над 'Проект А'\n\n### Для фильтра по ответственному:\n1. В InlineFilter выбрать конкретного сотрудника (например, 'Иванов Иван')\n2. Наблюдать: отображаются все отделы и все сотрудники в командах, хотя должна быть видна только команда Иванова\n\n### Для фильтра по метке:\n1. В InlineFilter выбрать метку проекта (например, 'Срочно')\n2. Наблюдать: отображаются все отделы, фильтр не применяется\n\n## Причина\nВ getDepartmentsData (modules/departments-timeline/actions/index.ts) отсутствует корректная обработка фильтров:\n\n### Для проекта:\n- Строки 94-148: есть фильтры по subdivision_id, department_id, team_id, но НЕТ project_id\n- Строки 161-188: employeeQuery фильтруется по department/team/responsible, но НЕ по project_id\n- Загрузки (loadings) в view_employee_workloads содержат project_id, но фильтр не применяется\n\n### Для ответственного:\n- Строка 181-187: фильтр по responsible_id ЕСТЬ и работает для employeeQuery\n- НО orgQuery (строка 92-150) НЕ фильтруется по ответственному\n- Результат: возвращаются все команды и отделы, даже если в них нет отфильтрованных сотрудников\n\n### Для метки:\n- Фильтр по tag_id вообще не реализован\n- Нужно джойнить project_tag_links для получения проектов с меткой\n- Затем фильтровать loadings по этим проектам\n\n## Решение\n\n### Для проекта (project_id):\n```typescript\n// После строки 165 в employeeQuery\nif (secureFilters?.project_id) {\n  if (isUuid(secureFilters.project_id)) {\n    employeeQuery = employeeQuery.eq('project_id', secureFilters.project_id)\n  } else {\n    employeeQuery = employeeQuery.ilike('project_name', `%${secureFilters.project_id}%`)\n  }\n}\n```\n\n### Для метки (tag_id):\n```typescript\n// После фильтра по project_id\nif (secureFilters?.tag_id) {\n  // Получаем проекты с этой меткой\n  const { data: taggedProjects } = await supabase\n    .from('project_tag_links')\n    .select('project_id')\n    .eq('tag_id', secureFilters.tag_id)\n  \n  const projectIds = taggedProjects?.map(p => p.project_id) || []\n  if (projectIds.length > 0) {\n    employeeQuery = employeeQuery.in('project_id', projectIds)\n  } else {\n    return { success: true, data: [] }\n  }\n}\n```\n\n### Для всех фильтров: Очистка пустых элементов\nПосле сборки иерархии (после строки 332) удалить пустые команды и отделы:\n```typescript\n// Удаляем команды без сотрудников\ndepartments.forEach((dept) => {\n  dept.teams = dept.teams.filter(team => team.employees.length > 0)\n})\n\n// Удаляем отделы без команд\nconst filteredDepartments = departments.filter(dept => dept.teams.length > 0)\n\nreturn { success: true, data: filteredDepartments }\n```\n\nЭто решит проблему с ответственным: если у команды не осталось сотрудников после фильтрации, команда не отобразится.\n\n## Дополнительные проверки\n- Убедиться что view_employee_workloads содержит корректный project_id для всех загрузок\n- Протестировать фильтрацию по UUID проекта и по названию проекта\n- Протестировать фильтр по ответственному: должна отображаться только его команда\n- Протестировать фильтр по метке: должны отображаться только проекты с этой меткой\n- Проверить что при сбросе фильтра отображаются все отделы обратно\n- Протестировать комбинацию фильтров (проект + ответственный)",
      "category": "bug",
      "priority": "high",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-08",
      "updatedAt": "2026-01-08",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/departments-timeline/actions/index.ts"
      ],
      "estimatedHours": 4,
      "acceptanceCriteria": [
        "ПРОЕКТ: При выборе проекта отображаются только отделы/команды с загрузками в этом проекте",
        "ПРОЕКТ: Фильтрация работает как по UUID проекта, так и по названию проекта",
        "ПРОЕКТ: dailyWorkloads корректно вычисляются только для загрузок выбранного проекта",
        "ОТВЕТСТВЕННЫЙ: При выборе сотрудника отображается только его отдел и команда",
        "ОТВЕТСТВЕННЫЙ: В команде отображается только выбранный сотрудник, остальные скрыты",
        "ОТВЕТСТВЕННЫЙ: Фильтрация работает как по UUID сотрудника, так и по имени",
        "МЕТКА: При выборе метки отображаются только отделы/команды, работающие над проектами с этой меткой",
        "МЕТКА: Фильтр корректно работает с project_tag_links",
        "ОБЩЕЕ: Пустые отделы/команды не отображаются при активных фильтрах",
        "ОБЩЕЕ: При сбросе фильтров отображаются все отделы обратно",
        "ОБЩЕЕ: Комбинация фильтров работает корректно (например, проект + ответственный)",
        "ОБЩЕЕ: dailyWorkloads корректно агрегируются только для отфильтрованных данных"
      ]
    },
    {
      "id": "RG-031",
      "title": "[Refactor] Удалить функциональность expand/collapse controls",
      "description": "Полностью удалить кнопки \"Развернуть все\", \"Развернуть до разделов\", \"Свернуть все\" и всю связанную с ними логику из модуля resource-graph.\n\n## Причины удаления\n1. **Проблемы с производительностью:**\n   - При нажатии \"Развернуть все\" страница зависает/падает (RG-031)\n   - Лаги при раскрытии до разделов (RG-032)\n   - Невозможно эффективно реализовать без виртуализации\n\n2. **Низкая ценность для пользователя:**\n   - Функция редко используется\n   - При большом количестве данных бесполезна (всё равно нужно скроллить)\n   - Лучше пользователь раскрывает только то что ему нужно\n\n3. **Альтернативы:**\n   - Браузерный поиск (Ctrl+F) для быстрого нахождения нужного элемента\n   - Фильтры для сужения списка проектов/разделов\n   - Ручное раскрытие конкретных узлов по клику\n\n## Что удалить\n\n### 1. Компонент ExpandCollapseControls\n```bash\nmodules/resource-graph/components/timeline/ExpandCollapseControls.tsx\n```\n- Удалить файл полностью\n- Убрать импорты из ResourceGraphInternal.tsx\n\n### 2. State в stores/ui-state.ts\nУдалить методы (если они есть):\n```typescript\n// Удалить:\nexpandAll: () => void\ncollapseAll: () => void\nexpandToLevel: (level: 'objects' | 'sections') => void\n```\n\nОставить только:\n```typescript\n// Оставить для ручного раскрытия:\ntoggleProject: (id: string) => void\ntoggleObject: (id: string) => void\ntoggleSection: (id: string) => void\nexpandedProjects: Set<string>\nexpandedObjects: Set<string>\nexpandedSections: Set<string>\n```\n\n### 3. Связанная логика\n- Удалить обработчики событий для expand/collapse all\n- Удалить utility функции для batch expand/collapse\n- Убрать тесты для этой функциональности (если есть)\n- Очистить типы и интерфейсы\n\n### 4. UI элементы\n- Удалить кнопки из toolbar/header\n- Убрать горячие клавиши (если назначены)\n- Убрать tooltips и hint texts\n\n## Что ОСТАВИТЬ\n\n✅ Индивидуальное раскрытие/сворачивание по клику на chevron\n✅ expandedProjects/Objects/Sections state для хранения раскрытых элементов\n✅ toggle методы для ручного управления\n✅ Персистентность состояния (если сохраняется в localStorage/URL)\n\n## Шаги реализации\n\n1. Удалить импорт ExpandCollapseControls из ResourceGraphInternal.tsx\n2. Удалить файл ExpandCollapseControls.tsx\n3. Очистить stores/ui-state.ts от методов expandAll/collapseAll\n4. Проверить что ничего не сломалось (npm run build)\n5. Убрать связанные типы/интерфейсы\n6. Обновить документацию модуля\n\n## Альтернативное решение (если передумаем)\n\nЕсли всё же нужна функция \"Развернуть всё\":\n1. Реализовать виртуализацию (react-window)\n2. Добавить ограничение max 100 элементов одновременно\n3. Показывать warning при большом количестве элементов\n4. Использовать Web Workers для тяжёлых вычислений\n\nНо проще просто удалить эту функцию.",
      "category": "refactor",
      "priority": "medium",
      "status": "done",
      "completedAt": "2026-01-29",
      "assignee": null,
      "createdAt": "2026-01-29",
      "updatedAt": "2026-01-29",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/timeline/ExpandCollapseControls.tsx",
        "modules/resource-graph/components/ResourceGraphInternal.tsx",
        "modules/resource-graph/stores/ui-state.ts"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "Файл ExpandCollapseControls.tsx удалён",
        "Кнопки \"Развернуть все\", \"Развернуть до разделов\", \"Свернуть все\" отсутствуют в UI",
        "Методы expandAll/collapseAll удалены из store",
        "Индивидуальное раскрытие по клику на chevron работает корректно",
        "npm run build проходит без ошибок",
        "README модуля обновлён (удалена документация по expand/collapse)"
      ]
    },
    {
      "id": "RG-033",
      "title": "[Bug] Rollback дат при сдвиге граней загрузки на timeline",
      "description": "При drag-resize граней загрузки сотрудника на timeline происходит rollback дат — они визуально меняются, но через мгновение возвращаются к старым значениям.\n\n## Проблема\n- Пользователь сдвигает левую или правую грань загрузки на timeline (drag-resize)\n- Визуально даты меняются (optimistic update)\n- Через ~200-500ms даты откатываются обратно к старым значениям\n- В БД изменения сохраняются, но UI не синхронизируется\n\n## Причина\nOptimistic update в `useUpdateLoadingDates` обновляет только кэш `resourceGraph.loadings(sectionId)`, но НЕ обновляет `sectionsBatch`, который используется для отображения на timeline. После мутации приходят старые данные и происходит rollback.\n\n## Решение\nДобавить `invalidateKeys` для `sectionsBatch` в хук `useUpdateLoadingDates` чтобы после мутации перезапрашивались свежие данные из БД.",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "completedAt": "2026-01-28",
      "assignee": null,
      "createdAt": "2026-01-28",
      "updatedAt": "2026-01-28",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/hooks/index.ts"
      ],
      "estimatedHours": 1,
      "acceptanceCriteria": [
        "При drag-resize граней загрузки даты НЕ откатываются к старым значениям",
        "Optimistic update: загрузка сразу отображается по новым датам",
        "После refetch данные из БД соответствуют отображаемым на UI",
        "Инвалидация кэша sectionsBatch происходит после мутации",
        "UX: пользователь не видит 'rollback' эффекта"
      ]
    },
    {
      "id": "RG-034",
      "title": "[Bug] Дата дедлайна чекпоинта отображается на день меньше",
      "description": "На timeline графика дата дедлайна чекпоинта отображается на день раньше чем должна быть.\n\n## Проблема\n- В БД чекпоинт имеет deadline_date = '2026-01-15'\n- На timeline чекпоинт отображается 14 января (на день раньше)\n- При наведении tooltip также показывает 14 января\n- В модалке чекпоинта дата отображается корректно: 15 января\n\n## Воспроизведение\n1. Создать чекпоинт с deadline_date = '2026-01-20'\n2. Открыть график ресурсов\n3. Найти чекпоинт на timeline\n4. Наблюдать: чекпоинт отображается на позиции 19 января\n5. Открыть модалку чекпоинта → дата корректная: 20 января\n\n## Причина\n\n### Timezone off-by-one error\n\nВ БД хранится `deadline_date: date` (без времени):\n```sql\ndeadline_date | date | '2026-01-15'\n```\n\nПри парсинге в JavaScript:\n```typescript\nconst date = new Date('2026-01-15') // ISO string без timezone\n// Результат: 2026-01-14T21:00:00.000Z (UTC)\n// В Минске (UTC+3): 2026-01-15 00:00:00 ✅\n// НО при рендере на timeline используется UTC → показывает 14 января ❌\n```\n\n### Проблемное место в коде\n\nВозможно в `CheckpointMarker.tsx` или `utils/timeline-calculations.ts`:\n```typescript\n// WRONG:\nconst xPosition = (new Date(deadline_date).getTime() - startTime) / msPerPixel\n\n// CORRECT:\nconst xPosition = (parseMinskDate(deadline_date).getTime() - startTime) / msPerPixel\n```\n\nИли в `formatDate` utility:\n```typescript\n// WRONG:\nformat(new Date(dateString), 'dd.MM.yyyy')\n\n// CORRECT:\nformatMinskDate(parseMinskDate(dateString), 'dd.MM.yyyy')\n```\n\n## Решение\n\n### 1. Использовать parseMinskDate для deadline_date\n\n```typescript\n// lib/timezone-utils.ts\nimport { parseISO, addHours } from 'date-fns'\n\nexport function parseMinskDate(dateString: string): Date {\n  // Парсим как UTC и добавляем 3 часа для Минска\n  const utcDate = parseISO(dateString + 'T00:00:00Z')\n  return addHours(utcDate, 3)\n}\n```\n\nИспользовать во всех местах где отображается deadline_date:\n```typescript\n// modules/checkpoints/components/CheckpointMarker.tsx\nimport { parseMinskDate } from '@/lib/timezone-utils'\n\nconst deadlineTimestamp = parseMinskDate(checkpoint.deadline_date).getTime()\nconst xPosition = (deadlineTimestamp - timelineStart) / msPerPixel\n```\n\n### 2. Унифицировать форматирование дат\n\n```typescript\n// Везде где показывается дата чекпоинта:\nimport { formatMinskDate, parseMinskDate } from '@/lib/timezone-utils'\n\nconst formattedDate = formatMinskDate(\n  parseMinskDate(checkpoint.deadline_date),\n  'dd.MM.yyyy'\n)\n```\n\n### 3. Проверить все места использования deadline_date\n\nФайлы для проверки:\n- `modules/checkpoints/components/CheckpointMarker.tsx` - рендер на timeline\n- `modules/checkpoints/components/CheckpointTooltip.tsx` - tooltip\n- `modules/modals/components/checkpoint/CheckpointModal.tsx` - модалка (уже корректно?)\n- `modules/resource-graph/utils/timeline-calculations.ts` - вычисления позиции\n\n## Дополнительная проверка\n\nДобавить unit test:\n```typescript\ntest('checkpoint deadline renders on correct date', () => {\n  const checkpoint = { deadline_date: '2026-01-15' }\n  const position = calculateCheckpointPosition(checkpoint, timelineConfig)\n  \n  expect(position.date).toBe('15.01.2026') // Не 14.01.2026!\n})\n```\n\n## Похожие проблемы\n\nПроверить нет ли такой же проблемы с:\n- `section.start_date` / `section.finish_date`\n- `decomposition_stage.start_date` / `finish_date`\n- `loading.start_date` / `finish_date`\n- Все типы `date` (без времени) из БД",
      "category": "bug",
      "priority": "medium",
      "status": "done",
      "completedAt": "2026-01-29",
      "assignee": null,
      "createdAt": "2026-01-28",
      "updatedAt": "2026-01-29",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/checkpoints/components/CheckpointMarker.tsx"
      ],
      "estimatedHours": 2,
      "acceptanceCriteria": [
        "Чекпоинт с deadline_date = '2026-01-15' отображается на timeline 15 января (не 14-го)",
        "Tooltip чекпоинта показывает корректную дату: 15 января",
        "Дата в модалке чекпоинта совпадает с датой на timeline",
        "Все date поля из БД корректно парсятся через parseMinskDate",
        "Нет off-by-one ошибок для start_date/finish_date разделов и этапов",
        "Unit тесты покрывают timezone корректность"
      ]
    },
    {
      "id": "RG-035",
      "title": "[Bug] Отсутствуют оптимистичные обновления при создании загрузки",
      "description": "При создании новой загрузки сотрудника на графике отсутствуют оптимистичные обновления (optimistic updates) для показателей план/факт, освоения бюджета и других метрик раздела.\n\n## Проблема\n- Пользователь создаёт новую загрузку для сотрудника в этапе декомпозиции\n- Загрузка появляется на timeline мгновенно (optimistic update есть для самой loading)\n- НО показатели раздела НЕ обновляются:\n  - Процент освоения бюджета около раздела остаётся прежним\n  - План/Факт показатели не пересчитываются\n  - Прогресс бар раздела не обновляется\n- Только после refetch данных (или обновления страницы) показатели обновляются\n\n## Воспроизведение\n1. Открыть график ресурсов\n2. Раскрыть раздел с этапами\n3. Отметить текущие показатели раздела (например, \"Освоено: 30%\")\n4. Создать новую загрузку в одном из этапов\n5. Наблюдать:\n   - ✅ Загрузка появляется на timeline мгновенно\n   - ❌ Показатели раздела остаются прежними\n   - ❌ Процент освоения всё ещё 30%\n6. Обновить страницу → показатели корректны\n\n## Где отсутствуют optimistic updates\n\n### 1. SectionRow - показатели освоения бюджета\n```typescript\n// modules/resource-graph/components/timeline/rows/SectionRow.tsx\n// Строка ~45-60: показатели бюджета\n<div className=\"text-xs\">\n  Освоено: {section.budget_utilization_percent}% {/* ❌ Не обновляется */}\n</div>\n```\n\n### 2. SectionRow - план/факт часы\n```typescript\n// Строка ~65-75\n<div>\n  План: {section.planned_hours}ч {/* ❌ Не обновляется */}\n  Факт: {section.actual_hours}ч {/* ❌ Не обновляется */}\n</div>\n```\n\n### 3. ProgressBar компонент\n```typescript\n// modules/resource-graph/components/timeline/shared/ProgressBar.tsx\n// Прогресс бар показывает process_percent из БД\n<div style={{ width: `${section.progress_percent}%` }} /> {/* ❌ Не обновляется */}\n```\n\n### 4. Другие метрики\n- Общая загрузка сотрудника (workload indicators)\n- Метрики объекта (агрегация разделов)\n- Метрики проекта (агрегация объектов)\n\n## Причина\n\nВ `useCreateLoading` mutation optimistic update обновляет только массив `loadings`, но НЕ пересчитывает:\n```typescript\n// modules/resource-graph/hooks/index.ts\nexport const useCreateLoading = createCacheMutation({\n  mutationFn: createLoading,\n  onMutate: async (variables) => {\n    // ✅ Обновляем список loadings оптимистично\n    queryClient.setQueryData(['loadings'], (old) => [...old, newLoading])\n    \n    // ❌ НЕ обновляем section metrics\n    // ❌ НЕ обновляем object aggregations\n    // ❌ НЕ обновляем project totals\n  }\n})\n```\n\n## Решение\n\n### Вариант 1: Полный пересчёт в onMutate\n\n```typescript\nexport const useCreateLoading = createCacheMutation({\n  mutationFn: createLoading,\n  onMutate: async (variables) => {\n    const previousData = queryClient.getQueryData(queryKeys.resourceGraph.all())\n    \n    // 1. Добавляем loading оптимистично\n    queryClient.setQueryData(queryKeys.resourceGraph.all(), (old) => {\n      const newLoading = {\n        loading_id: `temp-${Date.now()}`,\n        ...variables,\n        created_at: new Date().toISOString()\n      }\n      \n      // 2. Пересчитываем метрики раздела\n      const updatedData = recalculateSectionMetrics(old, newLoading)\n      \n      // 3. Пересчитываем метрики объекта\n      const finalData = recalculateObjectMetrics(updatedData)\n      \n      return finalData\n    })\n    \n    return { previousData }\n  },\n  onError: (err, variables, context) => {\n    // Откатываем изменения при ошибке\n    queryClient.setQueryData(queryKeys.resourceGraph.all(), context.previousData)\n  }\n})\n```\n\n### Вариант 2: Invalidation вместо optimistic update\n\n```typescript\nexport const useCreateLoading = createCacheMutation({\n  mutationFn: createLoading,\n  onSuccess: async () => {\n    // Сразу после успешного создания инвалидируем кэш\n    await queryClient.invalidateQueries({\n      queryKey: queryKeys.resourceGraph.all()\n    })\n    // React Query автоматически запросит свежие данные с пересчитанными метриками\n  }\n})\n```\n\n### Вариант 3: Гибридный подход (Recommended)\n\n```typescript\nexport const useCreateLoading = createCacheMutation({\n  mutationFn: createLoading,\n  onMutate: async (variables) => {\n    // Optimistic update только для видимой loading bar\n    const newLoading = createOptimisticLoading(variables)\n    addLoadingToCache(newLoading)\n  },\n  onSuccess: async () => {\n    // После успеха сразу refetch для корректных метрик\n    await queryClient.invalidateQueries({\n      queryKey: queryKeys.resourceGraph.all(),\n      refetchType: 'active' // Только активные queries\n    })\n  }\n})\n```\n\n## Utility функции для пересчёта метрик\n\n```typescript\n// modules/resource-graph/utils/metrics-calculator.ts\n\nexport function recalculateSectionMetrics(\n  section: Section,\n  newLoading: Loading\n): Section {\n  // Пересчитываем бюджет\n  const totalBudget = section.budget + newLoading.cost\n  const utilization = (totalBudget / section.planned_budget) * 100\n  \n  // Пересчитываем часы\n  const totalHours = section.actual_hours + newLoading.hours\n  \n  return {\n    ...section,\n    budget_utilization_percent: utilization,\n    actual_hours: totalHours\n  }\n}\n\nexport function recalculateObjectMetrics(\n  object: Object,\n  updatedSection: Section\n): Object {\n  // Агрегируем метрики всех разделов вверх к объекту\n  const sections = object.sections.map(s => \n    s.section_id === updatedSection.section_id ? updatedSection : s\n  )\n  \n  const totalBudget = sections.reduce((sum, s) => sum + s.budget, 0)\n  const totalHours = sections.reduce((sum, s) => sum + s.actual_hours, 0)\n  \n  return {\n    ...object,\n    sections,\n    total_budget: totalBudget,\n    total_hours: totalHours\n  }\n}\n```\n\n## Аналогичные проблемы\n\nПроверить optimistic updates также для:\n- `useUpdateLoading` - обновление существующей загрузки\n- `useDeleteLoading` - удаление загрузки\n- `useCreateCheckpoint` - создание чекпоинта\n- `useUpdateSection` - обновление раздела\n\n## Приоритет\n\nHigh priority для основных операций:\n1. createLoading / updateLoading / deleteLoading\n2. updateSection (изменение дат, бюджета)\n\nMedium priority для остальных:\n3. createCheckpoint\n4. Агрегация метрик вверх по иерархии",
      "category": "bug",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-28",
      "updatedAt": "2026-01-28",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/hooks/index.ts",
        "modules/resource-graph/utils/metrics-calculator.ts",
        "modules/resource-graph/components/timeline/rows/SectionRow.tsx",
        "modules/resource-graph/components/timeline/shared/ProgressBar.tsx"
      ],
      "estimatedHours": 4,
      "acceptanceCriteria": [
        "При создании загрузки показатели освоения бюджета раздела обновляются мгновенно",
        "План/Факт часы раздела обновляются оптимистично",
        "Прогресс бар раздела обновляется без задержки",
        "При ошибке создания загрузки все метрики откатываются к исходным значениям",
        "Optimistic updates работают также для updateLoading и deleteLoading",
        "Метрики объекта и проекта пересчитываются корректно (агрегация вверх)",
        "UX: пользователь видит мгновенную реакцию интерфейса на свои действия"
      ]
    },
    {
      "id": "RG-036",
      "title": "[Feature] Нет пагинации на проектах в графике",
      "description": "В списке проектов на графике ресурсов отсутствует пагинация.\n\n## Проблема\n- При большом количестве проектов (50+) все проекты загружаются одновременно\n- Страница становится медленной\n- Скроллинг затруднён\n- Долгая загрузка initial render\n\n## Решение\nДобавить пагинацию для списка проектов:\n- Server-side pagination в запросе к БД\n- Показывать по 20 проектов на страницу\n- Кнопки \"Загрузить ещё\" или классическая пагинация\n- Сохранять состояние пагинации при переходах\n\n## Затронутые компоненты\n- ProjectList компонент\n- getProjects query\n- Resource Graph store (для сохранения состояния)",
      "category": "feature",
      "priority": "medium",
      "status": "done",
      "completedAt": "2026-01-29",
      "assignee": null,
      "createdAt": "2026-01-29",
      "updatedAt": "2026-01-29",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/components/ProjectList.tsx",
        "modules/resource-graph/hooks/index.ts",
        "modules/resource-graph/actions/index.ts"
      ],
      "estimatedHours": 3,
      "acceptanceCriteria": [
        "Проекты загружаются порциями по 20 штук",
        "Есть UI для перехода между страницами или кнопка \"Загрузить ещё\"",
        "При переходе между страницами состояние сохраняется",
        "Производительность улучшена при большом количестве проектов"
      ]
    },
    {
      "id": "RG-037",
      "title": "[Bug] В разделе даты пофиксить",
      "description": "Проблемы с отображением и обработкой дат в разделах на графике.\n\n## РЕШЕНО: Hard update при изменении дат в модалке раздела\n\n**Проблема:**\n- При изменении даты в модалке раздела (SectionPanel) происходил hard update (немедленное сохранение в БД)\n- Обновление срабатывало ДО того, как пользователь завершил выбор дат\n- При переходе между месяцами в календаре также триггерилась мутация\n\n**Решение:**\n- Разделена логика изменения и сохранения дат:\n  - `handleDatesChange` теперь только обновляет локальное состояние (`pendingRange`)\n  - `handleDatesSave` выполняет фактическое сохранение в БД\n  - `handleDatesCancel` сбрасывает изменения\n- Добавлены явные кнопки \"Сохранить\" и \"Отмена\" под календарем\n- Сохранение происходит только при нажатии кнопки \"Сохранить\"\n\n## Затронутые компоненты\n- components/modals/SectionPanel.tsx (date handling logic)",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-29",
      "updatedAt": "2026-01-29",
      "completedAt": "2026-01-29",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "components/modals/SectionPanel.tsx"
      ],
      "estimatedHours": 2,
      "actualHours": 1,
      "acceptanceCriteria": [
        "✅ Изменение дат в календаре НЕ триггерит update в БД",
        "✅ При переходе между месяцами календаря НЕ происходит сохранения",
        "✅ Сохранение происходит ТОЛЬКО при нажатии кнопки \"Сохранить\"",
        "✅ Кнопка \"Отмена\" корректно сбрасывает локальное состояние"
      ]
    },
    {
      "id": "RG-038",
      "title": "[Refactor] Переделать полностью логику с бюджетами на графике",
      "description": "Текущая логика работы с бюджетами на графике требует полного рефакторинга.\n\n## Проблемы текущей реализации\n- Бюджетные расчёты разбросаны по разным компонентам\n- Сложно отследить откуда берутся значения\n- Проблемы с производительностью при пересчёте\n- Нет единого источника правды для бюджетных данных\n- Путаница между плановым и фактическим бюджетом\n\n## Цели рефакторинга\n1. Централизовать всю логику бюджетов в отдельном модуле\n2. Создать чёткие типы для бюджетных данных\n3. Упростить расчёты освоения бюджета\n4. Улучшить производительность\n5. Сделать код более поддерживаемым\n\n## Предлагаемая структура\n```\nmodules/resource-graph/\n  utils/\n    budget-calculator.ts      # Все расчёты бюджета\n    budget-aggregator.ts      # Агрегация вверх по иерархии\n  types/\n    budget.ts                 # Типы для бюджета\n  hooks/\n    useBudgetMetrics.ts       # Hook для получения метрик\n```\n\n## Что нужно переделать\n- [ ] BudgetSpendingArea компонент\n- [ ] Расчёты budget_utilization_percent\n- [ ] Агрегация бюджета от loadings → stage → section → object → project\n- [ ] Optimistic updates для бюджетных операций\n- [ ] Кэширование бюджетных метрик",
      "category": "refactor",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-29",
      "updatedAt": "2026-01-29",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/resource-graph/utils/budget-calculator.ts",
        "modules/resource-graph/components/timeline/BudgetSpendingArea.tsx",
        "modules/resource-graph/hooks/index.ts",
        "modules/resource-graph/types/budget.ts"
      ],
      "estimatedHours": 8,
      "acceptanceCriteria": [
        "Вся логика бюджетов вынесена в отдельные утилиты",
        "Чёткие типы для всех бюджетных данных",
        "Производительность расчётов улучшена",
        "Код легко читается и поддерживается",
        "Нет дублирования логики",
        "Все тесты проходят"
      ]
    },
    {
      "id": "RG-AUDIT",
      "title": "Full Module Audit: Resource Graph",
      "description": "Полный аудит модуля resource-graph для подтверждения качества перед production.\n\nАудит включает проверку: базы данных, безопасности, бизнес-логики, производительности, качества кода и кэширования.",
      "category": "audit",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 8,
      "checklist": {
        "database": [
          "[ ] Проверить v_resource_graph на N+1 (нет ли вложенных SELECT)",
          "[ ] Проверить индексы на часто фильтруемых полях (project_id, section_id, dates)",
          "[ ] Убедиться что JOIN'ы оптимальны (EXPLAIN ANALYZE на типичных запросах)",
          "[ ] Проверить что не грузятся лишние поля (SELECT * vs SELECT needed_fields)",
          "[ ] Проверить время выполнения getSectionsBatchData < 200ms",
          "[ ] Проверить что loadings грузятся эффективно (batch, не по одной)"
        ],
        "security": [
          "[ ] Все Server Actions имеют auth check (getUser())",
          "[ ] RLS policies покрывают: projects, sections, loadings, checkpoints",
          "[ ] Zod validation на всех входных данных",
          "[ ] Нет hardcoded IDs или secrets",
          "[ ] Permission checks в UI (resource_graph.view, resource_graph.edit_*)"
        ],
        "businessLogic": [
          "[ ] Проценты готовности (П/Ф/Б) считаются корректно для разделов",
          "[ ] Агрегация вверх по иерархии правильная (item → stage → section → object → project)",
          "[ ] Даты периодов отображаются корректно (timezone Europe/Minsk)",
          "[ ] Бюджет раздела = сумма бюджетов этапов + собственный",
          "[ ] Плановые часы раздела = сумма часов задач (с коэффициентами сложности)",
          "[ ] Фактические часы = сумма work_logs за период",
          "[ ] Чекпоинты отображаются в правильных позициях на timeline",
          "[ ] Вертикальные связи чекпоинтов рендерятся корректно",
          "[ ] Drag-resize дат работает и сохраняет корректно",
          "[ ] Edge case: раздел без этапов отображается корректно",
          "[ ] Edge case: раздел без дат показывает 'Разместить'",
          "[ ] Edge case: пустой проект (без объектов) не ломает UI"
        ],
        "performance": [
          "[ ] Начальная загрузка графика < 2 сек",
          "[ ] Раскрытие объекта < 500ms (с prefetch < 100ms)",
          "[ ] Нет лишних ре-рендеров при скролле (React DevTools Profiler)",
          "[ ] Timeline скроллится плавно (60fps)",
          "[ ] Virtualization работает для больших проектов (>50 разделов)",
          "[ ] Loading states показываются во всех async операциях",
          "[ ] Optimistic updates работают для всех мутаций"
        ],
        "codeQuality": [
          "[ ] Нет `any` в TypeScript (strict mode)",
          "[ ] Все компоненты < 400 строк",
          "[ ] Нет дублирования кода между Row компонентами",
          "[ ] Все utils покрыты JSDoc комментариями",
          "[ ] Naming conventions соблюдены (camelCase, PascalCase)",
          "[ ] Нет console.log в production коде",
          "[ ] Все TODO помечены и задокументированы"
        ],
        "cache": [
          "[ ] Query keys структурированы правильно (queryKeys.resourceGraph.*)",
          "[ ] staleTime/gcTime адекватны для типа данных",
          "[ ] Cache invalidation работает при мутациях",
          "[ ] Realtime подписки чистятся при unmount",
          "[ ] Нет stale data после обновлений",
          "[ ] Prefetch работает при hover на expand buttons"
        ]
      },
      "auditProcedure": [
        "1. Запустить npm run build — должен пройти без ошибок",
        "2. Открыть /dashboard/tasks, вкладка 'График'",
        "3. Открыть DevTools → Network, проверить количество запросов",
        "4. Открыть DevTools → Performance, записать загрузку страницы",
        "5. Раскрыть несколько объектов, проверить время загрузки",
        "6. Проверить Console на ошибки и warnings",
        "7. Протестировать все interactive элементы (drag, resize, click)",
        "8. Проверить с разными ролями пользователей"
      ]
    },
    {
      "id": "RG-042",
      "title": "[Refactor] Рефакторинг модалок и исправление hardcoded цветов",
      "description": "P2 задачи из аудита коммитов:\n\n1. **Разбить SectionModal** (~689 строк) на подкомпоненты:\n   - SectionModalHeader\n   - SectionModalTabs\n   - SectionModalDates\n   - SectionModalContent\n\n2. **Разбить StageModal** (~679 строк) на подкомпоненты:\n   - StageModalHeader\n   - StageModalDates\n   - StageModalLoadings\n   - StageModalContent\n\n3. **Исправить hardcoded цвета:**\n   - `bg-slate-900` → `bg-card` в Create/Delete модалках\n   - `bg-teal-500` → `bg-amber-500` в SectionCreateModal (соответствие дизайн-системе)",
      "category": "refactor",
      "priority": "low",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-02-04",
      "updatedAt": "2026-02-04",
      "blockedBy": [],
      "blocks": [],
      "affectedFiles": [
        "modules/modals/components/section/SectionModal.tsx",
        "modules/modals/components/stage/StageModal.tsx",
        "modules/modals/components/section/SectionCreateModal.tsx",
        "modules/modals/components/object/DeleteObjectModal.tsx",
        "modules/modals/components/section/DeleteSectionModal.tsx"
      ],
      "estimatedHours": 4,
      "acceptanceCriteria": [
        "SectionModal разбит на 4+ подкомпонента, основной файл < 200 строк",
        "StageModal разбит на 4+ подкомпонента, основной файл < 200 строк",
        "Нет hardcoded bg-slate-900, используется bg-card",
        "Нет bg-teal-500, используется bg-amber-500",
        "npm run build проходит без ошибок"
      ]
    }
  ],

  "changelog": [
    {
      "version": "2.0.16",
      "date": "2026-01-30",
      "changes": [
        "[RG-041] Исправлена ошибка 'nodes.filter is not a function' в модуле budgets-page при удалении этапа",
        "Баг возник после добавления пагинации - inline CRUD компоненты budgets-page использовали старую структуру кеша",
        "Обновлены 7 файлов: optimistic-updates.ts, StageInlineDelete, StageInlineCreate, ItemInlineDelete, ItemInlineCreate, ItemHoursEdit, SectionRateEdit",
        "Добавлен тип CachedResourceGraphData для работы с пагинированной структурой { success, data, pagination }",
        "Теперь создание/удаление/редактирование этапов и задач в разделе 'Бюджеты' работает корректно"
      ]
    },
    {
      "version": "2.0.15",
      "date": "2026-01-30",
      "changes": [
        "[RG-040] Исправлена ошибка 'oldData.map is not a function' при удалении и создании разделов/объектов",
        "Баг возник после добавления пагинации - структура кеша resourceGraph изменилась, но модалки не были обновлены",
        "Обновлены все модалки для работы с новой структурой кеша: DeleteSectionModal, DeleteObjectModal, SectionCreateModal, ObjectCreateModal",
        "Добавлен тип CachedResourceGraphData во все модалки для типобезопасной работы с кешем",
        "Теперь удаление и создание разделов/объектов работает корректно"
      ]
    },
    {
      "version": "2.0.14",
      "date": "2026-01-30",
      "changes": [
        "[RG-039] Исправлена критическая ошибка 'projects is not iterable' при открытии вкладки задачи в модалке раздела",
        "Баг возник после добавления пагинации - структура кеша изменилась с Project[] на { success: true, data: Project[], pagination: {...} }",
        "Обновлена функция findSectionInCache в modules/modals/hooks/useDecompositionData.ts для работы с новой структурой кеша",
        "Добавлен тип CachedResourceGraphData для типизации кешированных данных resourceGraph",
        "Теперь вкладка 'Задачи' в модалке раздела корректно работает с пагинированными данными"
      ]
    },
    {
      "version": "2.0.13",
      "date": "2026-01-29",
      "changes": [
        "[RG-037] Исправлен hard update при изменении дат раздела в модалке SectionPanel",
        "Разделена логика изменения и сохранения дат: handleDatesChange (локальное состояние) vs handleDatesSave (DB update)",
        "Добавлены кнопки 'Сохранить' и 'Отмена' для явного подтверждения изменений дат",
        "Теперь переход между месяцами в календаре НЕ триггерит обновление в БД",
        "Сохранение происходит ТОЛЬКО при нажатии кнопки 'Сохранить'"
      ]
    },
    {
      "version": "2.0.12",
      "date": "2026-01-29",
      "changes": [
        "[RG-036] Добавлена пагинация для проектов в графике (по 10 проектов на страницу)",
        "Модифицирован action getResourceGraphData для поддержки server-side pagination",
        "Обновлен хук useResourceGraphData - теперь возвращает pagination info (page, pageSize, total, totalPages)",
        "Добавлено состояние пагинации в FiltersStore (currentPage, pageSize, setCurrentPage, setPageSize, resetPagination)",
        "Добавлены UI контролы пагинации в ResourceGraph и ResourceGraphInternal компоненты (кнопки Назад/Вперед + info)",
        "Состояние текущей страницы сохраняется в localStorage через persist middleware"
      ]
    },
    {
      "version": "2.0.11",
      "date": "2026-01-29",
      "changes": [
        "[RG-031] Удалена функциональность expand/collapse controls (\"Развернуть все\", \"До разделов\", \"Свернуть все\")",
        "Удалены обработчики handleExpandAll, handleExpandToSections, handleCollapseAll из ResourceGraph.tsx",
        "Удалены методы expandAll, expandToSections, collapseAll из stores/index.ts",
        "Удалены UI кнопки и импорты иконок ChevronsUpDown, ChevronsDownUp, ChevronDown",
        "Оставлено индивидуальное раскрытие узлов по клику на chevron"
      ]
    },
    {
      "version": "2.0.10",
      "date": "2026-01-29",
      "changes": [
        "[Tasks] Удалены задачи RG-031 и RG-032 (баги с expand/collapse)",
        "[Tasks] Создана новая задача RG-031: удалить функциональность expand/collapse controls полностью",
        "Решение: вместо исправления багов с производительностью — удалить редко используемую функцию"
      ]
    },
    {
      "version": "2.0.9",
      "date": "2026-01-29",
      "changes": [
        "[Bug Fix] Исправлено отсутствие обновления timeline при создании/обновлении/удалении загрузок",
        "Добавлена инвалидация кэша sectionsBatch в useCreateLoading для мгновенного отображения новой загрузки",
        "Добавлена инвалидация кэша sectionsBatch в useUpdateLoading для синхронизации timeline",
        "Добавлена инвалидация кэша sectionsBatch в useDeleteLoading для мгновенного удаления с timeline",
        "[Tasks] Добавлены задачи RG-036 (пагинация проектов), RG-037 (фикс дат раздела), RG-038 (рефакторинг бюджетов)"
      ]
    },
    {
      "version": "2.0.8",
      "date": "2026-01-29",
      "changes": [
        "[RG-034] Исправлен timezone off-by-one баг отображения дат чекпоинтов на timeline",
        "Заменен parseISO на parseMinskDate для корректного парсинга checkpoint_date в часовом поясе Минска",
        "Исправлено форматирование дат чекпоинтов: format + parseISO → formatMinsk + parseMinskDate"
      ]
    },
    {
      "version": "2.0.7",
      "date": "2026-01-28",
      "changes": [
        "[RG-033] Исправлен rollback дат при drag-resize загрузок на timeline",
        "Добавлена инвалидация кэша sectionsBatch в useUpdateLoadingDates для предотвращения отката дат"
      ]
    },
    {
      "version": "2.0.6",
      "date": "2026-01-06",
      "changes": [
        "[RG-021] Исправлено просвечивание элементов timeline через sticky sidebar (z-index: z-20 → z-40)",
        "[RG-022] Исправлено просвечивание элементов между строками (добавлен overflow-hidden + isolate)",
        "[RG-024] Исправлена верстка модалки этапа — даты теперь не вылезают за экран"
      ]
    },
    {
      "version": "2.0.5",
      "date": "2026-01-06",
      "changes": [
        "[RG-019] Упрощена кнопка 'Разместить' — авто-размещение от сегодня на 10 дней без popover",
        "[RG-020] Убран инлайн выбор ответственного — теперь открывается модалка раздела",
        "Оптимистичный рендер: рамка раздела появляется мгновенно при размещении",
        "Авто-создание плана: при размещении создаются контрольные точки 0% и 100%"
      ]
    },
    {
      "version": "2.0.4",
      "date": "2026-01-05",
      "changes": [
        "[RG-015] Инлайн назначение ответственного за раздел",
        "[RG-016] Инлайн внесение сроков в раздел (кнопка Разместить с popover)",
        "[RG-017] Выравнивание параметров раздела в сайдбаре по CSS Grid",
        "[RG-018] Оптимизация загрузки данных разделов (prefetch + skeleton)",
        "[RG-012] Компактная модалка раздела в Resource Graph стиле (amber акценты)",
        "[RG-009] Кнопка развернуть всё до разделов",
        "[RG-011] Унификация кнопок развернуть/свернуть (button group с разделителями)"
      ]
    },
    {
      "version": "2.0.3",
      "date": "2025-01-05",
      "changes": [
        "[RG-014] Добавлено отображение бюджета задачи в TaskSidebar и DecompositionItemRow"
      ]
    },
    {
      "version": "2.0.2",
      "date": "2025-01-05",
      "changes": [
        "[RG-005] Добавлен индикатор прироста прогресса в строках задач (item_progress_history + UI бейдж)"
      ]
    },
    {
      "version": "2.0.1",
      "date": "2025-01-05",
      "changes": [
        "[RG-001] Исправлен рендеринг вертикальных связей чекпоинтов при expand/collapse строк"
      ]
    },
    {
      "version": "2.0.0",
      "date": "2025-01-01",
      "changes": [
        "Полный рефакторинг на Server Actions",
        "Интеграция с cache module",
        "Batch загрузка данных секций",
        "Realtime синхронизация через Supabase"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2024-10-01",
      "changes": [
        "Initial release",
        "Timeline визуализация",
        "Иерархия Project → Object → Section",
        "Загрузки сотрудников"
      ]
    }
  ]
}
