import { QueryClient, isServer } from '@tanstack/react-query'

/**
 * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è staleTime –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
 */
export const staleTimePresets = {
  /** –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∫–æ—Ç–æ—Ä—ã–µ –ù–ò–ö–û–ì–î–ê –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –≤ —Ä–∞–º–∫–∞—Ö —Å–µ—Å—Å–∏–∏ (—Å—Ç–∞—Ç—É—Å—ã, –æ—Ç–¥–µ–ª—ã, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) */
  infinity: Infinity,

  /** –ü—Ä–∞–∑–¥–Ω–∏–∫–∏, –≥–æ–¥–æ–≤—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ - –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è */
  eternal: 24 * 60 * 60 * 1000, // 24 —á–∞—Å–∞

  /** –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ - —Ä–µ–¥–∫–æ –º–µ–Ω—è—é—Ç—Å—è */
  static: 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç

  /** –ü—Ä–æ—Ñ–∏–ª–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */
  slow: 5 * 60 * 1000, // 5 –º–∏–Ω—É—Ç

  /** –ü—Ä–æ–µ–∫—Ç—ã, –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ */
  medium: 3 * 60 * 1000, // 3 –º–∏–Ω—É—Ç—ã

  /** –†–∞–∑–¥–µ–ª—ã, —á–∞—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ */
  fast: 2 * 60 * 1000, // 2 –º–∏–Ω—É—Ç—ã

  /** –ó–∞–≥—Ä—É–∑–∫–∏, –∞–∫—Ç–∏–≤–Ω–æ –º–µ–Ω—è—é—â–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ */
  realtime: 1 * 60 * 1000, // 1 –º–∏–Ω—É—Ç–∞

  /** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ */
  none: 0,
} as const

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ QueryClient —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
 */
function makeQueryClient(): QueryClient {
  return new QueryClient({
    defaultOptions: {
      queries: {
        // –î–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞—é—Ç—Å—è —Å–≤–µ–∂–∏–º–∏ 3 –º–∏–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        staleTime: staleTimePresets.medium,

        // –í—Ä–µ–º—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∫–µ—à–µ - 30 –º–∏–Ω—É—Ç
        gcTime: 30 * 60 * 1000,

        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        retry: (failureCount, error) => {
          // –ù–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –¥–ª—è 4xx –æ—à–∏–±–æ–∫ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –æ—à–∏–±–∫–∏)
          if (error instanceof Error && error.message.includes('4')) {
            return false
          }
          return failureCount < 3
        },

        // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
        retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),

        // –û–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        refetchOnWindowFocus: true,

        // –ù–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        refetchOnReconnect: 'always',
      },
      mutations: {
        // –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –º—É—Ç–∞—Ü–∏–π
        retry: 1,
        retryDelay: 1000,
      },
    },
  })
}

// Singleton –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
let browserQueryClient: QueryClient | undefined = undefined

/**
 * –ü–æ–ª—É—á–∏—Ç—å QueryClient
 *
 * - –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: –≤—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
 * - –í –±—Ä–∞—É–∑–µ—Ä–µ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç singleton
 */
export function getQueryClient(): QueryClient {
  if (isServer) {
    // –°–µ—Ä–≤–µ—Ä: –≤—Å–µ–≥–¥–∞ –Ω–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    return makeQueryClient()
  }

  // –ë—Ä–∞—É–∑–µ—Ä: singleton –ø–∞—Ç—Ç–µ—Ä–Ω
  if (!browserQueryClient) {
    browserQueryClient = makeQueryClient()
  }

  return browserQueryClient
}

/**
 * –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ QueryClient (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ logout)
 * - –û—Ç–º–µ–Ω—è–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
 * - –û—á–∏—â–∞–µ—Ç –≤–µ—Å—å –∫—ç—à
 * - –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º getQueryClient()
 */
export function resetQueryClient(): void {
  if (browserQueryClient) {
    // –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    browserQueryClient.cancelQueries()
    // –û—á–∏—â–∞–µ–º –≤–µ—Å—å –∫—ç—à
    browserQueryClient.clear()
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º singleton –¥–ª—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
    browserQueryClient = undefined
    console.log("üóëÔ∏è QueryClient —Å–±—Ä–æ—à–µ–Ω")
  }
}

/**
 * –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (soft reset)
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
 */
export function invalidateAllQueries(): void {
  if (browserQueryClient) {
    browserQueryClient.invalidateQueries()
    console.log("üîÑ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω—ã")
  }
}
