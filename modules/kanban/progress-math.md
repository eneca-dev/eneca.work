Это классическая задача управления проектами. Здесь есть **два пути**, но правильным (с точки зрения бизнеса и здравого смысла) является только один — **Взвешенный прогресс**.

Если считать просто "среднее арифметическое" процентов (например, одна задача сделана на 100%, другая на 0%, значит итог 50%) — это будет ложь, если первая задача была на 1 час, а вторая на 100 часов.

Поэтому мы привязываемся к **Плановым часам (Plan)** как к "весу" задачи.

Вот математика для твоей иерархии:

---

### 1. Считаем Этап (Агрегация Задач)

У тебя есть задачи $Z_1, Z_2, ... Z_n$.
У каждой есть:
*   $Plan$ (плановые часы)
*   $Fact$ (фактические часы)
*   $Prog$ (прогресс в %, от 0 до 100)

#### А. План и Факт Этапа
Тут все просто — это прямая сумма.
$$Plan_{Stage} = \sum Plan_{Tasks}$$
$$Fact_{Stage} = \sum Fact_{Tasks}$$

#### Б. Прогресс Этапа (%)
Формула: **(Сумма выполненного объема в часах) / (Общий плановый объем)**

1.  Вычисляем "Заработанные часы" (Earned Value) для каждой задачи:
    $$EV_{Task} = Plan_{Task} \times \frac{Prog_{Task}}{100}$$
    *(Пример: Задача на 10 часов сделана на 50%. EV = 5 часов).*

2.  Складываем их и делим на общий план этапа:
    $$Prog_{Stage} = \frac{\sum EV_{Tasks}}{Plan_{Stage}} \times 100$$

**Пример:**
*   Задача А (10 часов, готова на 100%) -> Сделано 10 ч.
*   Задача Б (90 часов, готова на 0%) -> Сделано 0 ч.
*   **Итог:** Сделано 10 из 100 часов. Прогресс этапа = **10%** (а не 50%, как было бы при среднем арифметическом).

---

### 2. Считаем Раздел (Агрегация Этапов)

Логика абсолютно та же самая. Раздел — это просто контейнер для Этапов.

#### А. План и Факт Раздела
$$Plan_{Section} = \sum Plan_{Stages}$$
$$Fact_{Section} = \sum Fact_{Stages}$$

#### Б. Прогресс Раздела (%)
Ты можешь считать его двумя способами, результат будет одинаковый:

**Способ 1 (через Этапы):**
Берешь уже посчитанные "Заработанные часы" (EV) этапов.
$$Prog_{Section} = \frac{\sum (Plan_{Stage} \times \frac{Prog_{Stage}}{100})}{\sum Plan_{Stages}} \times 100$$

**Способ 2 (Сквозной - проще для кода):**
Просто игнорируешь Этапы и суммируешь EV вообще всех задач, входящих в этот Раздел, и делишь на сумму планов всех задач Раздела.
$$Prog_{Section} = \frac{\text{Сумма EV всех задач внутри раздела}}{\text{Сумма Планов всех задач внутри раздела}} \times 100$$

---

### 3. Нюанс: Что делать с "Фактом"? (Эффективность)

Ты заметил, что в формуле прогресса `%` участвует только **План**? Это правильно. Прогресс показывает, *сколько полезной работы мы закрыли*, а не сколько времени мы на это убили.

Однако, у тебя есть **Факт**. Его нужно использовать для расчета **Эффективности** (или отклонения), чтобы подсвечивать прогресс-бар цветом.

**Коэффициент эффективности (CPI):**
$$CPI = \frac{\text{Заработанные часы (EV)}}{\text{Фактические часы (Fact)}}$$

*   Если мы закрыли задачу на 10 часов (по плану), но потратили на неё 20 часов (факт), наш прогресс всё равно 100% (задача-то готова!), но эффективность 0.5 (мы работаем в 2 раза медленнее).

**Как это отобразить в UI:**
*   Показывай прогресс по формуле из п.1 (сколько сделано).
*   Но если `Fact > Plan` (или точнее `Fact > EV`), крась прогресс-бар или иконку часов в **Красный/Оранжевый**. Это сигнал: "Мы движемся вперед, но сжигаем бюджет быстрее, чем планировали".

