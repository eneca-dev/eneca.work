{
  "$schema": "../../schemas/module-meta/module.schema.json",

  "meta": {
    "name": "kanban",
    "displayName": "Kanban Board",
    "description": "Канбан-доска для управления разделами проектов по статусам",
    "version": "1.0.0",
    "status": "stable",
    "route": "/dashboard/tasks (вкладка Канбан)",
    "tags": ["feature", "ui"]
  },

  "architecture": {
    "structure": {
      "actions/": "Server Actions для работы с данными канбана",
      "components/": "React компоненты канбан-доски",
      "constants/": "Колонки канбана и статусы",
      "filters/": "Хуки для фильтрации",
      "hooks/": "React Query хуки",
      "schemas/": "Zod схемы валидации",
      "stores/": "Zustand stores (UI state, filters)",
      "types/": "TypeScript типы",
      "utils/": "Утилиты"
    },
    "entryPoint": "index.ts",
    "publicApi": [
      "KanbanBoard",
      "useKanbanStore",
      "useKanbanFiltersStore",
      "useKanbanSections",
      "KANBAN_FILTER_CONFIG",
      "KANBAN_COLUMNS"
    ]
  },

  "hooks": [
    {
      "name": "useKanbanSections",
      "description": "Получение разделов для канбан-доски с фильтрацией",
      "file": "hooks/index.ts",
      "returns": "{ data: KanbanSection[], isLoading }"
    },
    {
      "name": "useKanbanFilterOptions",
      "description": "Опции для автокомплита фильтров",
      "file": "filters/useFilterOptions.ts"
    }
  ],

  "actions": [],

  "stores": [
    {
      "name": "useKanbanStore",
      "description": "UI состояние канбан-доски",
      "file": "stores/index.ts",
      "persistence": null,
      "state": ["viewSettings"],
      "actions": ["setViewSettings"]
    },
    {
      "name": "useKanbanFiltersStore",
      "description": "Состояние фильтров канбана",
      "file": "stores/index.ts",
      "persistence": "kanban-filters",
      "state": ["filterString"],
      "actions": ["setFilterString", "clearFilters"]
    }
  ],

  "components": [
    {
      "name": "KanbanBoard",
      "description": "Главный компонент канбан-доски",
      "file": "components/KanbanBoard.tsx",
      "props": ["filterString?", "queryParams?"]
    }
  ],

  "patterns": [
    {
      "name": "Column Status Mapping",
      "description": "Статусы разделов маппятся на колонки через KANBAN_COLUMNS",
      "example": "const column = getColumnById(section.status)"
    }
  ],

  "antipatterns": [],

  "technologies": ["@tanstack/react-query", "zustand", "@dnd-kit/core", "tailwindcss"],

  "dependencies": {
    "modules": ["cache", "inline-filter", "modals"],
    "database": {
      "tables": ["sections", "decomposition_stages"],
      "views": ["v_kanban_sections"],
      "enums": ["section_status_enum"],
      "functions": []
    }
  },

  "dependents": ["tasks"],

  "cache": {
    "queryKeys": ["kanban.sections"],
    "realtimeChannels": ["sections"],
    "invalidationRules": []
  },

  "permissions": ["kanban.view", "kanban.move_sections"],

  "tasks": [
    {
      "id": "KB-001",
      "title": "Исправлена ошибка при создании этапа в канбане",
      "description": "При создании этапа через модалку StageCreateModal показывалась ошибка \"Неизвестная ошибка при создании этапа\", хотя этап создавался в БД успешно.\n\nПричина: createCacheMutation (TanStack Query) возвращает из mutateAsync только data, а не весь ActionResult { success, data, error }. Модалка проверяла stageResult.success и stageResult.data, которых не было.\n\nРешение: Изменили проверку с if (!stageResult.success || !stageResult.data) на if (!stageResult || !stageResult.id), проверяя наличие id напрямую.",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-16",
      "updatedAt": "2026-01-16",
      "completedAt": "2026-01-16",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 1
    },
    {
      "id": "KB-002",
      "title": "Добавить открытие модалки этапа при клике на название в канбане",
      "description": "При клике на название этапа на карточке канбана должна открываться полноценная модалка редактирования этапа StageModal.\n\nТекущее состояние: Клик на название ничего не делает.\n\nТребуется:\n1. Импортировать StageModal из @/modules/modals\n2. Создать адаптер convertKanbanStageToDecompositionStage для преобразования типов\n3. Добавить состояние isStageModalOpen\n4. Сделать заголовок этапа кликабельным (добавить onClick)\n5. Рендерить StageModal с корректными props\n6. Инвалидировать кеш канбана после успешного сохранения",
      "category": "feature",
      "priority": "medium",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 2,
      "relatedFiles": [
        "components/KanbanCard.tsx"
      ]
    },
    {
      "id": "KB-003",
      "title": "Улучшить анимации открытия swimlane (свимлейна)",
      "description": "Анимация открытия swimlane (раздела) работает некорректно - слишком резкая или прерывистая.\n\nТекущее состояние:\n- Анимация закрытия работает нормально\n- Анимация открытия плохая\n\nТребуется:\n- Пересмотреть transition для открытия swimlane\n- Сделать плавную анимацию с подходящим easing\n- Проверить, что нет скачков высоты контента",
      "category": "ui",
      "priority": "low",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 1,
      "relatedFiles": [
        "components/KanbanSwimlane.tsx"
      ]
    },
    {
      "id": "KB-004",
      "title": "Добавить модалку подтверждения при удалении этапа",
      "description": "При удалении этапа через контекстное меню нет модалки подтверждения - этап удаляется сразу.\n\nТекущее состояние: Удаление без подтверждения (опасно).\n\nТребуется:\n- Добавить DeleteConfirmDialog перед удалением этапа\n- Показать название этапа и количество задач в нём\n- Предупредить, что удаление необратимо",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 1,
      "relatedFiles": [
        "modules/modals/components/section/decomposition/StagesManager.tsx"
      ]
    },
    {
      "id": "KB-005",
      "title": "Исправить некорректный tooltip на аватаре ответственного этапа",
      "description": "При наведении на иконку ответственного за этап показывается некорректный текст:\n- Если нет заданий - показывается название этапа\n- Если есть задания - показывается категория задания\n\nОжидается: Показывать имя ответственного (firstName lastName).\n\nПричина: Скорее всего, неправильно настроен TooltipContent или неверный data binding в компоненте аватаров.",
      "category": "bug",
      "priority": "medium",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 0.5,
      "relatedFiles": [
        "components/KanbanCard.tsx"
      ]
    },
    {
      "id": "KB-006",
      "title": "Добавить tooltip при наведении на аватар ответственного за раздел",
      "description": "При наведении на аватар ответственного за раздел (в swimlane header) не показывается tooltip с именем.\n\nТекущее состояние: Нет tooltip.\n\nТребуется:\n- Обернуть аватар ответственного раздела в Tooltip\n- Показывать полное имя (firstName lastName) и должность",
      "category": "feature",
      "priority": "low",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 0.5,
      "relatedFiles": [
        "components/KanbanSwimlane.tsx"
      ]
    },
    {
      "id": "KB-007",
      "title": "Пересмотреть коэффициенты CPI на задаче и этапе (опционально)",
      "description": "Проверить корректность расчёта и отображения CPI (Cost Performance Index) на задачах и этапах в канбане.\n\nТребуется:\n- Проверить формулу расчёта CPI\n- Убедиться, что цветовые индикаторы соответствуют значениям\n- Проверить граничные случаи (CPI = 0, CPI очень большой)\n- Возможно, изменить пороговые значения для статусов (эффективно/приемлемо/критично)",
      "category": "enhancement",
      "priority": "low",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 2,
      "relatedFiles": [
        "components/KanbanCard.tsx"
      ]
    },
    {
      "id": "KB-008",
      "title": "Исправить обновление канбана после применения шаблона декомпозиции в модалке раздела",
      "description": "Если в модалке раздела (SectionModal, вкладка Задачи) применить шаблон декомпозиции, новые этапы и задачи не отображаются на канбан-доске до перезагрузки страницы.\n\nПричина: Отсутствует инвалидация кеша канбана после применения шаблона.\n\nТребуется:\n- Найти место в модуле modals, где применяется шаблон\n- Добавить инвалидацию queryKeys.kanban.list() после успешного применения\n- Убедиться, что новые этапы сразу появляются на канбане",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-18",
      "completedAt": "2026-01-20",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 1,
      "relatedFiles": [
        "modules/dec-templates/hooks/use-templates.ts"
      ]
    },
    {
      "id": "KB-009",
      "title": "Исправить автозакрытие и баги модалки раздела при изменении полей",
      "description": "При изменении любого поля в модалке раздела (SectionModal) происходит автоматическое закрытие модалки (из-за обновления данных).\n\nТакже:\n- Нельзя обновить статус раздела через dropdown\n- Нельзя изменить даты раздела (startDate, endDate)\n\nПричины:\n1. saveField вызывал onSuccess() после каждого сохранения поля\n2. KanbanSection не содержал statusId, startDate, endDate - модалка инициализировалась с null\n\nИсправлено:\n- Убран вызов onSuccess из saveField (модалка не закрывается)\n- Добавлена инвалидация kanban в useUpdateSection\n- Добавлены поля statusId, startDate, endDate в тип KanbanSection\n- Добавлен маппинг этих полей из v_resource_graph\n- Обновлён getSectionForModal() для передачи реальных значений в модалку",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-18",
      "updatedAt": "2026-01-20",
      "completedAt": "2026-01-20",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 2,
      "relatedFiles": [
        "modules/modals/components/section/SectionModal.tsx",
        "modules/modals/hooks/useUpdateSection.ts",
        "modules/kanban/types/index.ts",
        "modules/kanban/utils/transform-rows-to-kanban.ts",
        "modules/kanban/components/KanbanSwimlane.tsx"
      ]
    },
    {
      "id": "KB-010",
      "title": "Не подтягивается статус этапа в StageModal из канбана",
      "description": "При нажатии на название этапа в канбане открывается StageModal, но в ней не отображается актуальный статус этапа.\n\nПричина: KanbanStage не содержит statusId - функция convertToDecompositionStage() передаёт null вместо реального ID статуса.\n\nИсправлено:\n- Добавлено поле statusId в тип KanbanStage\n- Добавлен маппинг statusId из v_resource_graph в transformRowsToKanbanSections\n- Обновлён convertToDecompositionStage() для передачи реального ID статуса",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-20",
      "updatedAt": "2026-01-20",
      "completedAt": "2026-01-20",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 1,
      "relatedFiles": [
        "modules/kanban/types/index.ts",
        "modules/kanban/utils/transform-rows-to-kanban.ts",
        "modules/kanban/components/KanbanCard.tsx"
      ]
    },
    {
      "id": "KB-011",
      "title": "StageModal закрывается при изменении полей в канбане",
      "description": "При изменении любого поля в модалке этапа (StageModal) из канбана происходит автоматическое закрытие модалки.\n\nПричина: saveField() вызывал onSuccess() после каждого сохранения поля.\n\nИсправлено: Убран вызов onSuccess из saveField (модалка не закрывается). Кэш инвалидируется через useUpdateDecompositionStage.",
      "category": "bug",
      "priority": "medium",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-20",
      "updatedAt": "2026-01-20",
      "completedAt": "2026-01-20",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 0.5,
      "relatedFiles": [
        "modules/modals/components/stage/StageModal.tsx"
      ]
    },
    {
      "id": "KB-012",
      "title": "Канбан обрезается по ширине - нужен горизонтальный скролл",
      "description": "Канбан-доска не помещается по ширине экрана в следующих случаях:\n- На ноутбуке при открытом боковом меню (колонка 'Готово' обрезается)\n- На планшетах и мобильных устройствах\n\nИсправлено:\n- Заменено overflow-x-hidden на overflow-auto в KanbanBoard\n- Добавлено min-w-fit для контейнера колонок в KanbanSwimlane\n- Теперь канбан скроллится горизонтально когда не помещается",
      "category": "bug",
      "priority": "high",
      "status": "done",
      "assignee": null,
      "createdAt": "2026-01-20",
      "updatedAt": "2026-01-20",
      "completedAt": "2026-01-20",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 2,
      "relatedFiles": [
        "modules/kanban/components/KanbanBoard.tsx",
        "modules/kanban/components/KanbanSwimlane.tsx"
      ]
    },
    {
      "id": "KB-AUDIT",
      "title": "Full Module Audit: Kanban Board",
      "description": "Полный аудит модуля канбан-доски для подтверждения качества.\n\nОсобое внимание на drag-and-drop логику, обновление статусов и производительность при большом количестве карточек.",
      "category": "audit",
      "priority": "medium",
      "status": "todo",
      "assignee": null,
      "createdAt": "2026-01-05",
      "updatedAt": "2026-01-05",
      "blockedBy": [],
      "blocks": [],
      "estimatedHours": 4,
      "checklist": {
        "database": [
          "[ ] v_kanban_sections возвращает все нужные поля",
          "[ ] Индексы на sections(status, project_id)",
          "[ ] section_status_enum содержит все статусы колонок",
          "[ ] UPDATE sections SET status работает корректно"
        ],
        "security": [
          "[ ] updateSectionStatus (если есть) имеет auth check",
          "[ ] RLS policies позволяют изменять только свои разделы",
          "[ ] Permission check: kanban.move_sections"
        ],
        "businessLogic": [
          "[ ] Drag-and-drop перемещает раздел в правильную колонку",
          "[ ] Статус раздела обновляется в БД после drop",
          "[ ] Порядок карточек в колонке сохраняется",
          "[ ] Оптимистичное обновление + rollback при ошибке",
          "[ ] Фильтры применяются корректно (проект, ответственный)",
          "[ ] Edge case: перетаскивание в ту же колонку",
          "[ ] Edge case: пустая колонка (должен работать drop)"
        ],
        "performance": [
          "[ ] Загрузка 100+ карточек < 2 сек",
          "[ ] Drag операция не тормозит UI",
          "[ ] Нет лишних ре-рендеров при drag",
          "[ ] dnd-kit оптимизирован (DragOverlay)"
        ],
        "codeQuality": [
          "[ ] KANBAN_COLUMNS типизированы",
          "[ ] Zustand stores минимальны по scope",
          "[ ] Нет `any` в типах",
          "[ ] KanbanBoard < 300 строк"
        ],
        "cache": [
          "[ ] queryKeys.kanban.sections используется",
          "[ ] Invalidation после перемещения",
          "[ ] Realtime на sections обновляет UI"
        ]
      },
      "auditProcedure": [
        "1. Открыть /dashboard/tasks, вкладка 'Канбан'",
        "2. Перетащить несколько карточек между колонками",
        "3. Обновить страницу — статусы должны сохраниться",
        "4. Проверить фильтрацию (по проекту, по ответственному)",
        "5. Проверить Console на ошибки при drag-and-drop",
        "6. Симулировать сетевую ошибку — проверить rollback"
      ]
    }
  ],

  "changelog": [
    {
      "version": "1.1.0",
      "date": "2026-01-20",
      "changes": [
        "KB-002: Добавлено открытие StageModal при клике на название этапа в канбане",
        "KB-003: Улучшена анимация открытия/закрытия swimlane (CSS Grid вместо max-height)",
        "KB-004: Добавлена модалка подтверждения при удалении этапа (DeleteConfirmDialog)",
        "KB-005: Исправлены аватары на карточках этапа - теперь показываются ответственные за задачи вместо категорий работ",
        "KB-006: Добавлен tooltip с именем ответственного при наведении на аватар раздела",
        "KB-008: Добавлена инвалидация kanban в useApplyTemplate для обновления канбана после применения шаблона",
        "KB-009: Исправлено автозакрытие SectionModal и сброс полей при изменении статуса/дат (убран onSuccess из saveField, добавлены statusId/startDate/endDate в KanbanSection, обновлён маппинг из v_resource_graph)",
        "KB-010: Исправлено отображение статуса этапа в StageModal (добавлен statusId в KanbanStage, обновлён маппинг и convertToDecompositionStage)",
        "KB-011: Исправлено автозакрытие StageModal при изменении полей (убран onSuccess из saveField)",
        "KB-012: Добавлен горизонтальный скролл - канбан теперь не обрезается на узких экранах"
      ]
    },
    {
      "version": "1.0.0",
      "date": "2025-01-01",
      "changes": ["Initial release", "Drag-and-drop между колонками", "Интеграция с InlineFilter"]
    }
  ]
}
